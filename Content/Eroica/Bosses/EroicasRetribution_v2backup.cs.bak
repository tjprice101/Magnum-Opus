using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;
using System;
using System.Collections.Generic;
using Terraria;
using Terraria.GameContent.Bestiary;
using Terraria.GameContent.ItemDropRules;
using Terraria.ID;
using Terraria.ModLoader;
using Terraria.Audio;
using MagnumOpus.Content.Eroica.ResonanceEnergies;
using MagnumOpus.Content.Eroica.Projectiles;
using MagnumOpus.Content.Eroica.ResonantWeapons;
using MagnumOpus.Content.Eroica.Pets;
using MagnumOpus.Common.Systems;
using MagnumOpus.Common.Systems.Particles;
using MagnumOpus.Common.Systems.VFX;

namespace MagnumOpus.Content.Eroica.Bosses
{
    /// <summary>
    /// EROICA, GOD OF VALOR - COMPLETE AGGRESSIVE REBUILD
    /// 
    /// This boss is THREATENING, ENGAGING, and RELENTLESS.
    /// Inspired by Calamity's Devourer of Gods and Providence.
    /// 
    /// CORE DESIGN:
    /// - Phase 1: 3 Flames must die (unchanged)
    /// - Phase 2: AGGRESSIVE combat with constant pressure
    /// 
    /// COMBAT PHILOSOPHY:
    /// - Boss PURSUES player aggressively
    /// - Teleports when player tries to kite
    /// - Fires WAVES of projectiles, not single shots
    /// - Uses mirages for multi-angle pressure  
    /// - Attacks chain rapidly in combos
    /// - Combat feels RHYTHMIC and MUSICAL
    /// </summary>
    public class EroicasRetribution : ModNPC
    {
        public override string Texture => "MagnumOpus/Content/Eroica/Bosses/EroicaGodOfValor";
        
        #region Theme Colors
        private static readonly Color EroicaGold = new Color(255, 200, 80);
        private static readonly Color EroicaScarlet = new Color(200, 50, 50);
        private static readonly Color EroicaCrimson = new Color(180, 30, 60);
        private static readonly Color EroicaWhite = new Color(255, 240, 220);
        #endregion
        
        #region AI State
        private enum BossState
        {
            // Phase 1
            Phase1_FlamesAlive,
            Phase1_Transition,
            
            // Phase 2 - Core states
            Phase2_Pursuit,         // Aggressively chasing player
            Phase2_Attack,          // Executing an attack
            Phase2_Teleport,        // Teleporting to player
            
            // Death
            Dying
        }
        
        private enum AttackType
        {
            // Core Attacks (always available)
            RapidDash,              // 3-5 rapid dashes through player
            OrbBarrage,             // Spread of homing orbs
            SpiralStorm,            // Expanding spiral projectiles
            
            // Phase 2B (60% HP)
            MirageAssault,          // Clone mirages attack from multiple angles
            MeteorRain,             // Projectiles rain from above
            ValorWall,              // Projectile wall sweeps across arena
            
            // Phase 2C (30% HP - Desperate)
            PhoenixDive,            // Teleport behind + dive through
            VortexPull,             // Pull player in while firing
            UltimateCombo,          // Chain multiple attacks rapidly
            
            // Punishment
            DistancePunish          // Triggered when player runs too far
        }
        
        private BossState State
        {
            get => (BossState)NPC.ai[0];
            set => NPC.ai[0] = (float)value;
        }
        
        private int Timer
        {
            get => (int)NPC.ai[1];
            set => NPC.ai[1] = value;
        }
        
        private AttackType CurrentAttack
        {
            get => (AttackType)NPC.ai[2];
            set => NPC.ai[2] = (float)value;
        }
        
        private int AttackSubPhase
        {
            get => (int)NPC.ai[3];
            set => NPC.ai[3] = value;
        }
        #endregion
        
        #region Combat Variables
        private bool phase2Started = false;
        private bool flamesSpawned = false;
        private int phase2Mood = 0; // 0=Triumphant, 1=Fury, 2=Desperate
        
        // Dash tracking
        private int dashCount = 0;
        private Vector2 dashDirection;
        
        // Distance punishment
        private int farAwayTimer = 0;
        private int stationaryTimer = 0;
        private Vector2 lastTargetPos;
        
        // Attack cooldown
        private int attackCooldown = 0;
        private AttackType lastAttack = AttackType.RapidDash;
        
        // Combo tracking
        private int comboCount = 0;
        private int maxCombo = 2;
        
        // Animation
        private int frameCounter = 0;
        private int currentFrame = 0;
        private const int TotalFrames = 36;
        
        // Health bar
        private bool hasRegisteredHealthBar = false;
        
        // Death
        private int deathTimer = 0;
        #endregion

        public override void SetStaticDefaults()
        {
            Main.npcFrameCount[Type] = TotalFrames;
            NPCID.Sets.MPAllowedEnemies[Type] = true;
            NPCID.Sets.BossBestiaryPriority.Add(Type);
            NPCID.Sets.TrailCacheLength[Type] = 12;
            NPCID.Sets.TrailingMode[Type] = 1;
            NPCID.Sets.MustAlwaysDraw[Type] = true;
            
            NPCID.Sets.SpecificDebuffImmunity[Type][BuffID.Poisoned] = true;
            NPCID.Sets.SpecificDebuffImmunity[Type][BuffID.Confused] = true;
            NPCID.Sets.SpecificDebuffImmunity[Type][BuffID.OnFire] = true;
        }

        public override void SetDefaults()
        {
            NPC.width = 100;
            NPC.height = 120;
            NPC.damage = 95;
            NPC.defense = 80;
            NPC.lifeMax = 406306;
            NPC.HitSound = SoundID.NPCHit1;
            NPC.DeathSound = SoundID.NPCDeath14;
            NPC.knockBackResist = 0f;
            NPC.noGravity = true;
            NPC.noTileCollide = true;
            NPC.value = Item.buyPrice(gold: 20);
            NPC.boss = true;
            NPC.npcSlots = 15f;
            NPC.aiStyle = -1;
            NPC.scale = 0.65f;
            NPC.dontTakeDamage = true;
            
            if (!Main.dedServ)
                Music = MusicLoader.GetMusicSlot(Mod, "Assets/Music/CrownOfEroica");
        }

        public override void SetBestiary(BestiaryDatabase database, BestiaryEntry bestiaryEntry)
        {
            bestiaryEntry.Info.AddRange(new IBestiaryInfoElement[]
            {
                BestiaryDatabaseNPCsPopulator.CommonTags.SpawnConditions.Times.NightTime,
                new FlavorTextBestiaryInfoElement("Eroica, God of Valor - a triumphant deity of heroic sacrifice.")
            });
        }

        public override void AI()
        {
            // Health bar registration
            if (!hasRegisteredHealthBar)
            {
                BossHealthBarUI.RegisterBoss(NPC, BossColorTheme.Eroica);
                hasRegisteredHealthBar = true;
            }
            
            // Death animation
            if (State == BossState.Dying)
            {
                UpdateDeathAnimation();
                return;
            }
            
            NPC.TargetClosest(true);
            Player target = Main.player[NPC.target];
            
            // Despawn check
            if (!target.active || target.dead)
            {
                NPC.velocity.Y -= 0.5f;
                NPC.EncourageDespawn(60);
                return;
            }
            
            // Spawn flames
            if (!flamesSpawned && Main.netMode != NetmodeID.MultiplayerClient)
            {
                SpawnFlames();
                flamesSpawned = true;
            }
            
            // Check phase transition
            if (!phase2Started)
            {
                if (CountAliveFlames() == 0 && flamesSpawned)
                {
                    State = BossState.Phase1_Transition;
                    Timer = 0;
                    phase2Started = true;
                    NPC.dontTakeDamage = false;
                }
            }
            
            // Update mood based on HP
            UpdateMood();
            
            // Cooldowns
            if (attackCooldown > 0) attackCooldown--;
            
            // State machine
            switch (State)
            {
                case BossState.Phase1_FlamesAlive:
                    AI_Phase1(target);
                    break;
                case BossState.Phase1_Transition:
                    AI_Phase1Transition(target);
                    break;
                case BossState.Phase2_Pursuit:
                    AI_Phase2Pursuit(target);
                    break;
                case BossState.Phase2_Attack:
                    AI_Phase2Attack(target);
                    break;
                case BossState.Phase2_Teleport:
                    AI_Phase2Teleport(target);
                    break;
            }
            
            Timer++;
            UpdateAnimation();
            SpawnAmbientParticles();
            
            // Face target
            NPC.spriteDirection = NPC.direction = (target.Center.X > NPC.Center.X) ? 1 : -1;
            
            // Lighting
            Lighting.AddLight(NPC.Center, EroicaGold.ToVector3() * 0.8f);
        }
        
        #region Phase 1 - Flames
        
        private void SpawnFlames()
        {
            float[] offsets = { 0f, MathHelper.TwoPi / 3f, MathHelper.TwoPi * 2f / 3f };
            for (int i = 0; i < 3; i++)
            {
                int flameIndex = NPC.NewNPC(NPC.GetSource_FromAI(), (int)NPC.Center.X, (int)NPC.Center.Y,
                    ModContent.NPCType<FlamesOfValor>());
                if (flameIndex < Main.maxNPCs && Main.npc[flameIndex].ModNPC is FlamesOfValor flame)
                    flame.SetOrbitOffset(offsets[i]);
            }
            Main.NewText("The Flames of Valor ignite...", EroicaGold);
        }
        
        private int CountAliveFlames()
        {
            int count = 0;
            for (int i = 0; i < Main.maxNPCs; i++)
                if (Main.npc[i].active && Main.npc[i].type == ModContent.NPCType<FlamesOfValor>())
                    count++;
            return count;
        }
        
        private void AI_Phase1(Player target)
        {
            // Simple hover above player during Phase 1
            float waveX = (float)Math.Sin(Timer * 0.03f) * 50f;
            float waveY = (float)Math.Sin(Timer * 0.02f) * 30f;
            Vector2 hoverPos = target.Center + new Vector2(waveX, -280 + waveY);
            
            Vector2 direction = hoverPos - NPC.Center;
            if (direction.Length() > 20f)
            {
                direction.Normalize();
                NPC.velocity = Vector2.Lerp(NPC.velocity, direction * 8f, 0.05f);
            }
            else
            {
                NPC.velocity *= 0.9f;
            }
        }
        
        private void AI_Phase1Transition(Player target)
        {
            NPC.velocity *= 0.9f;
            
            if (Timer == 1)
            {
                MagnumScreenEffects.AddScreenShake(15f);
                SoundEngine.PlaySound(SoundID.Roar, NPC.Center);
                
                // Massive VFX burst
                CustomParticles.GenericFlare(NPC.Center, Color.White, 1.5f, 30);
                for (int i = 0; i < 8; i++)
                {
                    float scale = 0.3f + i * 0.15f;
                    CustomParticles.HaloRing(NPC.Center, Color.Lerp(EroicaScarlet, EroicaGold, i / 8f), scale, 20 + i * 3);
                }
                ThemedParticles.SakuraPetals(NPC.Center, 30, 100f);
            }
            
            if (Timer == 60)
                Main.NewText("All Flames extinguished... Eroica descends!", EroicaCrimson);
            
            if (Timer >= 120)
            {
                Timer = 0;
                State = BossState.Phase2_Pursuit;
                attackCooldown = 30;
            }
        }
        
        #endregion
        
        #region Phase 2 - AGGRESSIVE COMBAT
        
        private void UpdateMood()
        {
            float hp = (float)NPC.life / NPC.lifeMax;
            int newMood = hp > 0.6f ? 0 : (hp > 0.3f ? 1 : 2);
            
            if (newMood != phase2Mood && phase2Started)
            {
                phase2Mood = newMood;
                AnnounceMoodChange();
            }
        }
        
        private void AnnounceMoodChange()
        {
            MagnumScreenEffects.AddScreenShake(phase2Mood == 2 ? 20f : 12f);
            SoundEngine.PlaySound(SoundID.Roar with { Pitch = phase2Mood * 0.15f }, NPC.Center);
            
            // Big VFX
            CustomParticles.GenericFlare(NPC.Center, Color.White, 1.2f, 25);
            for (int i = 0; i < 12; i++)
            {
                float angle = MathHelper.TwoPi * i / 12f;
                CustomParticles.GenericFlare(NPC.Center + angle.ToRotationVector2() * 50f, EroicaGold, 0.5f, 20);
            }
            ThemedParticles.SakuraPetals(NPC.Center, 20 + phase2Mood * 10, 80f);
            
            string text = phase2Mood == 2 ? "DESPERATE VALOR!" : "THE HERO'S FURY!";
            CombatText.NewText(NPC.Hitbox, phase2Mood == 2 ? EroicaGold : EroicaCrimson, text, true);
        }
        
        private void AI_Phase2Pursuit(Player target)
        {
            // === DISTANCE CHECK - TELEPORT IF TOO FAR ===
            float distance = Vector2.Distance(NPC.Center, target.Center);
            if (distance > 800f)
            {
                farAwayTimer++;
                if (farAwayTimer > 60)
                {
                    State = BossState.Phase2_Teleport;
                    Timer = 0;
                    farAwayTimer = 0;
                    return;
                }
            }
            else
            {
                farAwayTimer = Math.Max(0, farAwayTimer - 2);
            }
            
            // === AGGRESSIVE PURSUIT ===
            float pursuitSpeed = 12f + phase2Mood * 4f; // Gets faster at lower HP
            float accel = 0.08f + phase2Mood * 0.03f;
            
            Vector2 toTarget = (target.Center - NPC.Center).SafeNormalize(Vector2.Zero);
            Vector2 targetVel = toTarget * pursuitSpeed;
            NPC.velocity = Vector2.Lerp(NPC.velocity, targetVel, accel);
            
            // === ATTACK SELECTION ===
            int attackDelay = 80 - phase2Mood * 20; // Attacks faster at lower HP
            
            if (attackCooldown <= 0 && Timer > attackDelay)
            {
                SelectAttack(target);
            }
            
            // === PROXIMITY BARRAGE ===
            // Fire projectiles when close to player
            if (distance < 350f && Timer % (25 - phase2Mood * 5) == 0 && Main.netMode != NetmodeID.MultiplayerClient)
            {
                Vector2 toPlayer = (target.Center - NPC.Center).SafeNormalize(Vector2.Zero);
                for (int i = -1; i <= 1; i++)
                {
                    Vector2 vel = toPlayer.RotatedBy(i * 0.2f) * 10f;
                    BossProjectileHelper.SpawnHostileOrb(NPC.Center, vel, 75, EroicaScarlet, 0.02f);
                }
                CustomParticles.GenericFlare(NPC.Center, EroicaGold, 0.5f, 12);
            }
        }
        
        private void SelectAttack(Player target)
        {
            Timer = 0;
            State = BossState.Phase2_Attack;
            AttackSubPhase = 0;
            
            // Build attack pool based on mood
            List<AttackType> pool = new List<AttackType>
            {
                AttackType.RapidDash,
                AttackType.OrbBarrage,
                AttackType.SpiralStorm
            };
            
            if (phase2Mood >= 1) // Fury
            {
                pool.Add(AttackType.MirageAssault);
                pool.Add(AttackType.MeteorRain);
                pool.Add(AttackType.ValorWall);
            }
            
            if (phase2Mood >= 2) // Desperate
            {
                pool.Add(AttackType.PhoenixDive);
                pool.Add(AttackType.VortexPull);
                if (comboCount == 0 && Main.rand.NextBool(4))
                {
                    pool.Add(AttackType.UltimateCombo);
                }
            }
            
            // Remove last attack to prevent repeats
            pool.Remove(lastAttack);
            
            CurrentAttack = pool[Main.rand.Next(pool.Count)];
            lastAttack = CurrentAttack;
            
            // Set up attack-specific variables
            switch (CurrentAttack)
            {
                case AttackType.RapidDash:
                    dashCount = 0;
                    break;
                case AttackType.UltimateCombo:
                    comboCount = 3 + phase2Mood;
                    break;
            }
        }
        
        private void AI_Phase2Attack(Player target)
        {
            switch (CurrentAttack)
            {
                case AttackType.RapidDash:
                    Attack_RapidDash(target);
                    break;
                case AttackType.OrbBarrage:
                    Attack_OrbBarrage(target);
                    break;
                case AttackType.SpiralStorm:
                    Attack_SpiralStorm(target);
                    break;
                case AttackType.MirageAssault:
                    Attack_MirageAssault(target);
                    break;
                case AttackType.MeteorRain:
                    Attack_MeteorRain(target);
                    break;
                case AttackType.ValorWall:
                    Attack_ValorWall(target);
                    break;
                case AttackType.PhoenixDive:
                    Attack_PhoenixDive(target);
                    break;
                case AttackType.VortexPull:
                    Attack_VortexPull(target);
                    break;
            }
        }
        
        private void AI_Phase2Teleport(Player target)
        {
            if (Timer == 0)
            {
                // Departure VFX
                CustomParticles.GenericFlare(NPC.Center, Color.White, 0.8f, 15);
                for (int i = 0; i < 6; i++)
                    CustomParticles.HaloRing(NPC.Center, EroicaGold * (1f - i * 0.1f), 0.3f + i * 0.1f, 12 + i * 2);
                ThemedParticles.SakuraPetals(NPC.Center, 12, 50f);
                SoundEngine.PlaySound(SoundID.Item8 with { Pitch = -0.3f }, NPC.Center);
                
                NPC.alpha = 255;
            }
            
            if (Timer == 15)
            {
                // Teleport to aggressive position
                float angle = Main.rand.NextFloat(MathHelper.TwoPi);
                Vector2 teleportPos = target.Center + angle.ToRotationVector2() * 200f;
                NPC.Center = teleportPos;
                
                // Arrival VFX
                CustomParticles.GenericFlare(NPC.Center, Color.White, 1.0f, 20);
                for (int i = 0; i < 6; i++)
                    CustomParticles.HaloRing(NPC.Center, EroicaScarlet * (1f - i * 0.1f), 0.3f + i * 0.1f, 12 + i * 2);
                ThemedParticles.SakuraPetals(NPC.Center, 15, 60f);
                SoundEngine.PlaySound(SoundID.Item8 with { Pitch = 0.2f, Volume = 1.2f }, NPC.Center);
                
                NPC.alpha = 0;
                NPC.velocity = (target.Center - NPC.Center).SafeNormalize(Vector2.Zero) * 5f;
                
                // Immediately fire burst at player
                if (Main.netMode != NetmodeID.MultiplayerClient)
                {
                    for (int i = 0; i < 8; i++)
                    {
                        float projAngle = MathHelper.TwoPi * i / 8f;
                        Vector2 vel = projAngle.ToRotationVector2() * 8f;
                        BossProjectileHelper.SpawnHostileOrb(NPC.Center, vel, 80, EroicaScarlet, 0.015f);
                    }
                }
            }
            
            if (Timer >= 30)
            {
                Timer = 0;
                State = BossState.Phase2_Pursuit;
                attackCooldown = 40;
            }
        }
        
        #endregion
        
        #region ATTACK IMPLEMENTATIONS
        
        // =====================================
        // RAPID DASH - Multiple quick dashes
        // =====================================
        private void Attack_RapidDash(Player target)
        {
            int maxDashes = 3 + phase2Mood;
            int windupTime = 25 - phase2Mood * 5;
            int dashTime = 15;
            int recoveryTime = 10 - phase2Mood * 2;
            
            // Windup
            if (AttackSubPhase == 0)
            {
                NPC.velocity *= 0.9f;
                
                // Calculate dash direction
                if (Timer == 1)
                {
                    dashDirection = (target.Center - NPC.Center).SafeNormalize(Vector2.Zero);
                    SoundEngine.PlaySound(SoundID.Item15 with { Pitch = 0.2f }, NPC.Center);
                }
                
                // Telegraph
                if (Timer > 10)
                {
                    Vector2 endPoint = NPC.Center + dashDirection * 400f;
                    for (int i = 0; i < 15; i++)
                    {
                        Vector2 linePos = Vector2.Lerp(NPC.Center, endPoint, i / 15f);
                        CustomParticles.GenericFlare(linePos, EroicaGold * 0.5f, 0.15f, 2);
                    }
                }
                
                // Charge particles
                if (Timer % 3 == 0)
                {
                    for (int i = 0; i < 4; i++)
                    {
                        Vector2 offset = Main.rand.NextVector2CircularEdge(50f, 50f);
                        CustomParticles.GenericFlare(NPC.Center + offset, EroicaGold, 0.3f, 10);
                    }
                }
                
                if (Timer >= windupTime)
                {
                    Timer = 0;
                    AttackSubPhase = 1;
                }
            }
            // Dash
            else if (AttackSubPhase == 1)
            {
                if (Timer == 1)
                {
                    float dashSpeed = 30f + phase2Mood * 5f;
                    NPC.velocity = dashDirection * dashSpeed;
                    SoundEngine.PlaySound(SoundID.DD2_BetsyFlameBreath with { Pitch = 0.3f + dashCount * 0.1f }, NPC.Center);
                    CustomParticles.GenericFlare(NPC.Center, Color.White, 0.8f, 15);
                    CustomParticles.HaloRing(NPC.Center, EroicaGold, 0.5f, 12);
                }
                
                // Trail particles
                if (Timer % 2 == 0)
                {
                    for (int i = 0; i < 3; i++)
                    {
                        Vector2 offset = Main.rand.NextVector2Circular(15f, 15f);
                        Color trailColor = Color.Lerp(EroicaScarlet, EroicaGold, Main.rand.NextFloat());
                        CustomParticles.GenericFlare(NPC.Center + offset - NPC.velocity * 0.3f, trailColor, 0.35f, 8);
                    }
                }
                
                // Spawn projectiles during dash
                if (Timer % 5 == 0 && phase2Mood > 0 && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    Vector2 perpendicular = dashDirection.RotatedBy(MathHelper.PiOver2);
                    BossProjectileHelper.SpawnHostileOrb(NPC.Center + perpendicular * 30f, perpendicular * 3f, 70, EroicaScarlet, 0.01f);
                    BossProjectileHelper.SpawnHostileOrb(NPC.Center - perpendicular * 30f, -perpendicular * 3f, 70, EroicaScarlet, 0.01f);
                }
                
                if (Timer >= dashTime)
                {
                    Timer = 0;
                    dashCount++;
                    AttackSubPhase = dashCount >= maxDashes ? 3 : 2;
                }
            }
            // Recovery between dashes
            else if (AttackSubPhase == 2)
            {
                NPC.velocity *= 0.85f;
                
                if (Timer == 3)
                {
                    // Retarget with slight variation
                    Vector2 toTarget = (target.Center - NPC.Center).SafeNormalize(Vector2.Zero);
                    float variation = MathHelper.ToRadians(Main.rand.NextFloat(-30f, 30f));
                    dashDirection = toTarget.RotatedBy(variation);
                }
                
                if (Timer >= recoveryTime)
                {
                    Timer = 0;
                    AttackSubPhase = 0;
                }
            }
            // Done
            else
            {
                NPC.velocity *= 0.85f;
                if (Timer >= 20)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // ORB BARRAGE - Spread of tracking orbs
        // =====================================
        private void Attack_OrbBarrage(Player target)
        {
            int windupTime = 30;
            int fireTime = 60 + phase2Mood * 20;
            int fireInterval = 12 - phase2Mood * 2;
            
            if (AttackSubPhase == 0)
            {
                // Windup - gather energy
                NPC.velocity *= 0.9f;
                
                if (Timer % 4 == 0)
                {
                    for (int i = 0; i < 6; i++)
                    {
                        float angle = MathHelper.TwoPi * i / 6f + Timer * 0.05f;
                        Vector2 pos = NPC.Center + angle.ToRotationVector2() * (60f - Timer);
                        CustomParticles.GenericFlare(pos, EroicaScarlet, 0.3f, 10);
                    }
                }
                
                if (Timer >= windupTime)
                {
                    Timer = 0;
                    AttackSubPhase = 1;
                    SoundEngine.PlaySound(SoundID.Item29 with { Pitch = -0.2f }, NPC.Center);
                }
            }
            else if (AttackSubPhase == 1)
            {
                // Fire orbs in spread patterns
                NPC.velocity = Vector2.Lerp(NPC.velocity, (target.Center - NPC.Center).SafeNormalize(Vector2.Zero) * 5f, 0.02f);
                
                if (Timer % fireInterval == 0 && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    int orbCount = 3 + phase2Mood * 2;
                    float spread = MathHelper.ToRadians(60 + phase2Mood * 15);
                    Vector2 baseDir = (target.Center - NPC.Center).SafeNormalize(Vector2.Zero);
                    
                    for (int i = 0; i < orbCount; i++)
                    {
                        float angle = baseDir.ToRotation() - spread / 2f + spread * i / (orbCount - 1);
                        Vector2 vel = angle.ToRotationVector2() * (9f + Main.rand.NextFloat(3f));
                        BossProjectileHelper.SpawnHostileOrb(NPC.Center, vel, 75, EroicaScarlet, 0.025f + phase2Mood * 0.01f);
                    }
                    
                    CustomParticles.GenericFlare(NPC.Center, EroicaGold, 0.5f, 12);
                    SoundEngine.PlaySound(SoundID.Item12 with { Pitch = Main.rand.NextFloat(-0.1f, 0.2f) }, NPC.Center);
                }
                
                if (Timer >= fireTime)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // SPIRAL STORM - Expanding spiral pattern
        // =====================================
        private void Attack_SpiralStorm(Player target)
        {
            int windupTime = 35;
            int spiralTime = 90 + phase2Mood * 30;
            
            if (AttackSubPhase == 0)
            {
                NPC.velocity *= 0.92f;
                
                if (Timer % 3 == 0)
                {
                    float angle = Timer * 0.15f;
                    for (int i = 0; i < 4; i++)
                    {
                        float a = angle + MathHelper.PiOver2 * i;
                        Vector2 pos = NPC.Center + a.ToRotationVector2() * 50f;
                        CustomParticles.GenericFlare(pos, Color.Lerp(EroicaScarlet, EroicaGold, (float)i / 4f), 0.35f, 8);
                    }
                }
                
                if (Timer >= windupTime)
                {
                    Timer = 0;
                    AttackSubPhase = 1;
                    SoundEngine.PlaySound(SoundID.Item122 with { Pitch = 0.1f }, NPC.Center);
                }
            }
            else if (AttackSubPhase == 1)
            {
                NPC.velocity *= 0.95f;
                
                // Fire spiral projectiles
                int projPerSecond = 12 + phase2Mood * 6;
                int interval = 60 / projPerSecond;
                
                if (Timer % interval == 0 && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    float spiralAngle = Timer * 0.08f;
                    int arms = 2 + phase2Mood;
                    
                    for (int arm = 0; arm < arms; arm++)
                    {
                        float angle = spiralAngle + MathHelper.TwoPi * arm / arms;
                        Vector2 vel = angle.ToRotationVector2() * (8f + phase2Mood * 2f);
                        BossProjectileHelper.SpawnWaveProjectile(NPC.Center, vel, 70, EroicaGold, 3f + phase2Mood);
                    }
                    
                    CustomParticles.GenericFlare(NPC.Center, EroicaScarlet, 0.4f, 8);
                }
                
                if (Timer >= spiralTime)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // MIRAGE ASSAULT - Clones attack together
        // =====================================
        private void Attack_MirageAssault(Player target)
        {
            int windupTime = 40;
            
            if (AttackSubPhase == 0)
            {
                NPC.velocity *= 0.9f;
                
                if (Timer == 1)
                {
                    SoundEngine.PlaySound(SoundID.Item8 with { Pitch = -0.4f }, NPC.Center);
                }
                
                // Mysterious building VFX
                if (Timer % 5 == 0)
                {
                    int mirageCount = 3 + phase2Mood;
                    for (int i = 0; i < mirageCount; i++)
                    {
                        float angle = MathHelper.TwoPi * i / mirageCount + Timer * 0.02f;
                        Vector2 pos = target.Center + angle.ToRotationVector2() * 300f;
                        CustomParticles.GenericFlare(pos, EroicaGold * 0.5f, 0.4f, 15);
                    }
                }
                
                if (Timer >= windupTime)
                {
                    Timer = 0;
                    AttackSubPhase = 1;
                    
                    // Spawn mirage projectiles from multiple angles
                    if (Main.netMode != NetmodeID.MultiplayerClient)
                    {
                        int mirageCount = 3 + phase2Mood;
                        for (int i = 0; i < mirageCount; i++)
                        {
                            float angle = MathHelper.TwoPi * i / mirageCount;
                            Vector2 miragePos = target.Center + angle.ToRotationVector2() * 350f;
                            
                            // Each "mirage" fires a barrage
                            for (int j = 0; j < 5; j++)
                            {
                                Vector2 toTarget = (target.Center - miragePos).SafeNormalize(Vector2.Zero);
                                float variation = MathHelper.ToRadians((j - 2) * 8);
                                Vector2 vel = toTarget.RotatedBy(variation) * 12f;
                                BossProjectileHelper.SpawnAcceleratingBolt(miragePos, vel * 0.3f, 75, EroicaGold, 18f);
                            }
                            
                            // VFX at mirage position
                            CustomParticles.GenericFlare(miragePos, Color.White, 0.7f, 20);
                            for (int r = 0; r < 4; r++)
                                CustomParticles.HaloRing(miragePos, EroicaGold * (1f - r * 0.2f), 0.3f + r * 0.1f, 12 + r * 2);
                        }
                    }
                    
                    MagnumScreenEffects.AddScreenShake(8f);
                    SoundEngine.PlaySound(SoundID.Item122 with { Pitch = 0.3f, Volume = 1.1f }, target.Center);
                }
            }
            else
            {
                if (Timer >= 60)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // METEOR RAIN - Projectiles from above
        // =====================================
        private void Attack_MeteorRain(Player target)
        {
            int windupTime = 30;
            int rainTime = 120 + phase2Mood * 40;
            
            if (AttackSubPhase == 0)
            {
                NPC.velocity *= 0.92f;
                
                // Warning above player
                if (Timer % 8 == 0)
                {
                    Vector2 warningPos = target.Center + new Vector2(Main.rand.NextFloat(-200f, 200f), -400f);
                    CustomParticles.GenericFlare(warningPos, EroicaScarlet * 0.6f, 0.4f, 15);
                }
                
                if (Timer >= windupTime)
                {
                    Timer = 0;
                    AttackSubPhase = 1;
                    SoundEngine.PlaySound(SoundID.Item29 with { Pitch = 0.4f }, NPC.Center);
                }
            }
            else if (AttackSubPhase == 1)
            {
                // Pursue player while raining
                Vector2 toTarget = (target.Center + new Vector2(0, -200) - NPC.Center).SafeNormalize(Vector2.Zero);
                NPC.velocity = Vector2.Lerp(NPC.velocity, toTarget * 8f, 0.04f);
                
                // Spawn meteors
                int interval = 15 - phase2Mood * 3;
                if (Timer % interval == 0 && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    int meteorCount = 2 + phase2Mood;
                    for (int i = 0; i < meteorCount; i++)
                    {
                        float xOffset = Main.rand.NextFloat(-350f, 350f);
                        Vector2 spawnPos = target.Center + new Vector2(xOffset, -500f);
                        Vector2 vel = new Vector2(Main.rand.NextFloat(-2f, 2f), 10f + phase2Mood * 2f);
                        BossProjectileHelper.SpawnAcceleratingBolt(spawnPos, vel, 80, EroicaScarlet, 20f);
                        
                        CustomParticles.GenericFlare(spawnPos, EroicaScarlet, 0.4f, 10);
                    }
                }
                
                if (Timer >= rainTime)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // VALOR WALL - Projectile wall sweep
        // =====================================
        private void Attack_ValorWall(Player target)
        {
            int windupTime = 35;
            int wallCount = 2 + phase2Mood;
            int wallDelay = 50 - phase2Mood * 10;
            
            if (AttackSubPhase < wallCount)
            {
                if (Timer == 0)
                {
                    SoundEngine.PlaySound(SoundID.Item73 with { Pitch = 0.1f * AttackSubPhase }, NPC.Center);
                }
                
                NPC.velocity *= 0.92f;
                
                // Warning line
                if (Timer >= 15 && Timer < windupTime)
                {
                    int side = (AttackSubPhase % 2 == 0) ? -1 : 1;
                    Vector2 wallStart = target.Center + new Vector2(side * 600f, -300f);
                    
                    for (int i = 0; i < 20; i++)
                    {
                        Vector2 warningPos = wallStart + new Vector2(0, i * 30f);
                        CustomParticles.GenericFlare(warningPos, EroicaGold * 0.4f, 0.2f, 3);
                    }
                }
                
                if (Timer == windupTime && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    int side = (AttackSubPhase % 2 == 0) ? -1 : 1;
                    Vector2 wallStart = target.Center + new Vector2(side * 600f, -300f);
                    Vector2 wallDir = new Vector2(-side, 0);
                    
                    int projCount = 15 + phase2Mood * 5;
                    for (int i = 0; i < projCount; i++)
                    {
                        Vector2 spawnPos = wallStart + new Vector2(0, i * 40f);
                        Vector2 vel = wallDir * (12f + phase2Mood * 3f);
                        BossProjectileHelper.SpawnHostileOrb(spawnPos, vel, 75, EroicaScarlet, 0f);
                    }
                    
                    MagnumScreenEffects.AddScreenShake(6f);
                }
                
                if (Timer >= windupTime + wallDelay)
                {
                    Timer = 0;
                    AttackSubPhase++;
                }
            }
            else
            {
                if (Timer >= 30)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // PHOENIX DIVE - Teleport + Dive attack
        // =====================================
        private void Attack_PhoenixDive(Player target)
        {
            if (AttackSubPhase == 0)
            {
                // Fade out
                NPC.alpha = (int)MathHelper.Lerp(0, 255, Timer / 30f);
                NPC.velocity *= 0.9f;
                
                if (Timer == 1)
                {
                    SoundEngine.PlaySound(SoundID.Item8 with { Pitch = -0.5f }, NPC.Center);
                }
                
                // Fire particles rising
                if (Timer % 3 == 0)
                {
                    for (int i = 0; i < 5; i++)
                    {
                        Vector2 pos = NPC.Center + Main.rand.NextVector2Circular(40f, 40f);
                        CustomParticles.GenericFlare(pos, Color.Lerp(EroicaScarlet, EroicaGold, Timer / 30f), 0.35f, 12);
                    }
                }
                
                if (Timer >= 30)
                {
                    Timer = 0;
                    AttackSubPhase = 1;
                    
                    // Teleport behind player
                    Vector2 playerVel = target.velocity;
                    float behindAngle = playerVel.Length() > 2f ? playerVel.ToRotation() + MathHelper.Pi : Main.rand.NextFloat(MathHelper.TwoPi);
                    NPC.Center = target.Center + behindAngle.ToRotationVector2() * 400f;
                    NPC.alpha = 0;
                    
                    // Arrival burst
                    CustomParticles.GenericFlare(NPC.Center, Color.White, 1.0f, 20);
                    for (int i = 0; i < 12; i++)
                    {
                        float angle = MathHelper.TwoPi * i / 12f;
                        CustomParticles.GenericFlare(NPC.Center + angle.ToRotationVector2() * 40f, EroicaGold, 0.4f, 15);
                    }
                    
                    SoundEngine.PlaySound(SoundID.Item45 with { Pitch = 0.3f, Volume = 1.2f }, NPC.Center);
                    dashDirection = (target.Center - NPC.Center).SafeNormalize(Vector2.Zero);
                }
            }
            else if (AttackSubPhase == 1)
            {
                // Brief telegraph
                if (Timer < 15)
                {
                    Vector2 endPoint = NPC.Center + dashDirection * 500f;
                    for (int i = 0; i < 20; i++)
                    {
                        Vector2 pos = Vector2.Lerp(NPC.Center, endPoint, i / 20f);
                        CustomParticles.GenericFlare(pos, EroicaScarlet * 0.6f, 0.15f, 2);
                    }
                }
                
                if (Timer == 15)
                {
                    float diveSpeed = 40f + phase2Mood * 8f;
                    NPC.velocity = dashDirection * diveSpeed;
                    SoundEngine.PlaySound(SoundID.DD2_BetsyFlameBreath with { Volume = 1.3f }, NPC.Center);
                    
                    // Fire projectiles during dive
                    if (Main.netMode != NetmodeID.MultiplayerClient)
                    {
                        for (int i = 0; i < 8; i++)
                        {
                            float angle = MathHelper.TwoPi * i / 8f;
                            Vector2 vel = angle.ToRotationVector2() * 6f;
                            BossProjectileHelper.SpawnHostileOrb(NPC.Center, vel, 85, EroicaCrimson, 0.02f);
                        }
                    }
                }
                
                // Dive trail
                if (Timer >= 15 && Timer % 2 == 0)
                {
                    for (int i = 0; i < 4; i++)
                    {
                        Vector2 offset = Main.rand.NextVector2Circular(20f, 20f);
                        CustomParticles.GenericFlare(NPC.Center + offset - NPC.velocity * 0.3f, EroicaGold, 0.4f, 10);
                    }
                }
                
                if (Timer >= 35)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // VORTEX PULL - Pull player while firing
        // =====================================
        private void Attack_VortexPull(Player target)
        {
            int duration = 150 + phase2Mood * 30;
            
            if (AttackSubPhase == 0)
            {
                // Windup
                NPC.velocity *= 0.9f;
                
                if (Timer % 4 == 0)
                {
                    for (int i = 0; i < 8; i++)
                    {
                        float angle = MathHelper.TwoPi * i / 8f + Timer * 0.1f;
                        Vector2 pos = NPC.Center + angle.ToRotationVector2() * (80f - Timer);
                        CustomParticles.GenericFlare(pos, EroicaScarlet, 0.3f, 8);
                    }
                }
                
                if (Timer >= 40)
                {
                    Timer = 0;
                    AttackSubPhase = 1;
                    SoundEngine.PlaySound(SoundID.Item122 with { Pitch = -0.3f, Volume = 1.2f }, NPC.Center);
                }
            }
            else if (AttackSubPhase == 1)
            {
                // VORTEX ACTIVE - Pull player toward boss
                float pullStrength = 0.8f + phase2Mood * 0.3f;
                Vector2 pullDir = (NPC.Center - target.Center).SafeNormalize(Vector2.Zero);
                target.velocity += pullDir * pullStrength;
                
                // Vortex visual
                if (Timer % 3 == 0)
                {
                    for (int i = 0; i < 6; i++)
                    {
                        float angle = MathHelper.TwoPi * i / 6f + Timer * 0.15f;
                        float radius = 100f + (float)Math.Sin(Timer * 0.1f) * 30f;
                        Vector2 pos = NPC.Center + angle.ToRotationVector2() * radius;
                        Vector2 vel = (NPC.Center - pos).SafeNormalize(Vector2.Zero) * 2f;
                        CustomParticles.GenericFlare(pos, EroicaScarlet, 0.35f, 12);
                    }
                }
                
                // Fire projectiles outward
                if (Timer % (18 - phase2Mood * 3) == 0 && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    int count = 6 + phase2Mood * 2;
                    for (int i = 0; i < count; i++)
                    {
                        float angle = MathHelper.TwoPi * i / count + Timer * 0.02f;
                        Vector2 vel = angle.ToRotationVector2() * 10f;
                        BossProjectileHelper.SpawnHostileOrb(NPC.Center, vel, 75, EroicaGold, 0f);
                    }
                    CustomParticles.GenericFlare(NPC.Center, Color.White, 0.6f, 10);
                }
                
                if (Timer >= duration)
                {
                    EndAttack();
                }
            }
        }
        
        private void EndAttack()
        {
            Timer = 0;
            State = BossState.Phase2_Pursuit;
            attackCooldown = 50 - phase2Mood * 10;
        }
        
        #endregion
        
        #region Visual Effects
        
        private void UpdateAnimation()
        {
            frameCounter++;
            if (frameCounter >= (phase2Started ? 3 : 5))
            {
                frameCounter = 0;
                currentFrame++;
                if (currentFrame >= TotalFrames)
                    currentFrame = 0;
            }
        }
        
        private void SpawnAmbientParticles()
        {
            if (!phase2Started) return;
            
            // Orbiting flames
            if (Timer % 6 == 0)
            {
                int orbitCount = 4 + phase2Mood * 2;
                for (int i = 0; i < orbitCount; i++)
                {
                    float angle = Timer * 0.03f + MathHelper.TwoPi * i / orbitCount;
                    float radius = 70f + (float)Math.Sin(Timer * 0.05f) * 15f;
                    Vector2 pos = NPC.Center + angle.ToRotationVector2() * radius;
                    Color color = Color.Lerp(EroicaScarlet, EroicaGold, (float)i / orbitCount);
                    CustomParticles.GenericFlare(pos, color, 0.3f, 10);
                }
            }
            
            // Sakura petals
            if (Main.rand.NextBool(5 - phase2Mood))
            {
                ThemedParticles.SakuraPetals(NPC.Center + Main.rand.NextVector2Circular(60f, 60f), 2, 30f);
            }
        }
        
        private void UpdateDeathAnimation()
        {
            deathTimer++;
            NPC.velocity *= 0.95f;
            
            // Escalating VFX
            if (deathTimer % 10 == 0)
            {
                float progress = deathTimer / 180f;
                MagnumScreenEffects.AddScreenShake(5f + progress * 15f);
                
                Vector2 burstPos = NPC.Center + Main.rand.NextVector2Circular(50f, 50f);
                CustomParticles.GenericFlare(burstPos, Color.White, 0.6f + progress, 20);
                CustomParticles.HaloRing(burstPos, EroicaGold, 0.4f + progress * 0.3f, 15);
                ThemedParticles.SakuraPetals(burstPos, (int)(5 + progress * 10), 60f);
            }
            
            // Final explosion
            if (deathTimer >= 180)
            {
                MagnumScreenEffects.AddScreenShake(25f);
                
                for (int i = 0; i < 10; i++)
                {
                    float scale = 0.4f + i * 0.2f;
                    CustomParticles.HaloRing(NPC.Center, Color.Lerp(EroicaScarlet, EroicaGold, i / 10f), scale, 25 + i * 3);
                }
                
                for (int i = 0; i < 16; i++)
                {
                    float angle = MathHelper.TwoPi * i / 16f;
                    CustomParticles.GenericFlare(NPC.Center + angle.ToRotationVector2() * 80f, EroicaGold, 0.7f, 30);
                }
                
                ThemedParticles.SakuraPetals(NPC.Center, 50, 150f);
                
                NPC.life = 0;
                NPC.HitEffect();
                NPC.checkDead();
            }
        }
        
        #endregion
        
        #region Drawing
        
        public override void FindFrame(int frameHeight)
        {
            NPC.frame.Y = currentFrame * frameHeight;
        }
        
        public override bool PreDraw(SpriteBatch spriteBatch, Vector2 screenPos, Color drawColor)
        {
            Texture2D tex = ModContent.Request<Texture2D>(Texture).Value;
            int frameWidth = tex.Width / 6;
            int frameHeight = tex.Height / 6;
            int row = currentFrame / 6;
            int col = currentFrame % 6;
            Rectangle sourceRect = new Rectangle(col * frameWidth, row * frameHeight, frameWidth, frameHeight);
            Vector2 origin = new Vector2(frameWidth / 2f, frameHeight / 2f);
            Vector2 drawPos = NPC.Center - screenPos;
            SpriteEffects effects = NPC.spriteDirection == -1 ? SpriteEffects.FlipHorizontally : SpriteEffects.None;
            
            // Trail effect
            if (phase2Started && NPC.velocity.Length() > 5f)
            {
                for (int i = 0; i < NPC.oldPos.Length; i++)
                {
                    float progress = (float)i / NPC.oldPos.Length;
                    Color trailColor = Color.Lerp(EroicaScarlet, EroicaGold, progress) * (1f - progress) * 0.4f;
                    Vector2 trailPos = NPC.oldPos[i] + NPC.Size / 2f - screenPos;
                    spriteBatch.Draw(tex, trailPos, sourceRect, trailColor, NPC.rotation, origin, NPC.scale * (1f - progress * 0.2f), effects, 0f);
                }
            }
            
            // Glow underlay
            Color glowColor = Color.Lerp(EroicaGold, EroicaScarlet, (float)Math.Sin(Timer * 0.05f) * 0.5f + 0.5f);
            glowColor.A = 0;
            spriteBatch.Draw(tex, drawPos, sourceRect, glowColor * 0.3f, NPC.rotation, origin, NPC.scale * 1.1f, effects, 0f);
            
            // Main sprite
            Color mainColor = NPC.IsABestiaryIconDummy ? Color.White : Lighting.GetColor((int)(NPC.Center.X / 16), (int)(NPC.Center.Y / 16));
            mainColor = Color.Lerp(mainColor, Color.White, 0.3f);
            spriteBatch.Draw(tex, drawPos, sourceRect, mainColor * ((255 - NPC.alpha) / 255f), NPC.rotation, origin, NPC.scale, effects, 0f);
            
            return false;
        }
        
        #endregion
        
        #region Loot
        
        public override void ModifyNPCLoot(NPCLoot npcLoot)
        {
            // Expert/Master mode: Drop treasure bag
            npcLoot.Add(ItemDropRule.BossBag(ModContent.ItemType<EroicaTreasureBag>()));
            
            // Normal mode drops
            LeadingConditionRule notExpert = new LeadingConditionRule(new Conditions.NotExpert());
            
            // Energy
            notExpert.OnSuccess(ItemDropRule.Common(ModContent.ItemType<EroicasResonantEnergy>(), 1, 10, 12));
            
            // Remnant
            notExpert.OnSuccess(ItemDropRule.Common(ModContent.ItemType<RemnantOfEroicasTriumph>(), 1, 15, 17));
            
            npcLoot.Add(notExpert);
        }
        
        public override bool CheckDead()
        {
            if (State != BossState.Dying)
            {
                State = BossState.Dying;
                deathTimer = 0;
                NPC.life = 1;
                NPC.dontTakeDamage = true;
                return false;
            }
            return true;
        }
        
        #endregion
    }
}
