using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;
using System;
using System.Collections.Generic;
using Terraria;
using Terraria.GameContent.Bestiary;
using Terraria.GameContent.ItemDropRules;
using Terraria.ID;
using Terraria.ModLoader;
using Terraria.Audio;
using MagnumOpus.Content.Eroica.ResonanceEnergies;
using MagnumOpus.Content.Eroica.Projectiles;
using MagnumOpus.Content.Eroica.ResonantWeapons;
using MagnumOpus.Content.Eroica.Pets;
using MagnumOpus.Content.Eroica.Enemies;
using MagnumOpus.Common.Systems;
using MagnumOpus.Common.Systems.Particles;
using MagnumOpus.Common.Systems.VFX;

namespace MagnumOpus.Content.Eroica.Bosses
{
    /// <summary>
    /// Eroica, God of Valor - Complete rework of the Eroica boss.
    /// Phase 1: 3 Flames of Valor orbit and attack, boss is invulnerable.
    /// Phase 2: Boss becomes enraged with charge attacks and Hand of Valor projectiles.
    /// 
    /// === PHASE SYSTEM (DoG-Inspired) ===
    /// Phase 2A "Triumphant" (100-60% HP): Heroic, steady attacks with clear tells
    /// Phase 2B "Fury" (60-30% HP): Faster attacks, more projectiles, music intensifies  
    /// Phase 2C "Desperate Valor" (30-0% HP): Relentless assault, chains attacks, crescendo
    /// Each phase has distinct mood, tempo, and attack patterns like Devourer of Gods.
    /// </summary>
    public class EroicasRetribution : ModNPC
    {
        // Use the new sprite sheet
        public override string Texture => "MagnumOpus/Content/Eroica/Bosses/EroicaGodOfValor";
        
        // Phase 2 Sub-phases (DoG-inspired mood system)
        private enum Phase2Mood
        {
            Triumphant,      // 100-60% - Heroic, measured attacks
            Fury,            // 60-30% - Intense, rapid attacks
            DesperateValor   // 30-0% - Relentless, chained attacks
        }
        
        private Phase2Mood currentMood = Phase2Mood.Triumphant;
        private bool hasAnnouncedFury = false;
        private bool hasAnnouncedDesperate = false;
        
        // AI States - COMPLETELY REDESIGNED for challenging combat
        private enum ActionState
        {
            // Phase 1 - Flames alive
            Phase1Hover,
            
            // Phase 2 - Flames dead  
            Phase2Transition,
            Phase2Hover,
            
            // === NEW ATTACK SUITE - Challenging & Dynamic ===
            // Attack 1: Heroic Chain Dash - Multi-dash combo with telegraphed directions
            HeroicChainDashWindup,
            HeroicChainDashExecute,
            HeroicChainDashRecovery,
            
            // Attack 2: Valor Spiral Barrage - Spiral projectile patterns
            ValorSpiralWindup,
            ValorSpiralFiring,
            
            // Attack 3: Phoenix Rebirth Strike - Teleport + explosive arrival + instant attack
            PhoenixRebirthWindup,
            PhoenixRebirthTeleport,
            PhoenixRebirthStrike,
            
            // Attack 4: Petal Storm Wall - DoG-style projectile walls
            PetalStormWallWindup,
            PetalStormWallFiring,
            
            // Attack 5: Banner Rally - Plants damaging zones
            BannerRallyWindup,
            BannerRallyPlanting,
            
            // Attack 6: Triumphant Beam Sweep - Rotating laser beams
            BeamSweepWindup,
            BeamSweepFiring,
            
            // Attack 7: Sakura Meteor Storm - Raining projectiles from above
            MeteorStormWindup,
            MeteorStormRaining,
            
            // Attack 8: Valor Vortex - Pull player while firing
            ValorVortexWindup,
            ValorVortexActive,
            
            // Attack 9: Combo Finisher - Chains multiple attacks rapidly
            ComboFinisherWindup,
            ComboFinisherExecute,
            
            // Mood transition
            MoodTransition,
            
            // === COWARD PUNISHMENT ATTACKS ===
            // Ground Strike - Punishes players who stay below the boss
            GroundStrikeWindup,
            GroundStrikeDive,
            GroundStrikeExplosion,
            
            // Valorous Cage - Punishes camping players by trapping them
            ValorousCageWindup,
            ValorousCageActive,
            
            // Wrath of Valor - Ultimate punishment for prolonged cowardice
            WrathOfValorWindup,
            WrathOfValorExecute
        }

        private ActionState State
        {
            get => (ActionState)NPC.ai[0];
            set => NPC.ai[0] = (float)value;
        }

        private float Timer
        {
            get => NPC.ai[1];
            set => NPC.ai[1] = value;
        }

        private float AttackCounter
        {
            get => NPC.ai[2];
            set => NPC.ai[2] = value;
        }

        private bool phase2Started = false;
        private bool flamesSpawned = false;
        private int chargeCount = 0;
        private const int MaxCharges = 3;
        private Vector2 chargeDirection = Vector2.Zero;
        
        // Speed boost mechanics
        private int flamesKilledCount = 0; // Track how many flames have died for Phase 1 speed boost
        private int previousFlameCount = 3; // Track previous flame count to detect deaths
        
        // Phase 2 aura pulsing
        private float auraPulse = 0f;
        
        // Fluid movement
        private float hoverWaveOffset = 0f;
        
        // === NEW ATTACK VARIABLES - Challenging Combat System ===
        // Chain Dash
        private int chainDashCount = 0;
        private int maxChainDashes = 3;
        private Vector2[] chainDashDirections = new Vector2[5];
        private float chainDashSpeed = 28f;
        
        // Valor Spiral
        private float spiralAngle = 0f;
        private int spiralWaveCount = 0;
        private const int MaxSpiralWaves = 4;
        
        // Phoenix Rebirth
        private Vector2 phoenixTargetPos = Vector2.Zero;
        private bool phoenixTeleported = false;
        
        // Petal Storm Wall
        private float petalWallAngle = 0f;
        private int petalWallsFired = 0;
        private const int MaxPetalWalls = 3;
        
        // Banner Rally
        private List<Vector2> bannerPositions = new List<Vector2>();
        private int bannersPlanted = 0;
        private const int MaxBanners = 4;
        
        // Beam Sweep
        private float beamSweepAngle = 0f;
        private float beamSweepDirection = 1f;
        private int beamCount = 2;
        
        // Meteor Storm
        private int meteorsSpawned = 0;
        private const int MaxMeteors = 24;
        private List<Vector2> meteorTargets = new List<Vector2>();
        
        // Valor Vortex
        private float vortexStrength = 0f;
        private int vortexProjectileTimer = 0;
        
        // Combo Finisher
        private int comboAttackIndex = 0;
        private int comboAttacksRemaining = 0;
        
        // Attack tracking
        private int attackCycleCounter = 0;
        private int consecutiveAttackType = -1;
        
        // Animation - adjust based on your sprite sheet
        private int frameCounter = 0;
        private int currentFrame = 0;
        private const int FrameTime = 4;
        private const int FrameColumns = 6; // Adjust to actual
        private const int FrameRows = 6; // Adjust to actual
        private const int TotalFrames = 36;
        
        // Death animation
        private bool isDying = false;
        private int deathTimer = 0;
        private const int DeathAnimationDuration = 180;
        private float screenFlashIntensity = 0f;
        
        // Health bar registration
        private bool hasRegisteredHealthBar = false;
        
        // === COWARD DETECTION SYSTEM ===
        // Punishes players who camp, hide in boxes, or refuse to engage
        private Vector2 lastPlayerPosition = Vector2.Zero;
        private int playerStationaryTimer = 0;
        private const int StationaryThreshold = 150; // 2.5 seconds of camping triggers punishment
        private const float MovementThreshold = 40f; // Player must move more than this to reset timer
        private int cowardAttackCooldown = 0;
        private int playerBelowTimer = 0;
        private const int BelowThreshold = 120; // 2 seconds of being below boss triggers ground strike

        public override void SetStaticDefaults()
        {
            Main.npcFrameCount[Type] = TotalFrames;
            
            NPCID.Sets.MPAllowedEnemies[Type] = true;
            NPCID.Sets.BossBestiaryPriority.Add(Type);
            NPCID.Sets.TrailCacheLength[Type] = 10;
            NPCID.Sets.TrailingMode[Type] = 1;
            NPCID.Sets.MustAlwaysDraw[Type] = true;
            
            // Debuff immunities
            NPCID.Sets.SpecificDebuffImmunity[Type][BuffID.Poisoned] = true;
            NPCID.Sets.SpecificDebuffImmunity[Type][BuffID.Confused] = true;
            NPCID.Sets.SpecificDebuffImmunity[Type][BuffID.OnFire] = true;
            NPCID.Sets.SpecificDebuffImmunity[Type][BuffID.Frostburn] = true;
            NPCID.Sets.SpecificDebuffImmunity[Type][BuffID.Ichor] = true;
        }

        public override void SetDefaults()
        {
            // Hitbox matches visual: ~166px frame Ã— 0.65f scale = ~108px
            NPC.width = 100;
            NPC.height = 120;
            NPC.damage = 90;
            NPC.defense = 80;
            NPC.lifeMax = 406306; // Keep original health
            NPC.HitSound = SoundID.NPCHit1;
            NPC.DeathSound = SoundID.NPCDeath14;
            NPC.knockBackResist = 0f;
            NPC.noGravity = true;
            NPC.noTileCollide = true;
            NPC.value = Item.buyPrice(gold: 20);
            NPC.boss = true;
            NPC.npcSlots = 15f;
            NPC.aiStyle = -1;
            NPC.scale = 0.65f; // 45% increase from previous (larger boss)
            NPC.dontTakeDamage = true; // Invulnerable until flames die
            
            if (!Main.dedServ)
            {
                Music = MusicLoader.GetMusicSlot(Mod, "Assets/Music/CrownOfEroica");
            }
        }

        public override void SetBestiary(BestiaryDatabase database, BestiaryEntry bestiaryEntry)
        {
            bestiaryEntry.Info.AddRange(new IBestiaryInfoElement[]
            {
                BestiaryDatabaseNPCsPopulator.CommonTags.SpawnConditions.Times.NightTime,
                new FlavorTextBestiaryInfoElement("Eroica, God of Valor - a triumphant deity born from Beethoven's Third Symphony. " +
                    "Three Flames of Valor serve as guardians of its divine spirit.")
            });
        }

        public override void AI()
        {
            // Register with custom health bar system
            if (!hasRegisteredHealthBar)
            {
                BossHealthBarUI.RegisterBoss(NPC, BossColorTheme.Eroica);
                hasRegisteredHealthBar = true;
            }
            
            // Handle death animation
            if (isDying)
            {
                UpdateDeathAnimation();
                NPC.velocity = Main.rand.NextVector2Circular(2f, 2f);
                NPC.position += Main.rand.NextVector2Circular(1f, 1f);
                
                if (deathTimer >= DeathAnimationDuration)
                {
                    NPC.life = 0;
                    NPC.HitEffect();
                    NPC.checkDead();
                }
                return;
            }
            
            NPC.TargetClosest(true);
            Player target = Main.player[NPC.target];

            // Despawn check
            if (!target.active || target.dead)
            {
                NPC.velocity.Y -= 0.5f;
                NPC.EncourageDespawn(60);
                return;
            }

            // Spawn flames on first frame
            if (!flamesSpawned && Main.netMode != NetmodeID.MultiplayerClient)
            {
                SpawnFlames();
                flamesSpawned = true;
            }

            // Update animation
            UpdateAnimation();
            
            // Update aura pulse
            auraPulse += 0.05f;

            // Check if all flames are dead for phase 2 transition
            if (!phase2Started)
            {
                int aliveFlames = CountAliveFlames();
                if (aliveFlames == 0 && flamesSpawned)
                {
                    State = ActionState.Phase2Transition;
                    Timer = 0;
                    phase2Started = true;
                    NPC.dontTakeDamage = false;
                    NPC.netUpdate = true;
                }
            }

            // Lighting
            float lightPulse = 0.8f + (float)Math.Sin(auraPulse) * 0.2f;
            if (phase2Started)
            {
                Lighting.AddLight(NPC.Center, 1f * lightPulse, 0.3f * lightPulse, 0.2f * lightPulse);
            }
            else
            {
                Lighting.AddLight(NPC.Center, 1f * lightPulse, 0.7f * lightPulse, 0.3f * lightPulse);
            }

            // Ambient particles
            SpawnAmbientParticles();

            Timer++;
            if (cowardAttackCooldown > 0) cowardAttackCooldown--;
            
            // === COWARD DETECTION SYSTEM ===
            // Punishes players who camp, hide, or refuse to engage with the boss
            if (phase2Started && State == ActionState.Phase2Hover)
            {
                // Track player movement - are they camping in one spot?
                float distanceMoved = Vector2.Distance(target.Center, lastPlayerPosition);
                if (distanceMoved < MovementThreshold)
                {
                    playerStationaryTimer++;
                    
                    // Warning particles when approaching punishment
                    if (playerStationaryTimer > StationaryThreshold / 2 && playerStationaryTimer % 10 == 0)
                    {
                        // Golden chains manifest around camper
                        for (int i = 0; i < 4; i++)
                        {
                            float angle = MathHelper.TwoPi * i / 4f + Main.GameUpdateCount * 0.05f;
                            Vector2 warningPos = target.Center + angle.ToRotationVector2() * 60f;
                            CustomParticles.GenericFlare(warningPos, UnifiedVFX.Eroica.Gold * 0.7f, 0.4f, 15);
                        }
                        CustomParticles.HaloRing(target.Center, UnifiedVFX.Eroica.Crimson * 0.5f, 0.3f, 12);
                    }
                }
                else
                {
                    playerStationaryTimer = Math.Max(0, playerStationaryTimer - 3); // Reward movement
                }
                lastPlayerPosition = target.Center;
                
                // Track if player stays below the boss
                float verticalDiff = target.Center.Y - NPC.Center.Y;
                if (verticalDiff > 150f) // Player is significantly below
                {
                    playerBelowTimer++;
                    
                    // Warning - boss glows ominously
                    if (playerBelowTimer > BelowThreshold / 2 && playerBelowTimer % 8 == 0)
                    {
                        CustomParticles.GenericFlare(NPC.Center, UnifiedVFX.Eroica.Scarlet, 0.6f, 18);
                        ThemedParticles.EroicaSparks(NPC.Bottom, new Vector2(0, 1f), 3, 4f);
                    }
                }
                else
                {
                    playerBelowTimer = Math.Max(0, playerBelowTimer - 2);
                }
            }
            
            // === PHASE 2 MOOD SYSTEM (DoG-Inspired) ===
            // Updates sub-phase mood based on health with dramatic transitions
            if (phase2Started)
            {
                UpdatePhase2Mood(target);
            }

            // State machine - COMPLETELY REDESIGNED ATTACKS
            switch (State)
            {
                case ActionState.Phase1Hover:
                    Phase1Hover(target);
                    break;
                case ActionState.Phase2Transition:
                    Phase2Transition(target);
                    break;
                case ActionState.Phase2Hover:
                    Phase2Hover(target);
                    break;
                    
                // === NEW CHALLENGING ATTACK SUITE ===
                // Attack 1: Heroic Chain Dash
                case ActionState.HeroicChainDashWindup:
                    HeroicChainDashWindup(target);
                    break;
                case ActionState.HeroicChainDashExecute:
                    HeroicChainDashExecute(target);
                    break;
                case ActionState.HeroicChainDashRecovery:
                    HeroicChainDashRecovery(target);
                    break;
                    
                // Attack 2: Valor Spiral Barrage
                case ActionState.ValorSpiralWindup:
                    ValorSpiralWindup(target);
                    break;
                case ActionState.ValorSpiralFiring:
                    ValorSpiralFiring(target);
                    break;
                    
                // Attack 3: Phoenix Rebirth Strike
                case ActionState.PhoenixRebirthWindup:
                    PhoenixRebirthWindup(target);
                    break;
                case ActionState.PhoenixRebirthTeleport:
                    PhoenixRebirthTeleport(target);
                    break;
                case ActionState.PhoenixRebirthStrike:
                    PhoenixRebirthStrike(target);
                    break;
                    
                // Attack 4: Petal Storm Wall
                case ActionState.PetalStormWallWindup:
                    PetalStormWallWindup(target);
                    break;
                case ActionState.PetalStormWallFiring:
                    PetalStormWallFiring(target);
                    break;
                    
                // Attack 5: Banner Rally
                case ActionState.BannerRallyWindup:
                    BannerRallyWindup(target);
                    break;
                case ActionState.BannerRallyPlanting:
                    BannerRallyPlanting(target);
                    break;
                    
                // Attack 6: Beam Sweep
                case ActionState.BeamSweepWindup:
                    BeamSweepWindup(target);
                    break;
                case ActionState.BeamSweepFiring:
                    BeamSweepFiring(target);
                    break;
                    
                // Attack 7: Meteor Storm
                case ActionState.MeteorStormWindup:
                    MeteorStormWindup(target);
                    break;
                case ActionState.MeteorStormRaining:
                    MeteorStormRaining(target);
                    break;
                    
                // Attack 8: Valor Vortex
                case ActionState.ValorVortexWindup:
                    ValorVortexWindup(target);
                    break;
                case ActionState.ValorVortexActive:
                    ValorVortexActive(target);
                    break;
                    
                // Attack 9: Combo Finisher
                case ActionState.ComboFinisherWindup:
                    ComboFinisherWindup(target);
                    break;
                case ActionState.ComboFinisherExecute:
                    ComboFinisherExecute(target);
                    break;
                    
                // === COWARD PUNISHMENT ATTACKS ===
                case ActionState.GroundStrikeWindup:
                    GroundStrikeWindup(target);
                    break;
                case ActionState.GroundStrikeDive:
                    GroundStrikeDive(target);
                    break;
                case ActionState.GroundStrikeExplosion:
                    GroundStrikeExplosion(target);
                    break;
                case ActionState.ValorousCageWindup:
                    ValorousCageWindup(target);
                    break;
                case ActionState.ValorousCageActive:
                    ValorousCageActive(target);
                    break;
                case ActionState.WrathOfValorWindup:
                    WrathOfValorWindup(target);
                    break;
                case ActionState.WrathOfValorExecute:
                    WrathOfValorExecute(target);
                    break;
            }

            // Face the player - sprite faces RIGHT by default, flip for left
            NPC.spriteDirection = NPC.direction = (target.Center.X > NPC.Center.X) ? 1 : -1;
        }

        private void SpawnFlames()
        {
            if (Main.netMode == NetmodeID.MultiplayerClient) return;

            // Spawn 3 Flames of Valor at different orbit positions
            float[] offsets = { 0f, MathHelper.TwoPi / 3f, MathHelper.TwoPi * 2f / 3f };
            
            for (int i = 0; i < 3; i++)
            {
                int flameIndex = NPC.NewNPC(NPC.GetSource_FromAI(), (int)NPC.Center.X, (int)NPC.Center.Y, 
                    ModContent.NPCType<FlamesOfValor>());
                    
                if (flameIndex < Main.maxNPCs && Main.npc[flameIndex].ModNPC is FlamesOfValor flame)
                {
                    flame.SetOrbitOffset(offsets[i]);
                }
            }

            Main.NewText("The Flames of Valor ignite...", 255, 200, 100);
        }

        private int CountAliveFlames()
        {
            int count = 0;
            for (int i = 0; i < Main.maxNPCs; i++)
            {
                if (Main.npc[i].active && Main.npc[i].type == ModContent.NPCType<FlamesOfValor>())
                {
                    count++;
                }
            }
            return count;
        }
        
        private void UpdateAnimation()
        {
            frameCounter++;
            int animSpeed = phase2Started ? 2 : FrameTime;
            if (frameCounter >= animSpeed)
            {
                frameCounter = 0;
                currentFrame++;
                if (currentFrame >= TotalFrames)
                    currentFrame = 0;
            }
        }

        private void SpawnAmbientParticles()
        {
            // === EROICA AMBIENT EFFECTS ===
            // A heroic symphony of valor - sakura petals, golden flames, and triumphant radiance
            
            float moodIntensity = GetMoodIntensity();
            float pulsingGlow = (float)Math.Sin(Main.GameUpdateCount * 0.05f) * 0.2f + 0.8f;
            
            // === 1. ORBITING DETERMINATION FLAMES ===
            // Golden flames orbit the boss like a hero's resolve
            int orbitCount = phase2Started ? 6 : 3;
            float orbitSpeed = 0.025f + (moodIntensity * 0.01f);
            float orbitRadius = 80f + (float)Math.Sin(Main.GameUpdateCount * 0.03f) * 15f;
            
            for (int i = 0; i < orbitCount; i++)
            {
                float angle = Main.GameUpdateCount * orbitSpeed + (MathHelper.TwoPi * i / orbitCount);
                Vector2 orbitPos = NPC.Center + angle.ToRotationVector2() * orbitRadius;
                
                // Staggered spawning for fluid motion
                if ((Main.GameUpdateCount + i * 7) % 5 == 0)
                {
                    Color flameColor = Color.Lerp(ThemedParticles.EroicaScarlet, ThemedParticles.EroicaGold, 
                        (float)Math.Sin(Main.GameUpdateCount * 0.08f + i) * 0.5f + 0.5f);
                    CustomParticles.GenericFlare(orbitPos, flameColor * pulsingGlow, 0.35f + moodIntensity * 0.15f, 12);
                    
                    // Trailing embers from each flame
                    Vector2 trailVel = (angle + MathHelper.PiOver2).ToRotationVector2() * 2f;
                    var ember = new GenericGlowParticle(orbitPos, trailVel * 0.3f, 
                        ThemedParticles.EroicaGold * 0.6f, 0.2f, 15, true);
                    MagnumParticleHandler.SpawnParticle(ember);
                }
            }
            
            // === 2. SAKURA PETAL CASCADE ===
            // Petals fall gracefully, more intense during heroic moods
            int petalChance = phase2Started ? 2 : 4;
            if (Main.rand.NextBool(petalChance))
            {
                // Spawn petals above boss to drift down beautifully
                Vector2 petalOrigin = NPC.Center + new Vector2(Main.rand.NextFloat(-120f, 120f), -60f);
                int petalCount = (int)(3 + moodIntensity * 4);
                ThemedParticles.SakuraPetals(petalOrigin, petalCount, 40f);
            }
            
            // === 3. GOLDEN LIGHT RAYS ===
            // Shafts of golden light radiate from the hero
            if (Main.rand.NextBool(phase2Started ? 6 : 10))
            {
                float rayAngle = Main.rand.NextFloat(MathHelper.TwoPi);
                float rayLength = Main.rand.NextFloat(40f, 80f) * (1f + moodIntensity * 0.5f);
                Vector2 rayDir = rayAngle.ToRotationVector2();
                
                // Draw multiple flares along the ray for a light beam effect
                for (int j = 0; j < 4; j++)
                {
                    float progress = j / 4f;
                    Vector2 rayPos = NPC.Center + rayDir * rayLength * progress;
                    Color rayColor = Color.Lerp(ThemedParticles.EroicaGold, Color.White, progress * 0.4f);
                    CustomParticles.GenericFlare(rayPos, rayColor * (1f - progress * 0.5f), 0.25f - progress * 0.1f, 8);
                }
            }
            
            // === 4. VALOR AURA - BREATHING GLOW ===
            // A warm aura that pulses with heroic determination
            if (Main.GameUpdateCount % 3 == 0)
            {
                float auraRadius = 60f + (float)Math.Sin(Main.GameUpdateCount * 0.04f) * 20f;
                auraRadius *= (1f + moodIntensity * 0.3f);
                
                Vector2 auraOffset = Main.rand.NextVector2Circular(auraRadius, auraRadius * 0.7f);
                Color auraColor = Color.Lerp(ThemedParticles.EroicaCrimson, ThemedParticles.EroicaGold, Main.rand.NextFloat());
                
                var auraParticle = new GenericGlowParticle(NPC.Center + auraOffset, 
                    auraOffset.SafeNormalize(Vector2.Zero) * 0.5f, auraColor * 0.4f * pulsingGlow, 
                    Main.rand.NextFloat(0.2f, 0.35f), Main.rand.Next(20, 35), true);
                MagnumParticleHandler.SpawnParticle(auraParticle);
            }
            
            // === 5. RISING EMBERS OF HEROISM ===
            // Embers rise from below, representing the undying flame of heroism
            if (Main.rand.NextBool(3))
            {
                Vector2 emberStart = NPC.Bottom + new Vector2(Main.rand.NextFloat(-NPC.width * 0.5f, NPC.width * 0.5f), 20f);
                Vector2 emberVel = new Vector2(Main.rand.NextFloat(-0.8f, 0.8f), Main.rand.NextFloat(-2.5f, -1.5f));
                Color emberColor = Main.rand.NextBool(3) ? ThemedParticles.EroicaGold : ThemedParticles.EroicaScarlet;
                
                var risingEmber = new GenericGlowParticle(emberStart, emberVel, emberColor, 
                    Main.rand.NextFloat(0.15f, 0.3f), Main.rand.Next(40, 60), true);
                MagnumParticleHandler.SpawnParticle(risingEmber);
            }
            
            // === 6. PHASE 2: TRIUMPHANT HALO RINGS ===
            // Periodic halo rings expand outward during Phase 2
            if (phase2Started && Main.GameUpdateCount % 45 == 0)
            {
                CustomParticles.HaloRing(NPC.Center, ThemedParticles.EroicaGold * 0.6f, 0.5f + moodIntensity * 0.2f, 25);
            }
            
            // === 7. MOOD-SPECIFIC INTENSIFIERS ===
            switch (currentMood)
            {
                case Phase2Mood.DesperateValor:
                    // Intense scarlet particles - the hero's final stand
                    if (Main.rand.NextBool(2))
                    {
                        Vector2 desperatePos = NPC.Center + Main.rand.NextVector2Circular(50f, 50f);
                        CustomParticles.GenericFlare(desperatePos, ThemedParticles.EroicaScarlet, 0.4f, 10);
                    }
                    break;
                    
                case Phase2Mood.Fury:
                    // Crimson flame bursts - righteous fury
                    if (Main.rand.NextBool(4))
                    {
                        ThemedParticles.EroicaAura(NPC.Center + Main.rand.NextVector2Circular(40f, 40f), 30f);
                    }
                    break;
            }
            
            // === 8. DYNAMIC LIGHTING ===
            // Warm, pulsing light that intensifies with mood
            Vector3 lightColor = Vector3.Lerp(
                new Vector3(1f, 0.7f, 0.3f),  // Warm gold
                new Vector3(1f, 0.3f, 0.2f),  // Scarlet intensity
                moodIntensity) * pulsingGlow;
            Lighting.AddLight(NPC.Center, lightColor * (0.8f + moodIntensity * 0.4f));
        }
        
        private float GetMoodIntensity()
        {
            return currentMood switch
            {
                Phase2Mood.Triumphant => 0.3f,
                Phase2Mood.Fury => 0.6f,
                Phase2Mood.DesperateValor => 1.0f,
                _ => 0.3f
            };
        }

        #region Phase 1

        private void Phase1Hover(Player target)
        {
            // Check for flame deaths to increase speed
            int currentFlameCount = CountAliveFlames();
            if (currentFlameCount < previousFlameCount)
            {
                int flamesJustKilled = previousFlameCount - currentFlameCount;
                flamesKilledCount += flamesJustKilled;
                previousFlameCount = currentFlameCount;
            }
            
            // Calculate speed multiplier: 5% per flame killed (up to 15% at 3 flames)
            float phase1SpeedMultiplier = 1f + (flamesKilledCount * 0.05f);
            
            hoverWaveOffset += 0.04f; // Slightly faster wave
            
            // More aggressive wave motion - closer to player
            float waveX = (float)Math.Sin(hoverWaveOffset * 2.5f) * 60f;
            float waveY = (float)Math.Sin(hoverWaveOffset * 2f) * 30f;
            
            Vector2 hoverPosition = target.Center - new Vector2(-waveX, 280 + waveY); // Closer hover distance
            Vector2 direction = hoverPosition - NPC.Center;
            float distance = direction.Length();

            if (distance > 25f)
            {
                direction.Normalize();
                // Base speed 10f with multiplier, faster lerp for more aggressive following
                float baseSpeed = 10f * phase1SpeedMultiplier;
                NPC.velocity = Vector2.Lerp(NPC.velocity, direction * baseSpeed, 0.06f);
            }
            else
            {
                NPC.velocity *= 0.9f;
            }
        }

        #endregion

        #region Phase 2

        private void Phase2Transition(Player target)
        {
            NPC.velocity *= 0.9f;

            if (Timer == 1)
            {
                // Screen shake
                EroicaScreenShake.Phase2EnrageShake(NPC.Center);
                
                // Enhanced particle burst with ThemedParticles AND ENHANCED BLOOM
                EnhancedThemedParticles.EroicaBloomBurstEnhanced(NPC.Center, 3f);
                UnifiedVFXBloom.Eroica.ImpactEnhanced(NPC.Center, 3f);
                ThemedParticles.EroicaShockwave(NPC.Center, 2.5f);
                
                // DRAMATIC MUSICAL BURST - heroic clef and notes with bloom!
                ThemedParticles.EroicaMusicalImpact(NPC.Center, 2.5f, true);
                EnhancedThemedParticles.EroicaMusicNotesEnhanced(NPC.Center, 20, 80f);
                
                // Custom particles - dramatic phase transition with enhanced bloom
                CustomParticles.EroicaBossAttack(NPC.Center, 20);
                EnhancedParticles.BloomFlare(NPC.Center, new Color(200, 50, 50), 2.5f, 60, 4, 1.3f);
                EnhancedParticles.BloomFlare(NPC.Center, new Color(255, 200, 100), 2f, 50, 3, 1.1f);
                
                // Massive particle burst
                for (int i = 0; i < 60; i++)
                {
                    int dustType = Main.rand.NextBool() ? DustID.GoldFlame : DustID.CrimsonTorch;
                    Dust dust = Dust.NewDustDirect(NPC.position, NPC.width, NPC.height, dustType, 0f, 0f, 100, default, 3f);
                    dust.noGravity = true;
                    dust.velocity = Main.rand.NextVector2Circular(20f, 20f);
                }
                
                SoundEngine.PlaySound(SoundID.Roar, NPC.Center);
            }

            if (Timer == 60)
            {
                Main.NewText("All Flames have been extinguished...", 255, 150, 100);
            }

            if (Timer == 120)
            {
                Main.NewText("Eroica invokes a new crown for its melody...", 255, 200, 100);
                
                // Enhanced burst with ThemedParticles
                ThemedParticles.EroicaBloomBurst(NPC.Center, 2f);
                ThemedParticles.SakuraPetals(NPC.Center, 16, NPC.width * 0.8f);
                
                // Musical staff effect for dramatic transformation
                ThemedParticles.EroicaMusicStaff(NPC.Center, 1.5f);
                ThemedParticles.EroicaMusicNotes(NPC.Center, 12, 60f);
                
                for (int i = 0; i < 50; i++)
                {
                    int dustType = Main.rand.NextBool() ? DustID.GoldFlame : DustID.CrimsonTorch;
                    Dust dust = Dust.NewDustDirect(NPC.position, NPC.width, NPC.height, dustType, 0f, 0f, 0, default, 2.5f);
                    dust.noGravity = true;
                    dust.velocity = Main.rand.NextVector2Circular(16f, 16f);
                }
                
                EroicaScreenShake.LargeShake(NPC.Center);
            }

            if (Timer > 180)
            {
                Timer = 0;
                State = ActionState.Phase2Hover;
                NPC.netUpdate = true;
            }
        }

        private void Phase2Hover(Player target)
        {
            // === MOOD-BASED MOVEMENT SYSTEM ===
            // Movement becomes more aggressive and fluid based on current mood
            float healthPercent = (float)NPC.life / NPC.lifeMax;
            
            // Base parameters that scale with mood
            float hoverSpeed, lerpFactor, waveAmplitude, hoverDistance;
            int attackDelay;
            
            switch (currentMood)
            {
                case Phase2Mood.Triumphant: // Heroic, measured
                    hoverSpeed = 10f;
                    lerpFactor = 0.04f;
                    waveAmplitude = 60f;
                    hoverDistance = 320f;
                    attackDelay = 100; // Slower attack tempo
                    break;
                    
                case Phase2Mood.Fury: // Intense, faster
                    hoverSpeed = 14f;
                    lerpFactor = 0.07f;
                    waveAmplitude = 100f;
                    hoverDistance = 260f;
                    attackDelay = 70; // Faster attacks
                    break;
                    
                case Phase2Mood.DesperateValor: // Relentless assault
                default:
                    hoverSpeed = 18f;
                    lerpFactor = 0.10f; // Very smooth, quick corrections
                    waveAmplitude = 140f;
                    hoverDistance = 200f; // Gets in close
                    attackDelay = 50; // Rapid attacks
                    break;
            }
            
            // Smooth wave movement with mood-based amplitude
            hoverWaveOffset += 0.05f * (1f + (1f - healthPercent) * 0.3f);
            float waveX = (float)Math.Sin(hoverWaveOffset * 3f) * waveAmplitude;
            float waveY = (float)Math.Sin(hoverWaveOffset * 2f) * (waveAmplitude * 0.5f);
            
            // Calculate hover position
            Vector2 hoverPosition = target.Center - new Vector2(-waveX, hoverDistance + waveY);
            Vector2 direction = hoverPosition - NPC.Center;
            float distance = direction.Length();

            // === SMOOTH MOVEMENT INTERPOLATION (DoG-style) ===
            if (distance > 20f)
            {
                direction.Normalize();
                // Add slight speed variation for organic feel
                float speedVariation = (float)Math.Sin(hoverWaveOffset * 4f) * 2f;
                Vector2 targetVelocity = direction * (hoverSpeed + speedVariation);
                
                // Smooth lerp for fluid movement
                NPC.velocity = Vector2.Lerp(NPC.velocity, targetVelocity, lerpFactor);
            }
            else
            {
                NPC.velocity *= 0.92f;
            }
            
            // === MOOD-BASED AURA VFX ===
            SpawnMoodAura();

            // === COWARD ATTACK PRIORITY ===
            // Punish campers and players hiding below
            if (cowardAttackCooldown <= 0)
            {
                // Ground Strike - punish players below the boss
                if (playerBelowTimer >= BelowThreshold)
                {
                    SelectCowardAttack(target, "below");
                    return;
                }
                
                // Valorous Cage / Wrath - punish stationary players
                if (playerStationaryTimer >= StationaryThreshold)
                {
                    SelectCowardAttack(target, "camping");
                    return;
                }
            }

            // === MOOD-BASED ATTACK SELECTION ===
            if (Timer > attackDelay)
            {
                Timer = 0;
                chargeCount = 0;
                attackCycleCounter++;
                
                SelectMoodBasedAttack(target);
                
                NPC.netUpdate = true;
            }
        }
        
        /// <summary>
        /// Selects a coward punishment attack based on the type of cowardice detected.
        /// </summary>
        private void SelectCowardAttack(Player target, string cowardType)
        {
            Timer = 0;
            cowardAttackCooldown = 240; // 4 second cooldown between coward attacks
            
            // Warning VFX
            EroicaScreenShake.MediumShake(NPC.Center);
            SoundEngine.PlaySound(SoundID.Item45 with { Pitch = 0.3f, Volume = 1.3f }, NPC.Center);
            UnifiedVFX.Eroica.Impact(NPC.Center, 1.5f);
            
            if (cowardType == "below")
            {
                // Always use Ground Strike for below players
                State = ActionState.GroundStrikeWindup;
                playerBelowTimer = 0;
            }
            else // camping
            {
                // Choose between cage and wrath based on mood/health
                if (currentMood == Phase2Mood.DesperateValor || Main.rand.NextBool(3))
                {
                    State = ActionState.WrathOfValorWindup;
                }
                else
                {
                    State = ActionState.ValorousCageWindup;
                }
                playerStationaryTimer = 0;
            }
            
            NPC.netUpdate = true;
        }
        
        /// <summary>
        /// Updates the current mood based on health thresholds with dramatic VFX announcements.
        /// Like Devourer of Gods' phase transitions but with heroic theming.
        /// </summary>
        private void UpdatePhase2Mood(Player target)
        {
            float healthPercent = (float)NPC.life / NPC.lifeMax;
            
            // Transition to Fury at 60% HP
            if (healthPercent <= 0.6f && !hasAnnouncedFury)
            {
                hasAnnouncedFury = true;
                currentMood = Phase2Mood.Fury;
                
                // Dramatic transition VFX
                AnnounceMoodTransition("Fury", target);
            }
            // Transition to Desperate Valor at 30% HP
            else if (healthPercent <= 0.3f && !hasAnnouncedDesperate)
            {
                hasAnnouncedDesperate = true;
                currentMood = Phase2Mood.DesperateValor;
                
                // Even more dramatic transition
                AnnounceMoodTransition("DesperateValor", target);
            }
        }
        
        /// <summary>
        /// Creates dramatic VFX announcement when transitioning between moods.
        /// </summary>
        private void AnnounceMoodTransition(string moodName, Player target)
        {
            // Screen shake
            if (target.active)
            {
                MagnumScreenEffects.AddScreenShake(moodName == "DesperateValor" ? 20f : 12f);
            }
            
            // Sound cue
            SoundEngine.PlaySound(SoundID.Roar with { Pitch = moodName == "DesperateValor" ? 0.3f : 0f, Volume = 1.2f }, NPC.Center);
            
            // Massive VFX burst
            UnifiedVFX.Eroica.DeathExplosion(NPC.Center, moodName == "DesperateValor" ? 2.5f : 1.8f);
            
            // Sakura petal storm
            ThemedParticles.SakuraPetals(NPC.Center, moodName == "DesperateValor" ? 40 : 25, 150f);
            
            // Expanding halo rings
            for (int ring = 0; ring < 6; ring++)
            {
                float progress = ring / 6f;
                Color ringColor = Color.Lerp(UnifiedVFX.Eroica.Scarlet, UnifiedVFX.Eroica.Gold, progress);
                CustomParticles.HaloRing(NPC.Center, ringColor, 0.5f + ring * 0.3f, 25 + ring * 5);
            }
            
            // Fractal star burst
            int starPoints = moodName == "DesperateValor" ? 12 : 8;
            for (int i = 0; i < starPoints; i++)
            {
                float angle = MathHelper.TwoPi * i / starPoints;
                Vector2 offset = angle.ToRotationVector2() * 60f;
                Color starColor = Color.Lerp(UnifiedVFX.Eroica.Scarlet, UnifiedVFX.Eroica.Gold, (float)i / starPoints);
                CustomParticles.GenericFlare(NPC.Center + offset, starColor, 0.7f, 30);
            }
            
            // Text announcement (Combat Text)
            if (Main.netMode != NetmodeID.Server)
            {
                string text = moodName == "DesperateValor" ? "DESPERATE VALOR!" : "THE HERO'S FURY!";
                Color textColor = moodName == "DesperateValor" ? UnifiedVFX.Eroica.Gold : UnifiedVFX.Eroica.Crimson;
                CombatText.NewText(NPC.Hitbox, textColor, text, true);
            }
        }
        
        /// <summary>
        /// Spawns mood-specific aura particles.
        /// </summary>
        private void SpawnMoodAura()
        {
            if (Timer % 8 != 0) return;
            
            float pulse = (float)Math.Sin(auraPulse * 2f) * 0.5f + 0.5f;
            
            // Particle count and intensity based on mood
            int particleCount = currentMood switch
            {
                Phase2Mood.Triumphant => 3,
                Phase2Mood.Fury => 5,
                Phase2Mood.DesperateValor => 8,
                _ => 3
            };
            
            for (int i = 0; i < particleCount; i++)
            {
                Color auraColor = currentMood switch
                {
                    Phase2Mood.Triumphant => Color.Lerp(UnifiedVFX.Eroica.Gold, UnifiedVFX.Eroica.Crimson, Main.rand.NextFloat()),
                    Phase2Mood.Fury => Color.Lerp(UnifiedVFX.Eroica.Crimson, UnifiedVFX.Eroica.Scarlet, Main.rand.NextFloat()),
                    Phase2Mood.DesperateValor => Color.Lerp(UnifiedVFX.Eroica.Scarlet, Color.White, Main.rand.NextFloat() * 0.4f),
                    _ => UnifiedVFX.Eroica.Gold
                };
                
                Vector2 offset = Main.rand.NextVector2Circular(NPC.width * 0.6f, NPC.height * 0.6f);
                float scale = (1.5f + pulse) * (currentMood == Phase2Mood.DesperateValor ? 1.3f : 1f);
                
                CustomParticles.GenericFlare(NPC.Center + offset, auraColor, 0.3f * scale, 15);
            }
            
            // Extra sakura petals in Desperate Valor
            if (currentMood == Phase2Mood.DesperateValor && Timer % 16 == 0)
            {
                ThemedParticles.SakuraPetals(NPC.Center, 2, 80f);
            }
        }
        
        /// <summary>
        /// REDESIGNED: Selects attacks from the new challenging attack suite.
        /// Each mood unlocks more dangerous attacks with faster tempo.
        /// </summary>
        private void SelectMoodBasedAttack(Player target)
        {
            attackCycleCounter++;
            int attackRoll = Main.rand.Next(100);
            
            // Prevent same attack twice in a row
            ActionState selectedAttack = ActionState.Phase2Hover;
            
            switch (currentMood)
            {
                case Phase2Mood.Triumphant:
                    // 100-60% HP: Core attacks, clear telegraphs
                    if (attackRoll < 25)
                    {
                        selectedAttack = ActionState.HeroicChainDashWindup;
                        chainDashCount = 0;
                        maxChainDashes = 2; // Only 2 dashes in Triumphant
                    }
                    else if (attackRoll < 50)
                    {
                        selectedAttack = ActionState.ValorSpiralWindup;
                        spiralWaveCount = 0;
                    }
                    else if (attackRoll < 70)
                    {
                        selectedAttack = ActionState.PetalStormWallWindup;
                        petalWallsFired = 0;
                    }
                    else if (attackRoll < 90)
                    {
                        selectedAttack = ActionState.MeteorStormWindup;
                        meteorsSpawned = 0;
                        meteorTargets.Clear();
                    }
                    else
                    {
                        selectedAttack = ActionState.BeamSweepWindup;
                        beamCount = 2;
                    }
                    break;
                    
                case Phase2Mood.Fury:
                    // 60-30% HP: More attacks, faster pace, combos
                    if (attackRoll < 15)
                    {
                        selectedAttack = ActionState.HeroicChainDashWindup;
                        chainDashCount = 0;
                        maxChainDashes = 3; // 3 dashes now
                    }
                    else if (attackRoll < 30)
                    {
                        selectedAttack = ActionState.PhoenixRebirthWindup;
                        phoenixTeleported = false;
                    }
                    else if (attackRoll < 45)
                    {
                        selectedAttack = ActionState.ValorSpiralWindup;
                        spiralWaveCount = 0;
                    }
                    else if (attackRoll < 55)
                    {
                        selectedAttack = ActionState.PetalStormWallWindup;
                        petalWallsFired = 0;
                    }
                    else if (attackRoll < 70)
                    {
                        selectedAttack = ActionState.BannerRallyWindup;
                        bannersPlanted = 0;
                        bannerPositions.Clear();
                    }
                    else if (attackRoll < 85)
                    {
                        selectedAttack = ActionState.MeteorStormWindup;
                        meteorsSpawned = 0;
                        meteorTargets.Clear();
                    }
                    else
                    {
                        selectedAttack = ActionState.BeamSweepWindup;
                        beamCount = 3;
                    }
                    break;
                    
                case Phase2Mood.DesperateValor:
                    // 30-0% HP: Maximum intensity, all attacks, rapid combos
                    if (attackRoll < 12)
                    {
                        selectedAttack = ActionState.HeroicChainDashWindup;
                        chainDashCount = 0;
                        maxChainDashes = 4; // 4 rapid dashes!
                    }
                    else if (attackRoll < 24)
                    {
                        selectedAttack = ActionState.PhoenixRebirthWindup;
                        phoenixTeleported = false;
                    }
                    else if (attackRoll < 36)
                    {
                        selectedAttack = ActionState.ValorVortexWindup;
                        vortexStrength = 0f;
                    }
                    else if (attackRoll < 48)
                    {
                        selectedAttack = ActionState.PetalStormWallWindup;
                        petalWallsFired = 0;
                    }
                    else if (attackRoll < 58)
                    {
                        selectedAttack = ActionState.ComboFinisherWindup;
                        comboAttackIndex = 0;
                        comboAttacksRemaining = 3;
                    }
                    else if (attackRoll < 70)
                    {
                        selectedAttack = ActionState.MeteorStormWindup;
                        meteorsSpawned = 0;
                        meteorTargets.Clear();
                    }
                    else if (attackRoll < 82)
                    {
                        selectedAttack = ActionState.BeamSweepWindup;
                        beamCount = 4;
                    }
                    else
                    {
                        selectedAttack = ActionState.BannerRallyWindup;
                        bannersPlanted = 0;
                        bannerPositions.Clear();
                    }
                    break;
            }
            
            State = selectedAttack;
        }

        #endregion

        #region NEW ATTACK IMPLEMENTATIONS - Challenging Combat

        // ========================================
        // ATTACK 1: HEROIC CHAIN DASH
        // Multi-dash combo with increasing speed
        // Player must track direction changes
        // ========================================
        
        private void HeroicChainDashWindup(Player target)
        {
            int windupTime = currentMood == Phase2Mood.DesperateValor ? 25 : 35;
            
            NPC.velocity *= 0.9f;
            
            if (Timer == 1)
            {
                SoundEngine.PlaySound(SoundID.Item15 with { Pitch = 0.2f }, NPC.Center);
                
                // Pre-calculate all dash directions with variety
                for (int i = 0; i <= maxChainDashes; i++)
                {
                    float angleOffset = (i % 2 == 0 ? 1 : -1) * MathHelper.ToRadians(30 + i * 15);
                    Vector2 baseDir = (target.Center - NPC.Center).SafeNormalize(Vector2.UnitY);
                    chainDashDirections[i] = baseDir.RotatedBy(angleOffset);
                }
            }
            
            // Telegraph current dash direction
            if (Timer >= 10)
            {
                Vector2 telegraphEnd = NPC.Center + chainDashDirections[chainDashCount] * 400f;
                
                // Draw telegraph line
                for (int i = 0; i < 20; i++)
                {
                    float progress = i / 20f;
                    Vector2 linePos = Vector2.Lerp(NPC.Center, telegraphEnd, progress);
                    Color lineColor = Color.Lerp(UnifiedVFX.Eroica.Gold, UnifiedVFX.Eroica.Scarlet, progress) * 0.6f;
                    CustomParticles.GenericFlare(linePos, lineColor, 0.2f, 3);
                }
            }
            
            // Gathering energy VFX
            if (Timer % 4 == 0)
            {
                float intensity = Timer / (float)windupTime;
                for (int i = 0; i < 4; i++)
                {
                    Vector2 offset = Main.rand.NextVector2CircularEdge(60f, 60f) * (1f - intensity);
                    CustomParticles.GenericFlare(NPC.Center + offset, UnifiedVFX.Eroica.Gold, 0.35f * intensity, 12);
                }
            }
            
            if (Timer >= windupTime)
            {
                Timer = 0;
                State = ActionState.HeroicChainDashExecute;
                chainDashSpeed = currentMood == Phase2Mood.DesperateValor ? 35f : 28f;
                NPC.netUpdate = true;
            }
        }
        
        private void HeroicChainDashExecute(Player target)
        {
            int dashDuration = 18;
            
            if (Timer == 1)
            {
                // Execute dash
                NPC.velocity = chainDashDirections[chainDashCount] * chainDashSpeed;
                SoundEngine.PlaySound(SoundID.Item71 with { Pitch = 0.3f + chainDashCount * 0.1f }, NPC.Center);
                
                // Dash VFX
                UnifiedVFX.Eroica.Impact(NPC.Center, 1.2f);
                ThemedParticles.SakuraPetals(NPC.Center, 6, 40f);
                
                // Spawn trail projectiles during dash
                if (currentMood != Phase2Mood.Triumphant && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    Vector2 perpendicular = chainDashDirections[chainDashCount].RotatedBy(MathHelper.PiOver2);
                    for (int side = -1; side <= 1; side += 2)
                    {
                        Vector2 spawnPos = NPC.Center + perpendicular * side * 30f;
                        Projectile.NewProjectile(NPC.GetSource_FromAI(), spawnPos, 
                            perpendicular * side * 4f, ModContent.ProjectileType<EnergyOfEroica>(), 80, 2f);
                    }
                }
            }
            
            // Trail particles
            if (Timer % 2 == 0)
            {
                for (int i = 0; i < 3; i++)
                {
                    Vector2 trailOffset = Main.rand.NextVector2Circular(20f, 20f);
                    Color trailColor = Color.Lerp(UnifiedVFX.Eroica.Scarlet, UnifiedVFX.Eroica.Gold, Main.rand.NextFloat());
                    CustomParticles.GenericFlare(NPC.Center + trailOffset - NPC.velocity * 0.5f, trailColor, 0.4f, 10);
                }
                ThemedParticles.EroicaSparks(NPC.Center, -NPC.velocity, 2, 3f);
            }
            
            if (Timer >= dashDuration)
            {
                Timer = 0;
                chainDashCount++;
                
                if (chainDashCount < maxChainDashes)
                {
                    // Quick recovery between dashes
                    State = ActionState.HeroicChainDashRecovery;
                }
                else
                {
                    // All dashes complete
                    State = ActionState.Phase2Hover;
                }
                NPC.netUpdate = true;
            }
        }
        
        private void HeroicChainDashRecovery(Player target)
        {
            int recoveryTime = currentMood == Phase2Mood.DesperateValor ? 12 : 20;
            
            NPC.velocity *= 0.85f;
            
            // Quick retarget
            if (Timer == 5)
            {
                Vector2 newDir = (target.Center - NPC.Center).SafeNormalize(Vector2.UnitY);
                float angleVariation = MathHelper.ToRadians(Main.rand.NextFloat(-40f, 40f));
                chainDashDirections[chainDashCount] = newDir.RotatedBy(angleVariation);
            }
            
            // Telegraph next dash
            if (Timer >= 8)
            {
                Vector2 telegraphEnd = NPC.Center + chainDashDirections[chainDashCount] * 350f;
                for (int i = 0; i < 15; i++)
                {
                    float progress = i / 15f;
                    Vector2 linePos = Vector2.Lerp(NPC.Center, telegraphEnd, progress);
                    CustomParticles.GenericFlare(linePos, UnifiedVFX.Eroica.Crimson * 0.7f, 0.15f, 2);
                }
            }
            
            if (Timer >= recoveryTime)
            {
                Timer = 0;
                State = ActionState.HeroicChainDashExecute;
                NPC.netUpdate = true;
            }
        }

        // ========================================
        // ATTACK 2: VALOR SPIRAL BARRAGE
        // Spiral projectile pattern that expands
        // Creates walls of projectiles to navigate
        // ========================================
        
        private void ValorSpiralWindup(Player target)
        {
            const int WindupTime = 40;
            
            NPC.velocity *= 0.92f;
            
            if (Timer == 1)
            {
                SoundEngine.PlaySound(SoundID.Item29 with { Pitch = -0.3f }, NPC.Center);
                spiralAngle = (target.Center - NPC.Center).ToRotation();
            }
            
            // Spinning energy gathering
            if (Timer % 3 == 0)
            {
                float chargeIntensity = Timer / (float)WindupTime;
                int particleCount = 6 + (int)(chargeIntensity * 6);
                
                for (int i = 0; i < particleCount; i++)
                {
                    float angle = spiralAngle + MathHelper.TwoPi * i / particleCount + Timer * 0.1f;
                    float radius = 80f * (1f - chargeIntensity * 0.5f);
                    Vector2 pos = NPC.Center + angle.ToRotationVector2() * radius;
                    Color spiralColor = Color.Lerp(UnifiedVFX.Eroica.Gold, UnifiedVFX.Eroica.Scarlet, chargeIntensity);
                    CustomParticles.GenericFlare(pos, spiralColor, 0.3f + chargeIntensity * 0.2f, 8);
                }
            }
            
            if (Timer >= WindupTime)
            {
                Timer = 0;
                State = ActionState.ValorSpiralFiring;
                NPC.netUpdate = true;
            }
        }
        
        private void ValorSpiralFiring(Player target)
        {
            int waveDelay = currentMood == Phase2Mood.DesperateValor ? 15 : 22;
            int projectilesPerWave = currentMood == Phase2Mood.DesperateValor ? 16 : 12;
            int maxWaves = currentMood == Phase2Mood.DesperateValor ? 5 : MaxSpiralWaves;
            
            NPC.velocity *= 0.95f;
            
            // Fire spiral waves
            if (Timer % waveDelay == 1 && spiralWaveCount < maxWaves)
            {
                if (Main.netMode != NetmodeID.MultiplayerClient)
                {
                    float waveAngleOffset = spiralWaveCount * MathHelper.ToRadians(25);
                    
                    for (int i = 0; i < projectilesPerWave; i++)
                    {
                        float angle = spiralAngle + MathHelper.TwoPi * i / projectilesPerWave + waveAngleOffset;
                        Vector2 velocity = angle.ToRotationVector2() * (8f + spiralWaveCount * 1.5f);
                        
                        Projectile.NewProjectile(NPC.GetSource_FromAI(), NPC.Center, velocity,
                            ModContent.ProjectileType<EnergyOfEroica>(), 85, 3f);
                    }
                }
                
                SoundEngine.PlaySound(SoundID.Item12 with { Pitch = spiralWaveCount * 0.1f }, NPC.Center);
                UnifiedVFX.Eroica.Impact(NPC.Center, 0.8f + spiralWaveCount * 0.2f);
                spiralWaveCount++;
            }
            
            // Spinning visual
            spiralAngle += 0.05f;
            
            if (spiralWaveCount >= maxWaves && Timer > waveDelay * maxWaves + 30)
            {
                Timer = 0;
                State = ActionState.Phase2Hover;
                NPC.netUpdate = true;
            }
        }

        // ========================================
        // ATTACK 3: PHOENIX REBIRTH STRIKE  
        // Teleport to player + explosive arrival + instant dash
        // Very dangerous, requires quick reactions
        // ========================================
        
        private void PhoenixRebirthWindup(Player target)
        {
            const int WindupTime = 50;
            
            NPC.velocity *= 0.9f;
            
            if (Timer == 1)
            {
                // Calculate teleport destination - behind player
                float teleportAngle = (NPC.Center - target.Center).ToRotation();
                phoenixTargetPos = target.Center + teleportAngle.ToRotationVector2() * 250f;
                
                SoundEngine.PlaySound(SoundID.Item8 with { Pitch = -0.5f }, NPC.Center);
            }
            
            // Fading out VFX
            float fadeProgress = Timer / (float)WindupTime;
            NPC.alpha = (int)(fadeProgress * 200);
            
            // Fire particles rising
            if (Timer % 4 == 0)
            {
                for (int i = 0; i < 5; i++)
                {
                    Vector2 risePos = NPC.Center + Main.rand.NextVector2Circular(40f, 40f);
                    Vector2 riseVel = new Vector2(0, -3f - fadeProgress * 4f);
                    Color riseColor = Color.Lerp(UnifiedVFX.Eroica.Scarlet, UnifiedVFX.Eroica.Gold, fadeProgress);
                    CustomParticles.GenericFlare(risePos, riseColor, 0.35f, 15);
                }
            }
            
            // Destination warning
            if (Timer >= 25)
            {
                // Telegraph at destination
                for (int i = 0; i < 8; i++)
                {
                    float angle = MathHelper.TwoPi * i / 8f + Timer * 0.1f;
                    Vector2 warnPos = phoenixTargetPos + angle.ToRotationVector2() * 50f;
                    CustomParticles.GenericFlare(warnPos, UnifiedVFX.Eroica.Scarlet * 0.6f, 0.25f, 4);
                }
            }
            
            if (Timer >= WindupTime)
            {
                Timer = 0;
                State = ActionState.PhoenixRebirthTeleport;
                NPC.netUpdate = true;
            }
        }
        
        private void PhoenixRebirthTeleport(Player target)
        {
            if (Timer == 1)
            {
                // Departure explosion
                UnifiedVFX.Eroica.Explosion(NPC.Center, 1.5f);
                ThemedParticles.SakuraPetals(NPC.Center, 15, 80f);
                
                // Teleport!
                NPC.Center = phoenixTargetPos;
                NPC.alpha = 255;
                phoenixTeleported = true;
                
                SoundEngine.PlaySound(SoundID.Item8 with { Pitch = 0.5f }, NPC.Center);
            }
            
            // Rapid fade in
            NPC.alpha = Math.Max(0, NPC.alpha - 25);
            
            // Arrival explosion building
            if (Timer % 2 == 0 && NPC.alpha > 50)
            {
                float intensity = 1f - NPC.alpha / 255f;
                for (int i = 0; i < 6; i++)
                {
                    float angle = MathHelper.TwoPi * i / 6f;
                    Vector2 burstPos = NPC.Center + angle.ToRotationVector2() * (60f * intensity);
                    CustomParticles.GenericFlare(burstPos, UnifiedVFX.Eroica.Gold, 0.4f * intensity, 8);
                }
            }
            
            if (Timer >= 20)
            {
                Timer = 0;
                NPC.alpha = 0;
                State = ActionState.PhoenixRebirthStrike;
                
                // Calculate dash direction toward player
                chainDashDirections[0] = (target.Center - NPC.Center).SafeNormalize(Vector2.UnitY);
                
                NPC.netUpdate = true;
            }
        }
        
        private void PhoenixRebirthStrike(Player target)
        {
            if (Timer == 1)
            {
                // Massive arrival explosion
                UnifiedVFX.Eroica.DeathExplosion(NPC.Center, 1.8f);
                ThemedParticles.EroicaShockwave(NPC.Center, 2f);
                MagnumScreenEffects.AddScreenShake(10f);
                
                // Instant dash toward player
                NPC.velocity = chainDashDirections[0] * 32f;
                
                SoundEngine.PlaySound(SoundID.Item74, NPC.Center);
                
                // Spawn explosion projectiles in all directions
                if (Main.netMode != NetmodeID.MultiplayerClient)
                {
                    for (int i = 0; i < 12; i++)
                    {
                        float angle = MathHelper.TwoPi * i / 12f;
                        Vector2 vel = angle.ToRotationVector2() * 6f;
                        Projectile.NewProjectile(NPC.GetSource_FromAI(), NPC.Center, vel,
                            ModContent.ProjectileType<EnergyOfEroica>(), 90, 3f);
                    }
                }
            }
            
            // Trail during dash
            if (Timer % 2 == 0)
            {
                ThemedParticles.SakuraPetals(NPC.Center, 3, 30f);
                CustomParticles.GenericFlare(NPC.Center, UnifiedVFX.Eroica.Scarlet, 0.5f, 8);
            }
            
            // Slow down
            NPC.velocity *= 0.94f;
            
            if (Timer >= 35)
            {
                Timer = 0;
                State = ActionState.Phase2Hover;
                NPC.netUpdate = true;
            }
        }

        // ========================================
        // ATTACK 4: PETAL STORM WALL
        // DoG-style projectile walls made of sakura
        // Must find gaps to survive
        // ========================================
        
        private void PetalStormWallWindup(Player target)
        {
            const int WindupTime = 45;
            
            NPC.velocity *= 0.9f;
            
            if (Timer == 1)
            {
                // Random starting angle for wall
                petalWallAngle = Main.rand.NextFloat(MathHelper.TwoPi);
                SoundEngine.PlaySound(SoundID.Item29 with { Pitch = 0.2f }, NPC.Center);
            }
            
            // Gathering petals VFX
            float chargeProgress = Timer / (float)WindupTime;
            if (Timer % 5 == 0)
            {
                ThemedParticles.SakuraPetals(NPC.Center, (int)(3 + chargeProgress * 5), 100f * (1f - chargeProgress * 0.5f));
            }
            
            // Pulsing energy
            if (Timer % 8 == 0)
            {
                CustomParticles.HaloRing(NPC.Center, UnifiedVFX.Eroica.Sakura * chargeProgress, 0.3f + chargeProgress * 0.3f, 15);
            }
            
            if (Timer >= WindupTime)
            {
                Timer = 0;
                State = ActionState.PetalStormWallFiring;
                NPC.netUpdate = true;
            }
        }
        
        private void PetalStormWallFiring(Player target)
        {
            int wallDelay = currentMood == Phase2Mood.DesperateValor ? 35 : 50;
            int projectilesPerWall = 28;
            float wallSpacing = 45f;
            int maxWalls = currentMood == Phase2Mood.DesperateValor ? 4 : MaxPetalWalls;
            
            // Maintain position above player
            Vector2 hoverTarget = target.Center - new Vector2(0, 300);
            NPC.velocity = (hoverTarget - NPC.Center) * 0.03f;
            
            // Fire walls
            if (Timer % wallDelay == 1 && petalWallsFired < maxWalls)
            {
                if (Main.netMode != NetmodeID.MultiplayerClient)
                {
                    // Wall spawns from side, moves across screen
                    float wallAngle = petalWallAngle + petalWallsFired * MathHelper.ToRadians(45);
                    Vector2 wallDirection = wallAngle.ToRotationVector2();
                    Vector2 wallPerpendicular = wallDirection.RotatedBy(MathHelper.PiOver2);
                    
                    // Spawn point far from player on one side
                    Vector2 wallStart = target.Center + wallDirection * 800f;
                    Vector2 wallVelocity = -wallDirection * 12f;
                    
                    // Create wall with gap
                    int gapStart = Main.rand.Next(8, projectilesPerWall - 8);
                    int gapSize = currentMood == Phase2Mood.DesperateValor ? 4 : 6;
                    
                    for (int i = 0; i < projectilesPerWall; i++)
                    {
                        // Skip gap positions
                        if (i >= gapStart && i < gapStart + gapSize) continue;
                        
                        float offset = (i - projectilesPerWall / 2f) * wallSpacing;
                        Vector2 spawnPos = wallStart + wallPerpendicular * offset;
                        
                        Projectile.NewProjectile(NPC.GetSource_FromAI(), spawnPos, wallVelocity,
                            ModContent.ProjectileType<EnergyOfEroica>(), 75, 2f);
                    }
                }
                
                SoundEngine.PlaySound(SoundID.Item68 with { Volume = 0.8f }, NPC.Center);
                petalWallsFired++;
            }
            
            // Ambient petals
            if (Timer % 10 == 0)
            {
                ThemedParticles.SakuraPetals(NPC.Center, 4, 60f);
            }
            
            if (petalWallsFired >= maxWalls && Timer > wallDelay * maxWalls + 60)
            {
                Timer = 0;
                State = ActionState.Phase2Hover;
                NPC.netUpdate = true;
            }
        }

        // ========================================
        // ATTACK 5: BANNER RALLY
        // Plants banners that create damaging zones
        // Forces player to keep moving
        // ========================================
        
        private void BannerRallyWindup(Player target)
        {
            const int WindupTime = 35;
            
            NPC.velocity *= 0.92f;
            
            if (Timer == 1)
            {
                SoundEngine.PlaySound(SoundID.Item4 with { Pitch = 0.1f }, NPC.Center);
            }
            
            // Rally cry VFX
            if (Timer % 6 == 0)
            {
                float progress = Timer / (float)WindupTime;
                for (int i = 0; i < 8; i++)
                {
                    float angle = MathHelper.TwoPi * i / 8f;
                    Vector2 pos = NPC.Center + angle.ToRotationVector2() * (40f + progress * 30f);
                    CustomParticles.GenericFlare(pos, UnifiedVFX.Eroica.Gold, 0.35f, 12);
                }
            }
            
            if (Timer >= WindupTime)
            {
                Timer = 0;
                State = ActionState.BannerRallyPlanting;
                NPC.netUpdate = true;
            }
        }
        
        private void BannerRallyPlanting(Player target)
        {
            int plantDelay = 25;
            int maxBannersToPlant = currentMood == Phase2Mood.DesperateValor ? 5 : MaxBanners;
            
            // Move aggressively toward player
            Vector2 toPlayer = (target.Center - NPC.Center).SafeNormalize(Vector2.Zero);
            NPC.velocity = Vector2.Lerp(NPC.velocity, toPlayer * 14f, 0.08f);
            
            // Plant banners around the arena
            if (Timer % plantDelay == 1 && bannersPlanted < maxBannersToPlant)
            {
                // Plant at current position
                Vector2 bannerPos = NPC.Center;
                bannerPositions.Add(bannerPos);
                
                // Spawn banner projectile (damaging zone)
                if (Main.netMode != NetmodeID.MultiplayerClient)
                {
                    Projectile.NewProjectile(NPC.GetSource_FromAI(), bannerPos, Vector2.Zero,
                        ModContent.ProjectileType<HandOfValor>(), 60, 0f, Main.myPlayer, 0, 300); // 300 frame lifetime
                }
                
                // Plant VFX
                UnifiedVFX.Eroica.Impact(bannerPos, 1f);
                ThemedParticles.EroicaMusicNotes(bannerPos, 6, 40f);
                SoundEngine.PlaySound(SoundID.Item100, bannerPos);
                
                bannersPlanted++;
            }
            
            // Trail
            if (Timer % 4 == 0)
            {
                ThemedParticles.EroicaSparks(NPC.Center, -NPC.velocity, 3, 2f);
            }
            
            if (bannersPlanted >= maxBannersToPlant && Timer > plantDelay * maxBannersToPlant + 20)
            {
                Timer = 0;
                State = ActionState.Phase2Hover;
                NPC.netUpdate = true;
            }
        }

        // ========================================
        // ATTACK 6: TRIUMPHANT BEAM SWEEP
        // Rotating laser beams with gaps
        // Must track rotation and find safe spots
        // ========================================
        
        private void BeamSweepWindup(Player target)
        {
            const int WindupTime = 55;
            
            NPC.velocity *= 0.9f;
            
            if (Timer == 1)
            {
                beamSweepAngle = Main.rand.NextFloat(MathHelper.TwoPi);
                beamSweepDirection = Main.rand.NextBool() ? 1f : -1f;
                SoundEngine.PlaySound(SoundID.Item15 with { Pitch = -0.4f, Volume = 1.2f }, NPC.Center);
            }
            
            // Beam charging telegraph
            float chargeProgress = Timer / (float)WindupTime;
            
            if (Timer >= 20)
            {
                // Show where beams will be
                for (int beam = 0; beam < beamCount; beam++)
                {
                    float beamAngle = beamSweepAngle + MathHelper.TwoPi * beam / beamCount;
                    
                    for (int i = 0; i < 30; i++)
                    {
                        float dist = i * 40f;
                        Vector2 telegraphPos = NPC.Center + beamAngle.ToRotationVector2() * dist;
                        Color telegraphColor = UnifiedVFX.Eroica.Scarlet * chargeProgress * 0.4f;
                        CustomParticles.GenericFlare(telegraphPos, telegraphColor, 0.15f, 3);
                    }
                }
            }
            
            // Central charging
            if (Timer % 4 == 0)
            {
                CustomParticles.HaloRing(NPC.Center, UnifiedVFX.Eroica.Gold * chargeProgress, 0.3f + chargeProgress * 0.4f, 12);
            }
            
            if (Timer >= WindupTime)
            {
                Timer = 0;
                State = ActionState.BeamSweepFiring;
                NPC.netUpdate = true;
            }
        }
        
        private void BeamSweepFiring(Player target)
        {
            int sweepDuration = currentMood == Phase2Mood.DesperateValor ? 180 : 140;
            float rotationSpeed = currentMood == Phase2Mood.DesperateValor ? 0.025f : 0.018f;
            
            NPC.velocity *= 0.95f;
            
            // Rotate beams
            beamSweepAngle += rotationSpeed * beamSweepDirection;
            
            // Fire beam projectiles
            if (Timer % 3 == 0)
            {
                if (Main.netMode != NetmodeID.MultiplayerClient)
                {
                    for (int beam = 0; beam < beamCount; beam++)
                    {
                        float beamAngle = beamSweepAngle + MathHelper.TwoPi * beam / beamCount;
                        Vector2 beamVel = beamAngle.ToRotationVector2() * 18f;
                        
                        Projectile.NewProjectile(NPC.GetSource_FromAI(), NPC.Center, beamVel,
                            ModContent.ProjectileType<EnergyOfEroica>(), 70, 2f);
                    }
                }
            }
            
            // Beam visual
            for (int beam = 0; beam < beamCount; beam++)
            {
                float beamAngle = beamSweepAngle + MathHelper.TwoPi * beam / beamCount;
                
                for (int i = 0; i < 15; i++)
                {
                    float dist = i * 50f;
                    Vector2 beamPos = NPC.Center + beamAngle.ToRotationVector2() * dist;
                    Color beamColor = Color.Lerp(UnifiedVFX.Eroica.Scarlet, UnifiedVFX.Eroica.Gold, (float)i / 15f);
                    CustomParticles.GenericFlare(beamPos, beamColor, 0.35f, 4);
                }
            }
            
            // Central glow
            if (Timer % 8 == 0)
            {
                CustomParticles.GenericFlare(NPC.Center, UnifiedVFX.Eroica.Gold, 0.6f, 10);
            }
            
            // Sound pulses
            if (Timer % 20 == 0)
            {
                SoundEngine.PlaySound(SoundID.Item12 with { Pitch = -0.2f, Volume = 0.6f }, NPC.Center);
            }
            
            if (Timer >= sweepDuration)
            {
                Timer = 0;
                State = ActionState.Phase2Hover;
                NPC.netUpdate = true;
            }
        }

        // ========================================
        // ATTACK 7: SAKURA METEOR STORM
        // Rains projectiles from above
        // Telegraphed positions, must dodge
        // ========================================
        
        private void MeteorStormWindup(Player target)
        {
            const int WindupTime = 60;
            
            NPC.velocity *= 0.92f;
            
            if (Timer == 1)
            {
                SoundEngine.PlaySound(SoundID.Item29 with { Pitch = 0.4f }, NPC.Center);
                meteorTargets.Clear();
                
                // Pre-calculate meteor positions
                int meteorCount = currentMood == Phase2Mood.DesperateValor ? 30 : MaxMeteors;
                for (int i = 0; i < meteorCount; i++)
                {
                    Vector2 targetPos = target.Center + Main.rand.NextVector2Circular(400f, 200f);
                    targetPos.Y = target.Center.Y + Main.rand.NextFloat(-50f, 150f);
                    meteorTargets.Add(targetPos);
                }
            }
            
            // Telegraph meteor landing positions
            if (Timer >= 25)
            {
                float telegraphIntensity = (Timer - 25f) / (WindupTime - 25f);
                foreach (var pos in meteorTargets)
                {
                    if (Main.rand.NextFloat() < telegraphIntensity * 0.3f)
                    {
                        CustomParticles.GenericFlare(pos, UnifiedVFX.Eroica.Scarlet * 0.5f, 0.2f, 6);
                    }
                }
            }
            
            // Rising energy
            if (Timer % 6 == 0)
            {
                ThemedParticles.SakuraPetals(NPC.Center, 3, 80f);
                for (int i = 0; i < 4; i++)
                {
                    Vector2 risePos = NPC.Center + Main.rand.NextVector2Circular(60f, 60f);
                    CustomParticles.GenericFlare(risePos, UnifiedVFX.Eroica.Gold, 0.3f, 15);
                }
            }
            
            if (Timer >= WindupTime)
            {
                Timer = 0;
                meteorsSpawned = 0;
                State = ActionState.MeteorStormRaining;
                NPC.netUpdate = true;
            }
        }
        
        private void MeteorStormRaining(Player target)
        {
            int rainDuration = currentMood == Phase2Mood.DesperateValor ? 150 : 120;
            int meteorsPerWave = currentMood == Phase2Mood.DesperateValor ? 4 : 3;
            int waveInterval = 8;
            
            // Hover above player
            Vector2 hoverTarget = target.Center - new Vector2(0, 350);
            NPC.velocity = (hoverTarget - NPC.Center) * 0.04f;
            
            // Spawn meteors
            if (Timer % waveInterval == 0 && meteorsSpawned < meteorTargets.Count)
            {
                if (Main.netMode != NetmodeID.MultiplayerClient)
                {
                    for (int i = 0; i < meteorsPerWave && meteorsSpawned < meteorTargets.Count; i++)
                    {
                        Vector2 targetPos = meteorTargets[meteorsSpawned];
                        Vector2 spawnPos = targetPos - new Vector2(0, 600f);
                        Vector2 velocity = new Vector2(0, 14f);
                        
                        Projectile.NewProjectile(NPC.GetSource_FromAI(), spawnPos, velocity,
                            ModContent.ProjectileType<EnergyOfEroica>(), 85, 3f);
                        
                        meteorsSpawned++;
                    }
                }
                
                SoundEngine.PlaySound(SoundID.Item20 with { Volume = 0.5f }, NPC.Center);
            }
            
            // Warning flashes at landing zones
            if (Timer % 4 == 0)
            {
                for (int i = meteorsSpawned; i < Math.Min(meteorsSpawned + 6, meteorTargets.Count); i++)
                {
                    Vector2 warnPos = meteorTargets[i];
                    CustomParticles.GenericFlare(warnPos, UnifiedVFX.Eroica.Scarlet * 0.6f, 0.25f, 5);
                }
            }
            
            // Ambient
            if (Timer % 15 == 0)
            {
                ThemedParticles.SakuraPetals(NPC.Center, 2, 50f);
            }
            
            if (Timer >= rainDuration || meteorsSpawned >= meteorTargets.Count)
            {
                Timer = 0;
                State = ActionState.Phase2Hover;
                NPC.netUpdate = true;
            }
        }

        // ========================================
        // ATTACK 8: VALOR VORTEX
        // Pulls player toward boss while firing
        // Must fight against pull while dodging
        // ========================================
        
        private void ValorVortexWindup(Player target)
        {
            const int WindupTime = 50;
            
            NPC.velocity *= 0.9f;
            
            if (Timer == 1)
            {
                SoundEngine.PlaySound(SoundID.Item15 with { Pitch = -0.6f }, NPC.Center);
            }
            
            // Vortex forming
            float formProgress = Timer / (float)WindupTime;
            
            if (Timer % 3 == 0)
            {
                int spiralCount = (int)(8 + formProgress * 12);
                for (int i = 0; i < spiralCount; i++)
                {
                    float angle = Timer * 0.15f + MathHelper.TwoPi * i / spiralCount;
                    float radius = 120f * (1f - formProgress * 0.3f);
                    Vector2 pos = NPC.Center + angle.ToRotationVector2() * radius;
                    Vector2 vel = (NPC.Center - pos).SafeNormalize(Vector2.Zero) * 2f;
                    
                    Color vortexColor = Color.Lerp(UnifiedVFX.Eroica.Gold, UnifiedVFX.Eroica.Scarlet, formProgress);
                    CustomParticles.GenericFlare(pos, vortexColor, 0.25f, 10);
                }
            }
            
            if (Timer >= WindupTime)
            {
                Timer = 0;
                vortexStrength = 0f;
                State = ActionState.ValorVortexActive;
                NPC.netUpdate = true;
            }
        }
        
        private void ValorVortexActive(Player target)
        {
            int vortexDuration = currentMood == Phase2Mood.DesperateValor ? 180 : 140;
            float maxPullStrength = currentMood == Phase2Mood.DesperateValor ? 0.35f : 0.25f;
            
            NPC.velocity *= 0.95f;
            
            // Ramp up vortex strength
            vortexStrength = Math.Min(vortexStrength + 0.008f, maxPullStrength);
            
            // Pull player toward boss
            if (target.active && !target.dead)
            {
                Vector2 pullDirection = (NPC.Center - target.Center).SafeNormalize(Vector2.Zero);
                float distance = Vector2.Distance(NPC.Center, target.Center);
                
                // Pull strength increases when closer
                float pullMultiplier = MathHelper.Clamp(1f - distance / 600f, 0.3f, 1f);
                target.velocity += pullDirection * vortexStrength * pullMultiplier * 60f * (1f / 60f);
            }
            
            // Fire projectiles outward
            vortexProjectileTimer++;
            if (vortexProjectileTimer >= 12)
            {
                vortexProjectileTimer = 0;
                
                if (Main.netMode != NetmodeID.MultiplayerClient)
                {
                    int projectileCount = 6;
                    for (int i = 0; i < projectileCount; i++)
                    {
                        float angle = Timer * 0.04f + MathHelper.TwoPi * i / projectileCount;
                        Vector2 vel = angle.ToRotationVector2() * 7f;
                        
                        Projectile.NewProjectile(NPC.GetSource_FromAI(), NPC.Center, vel,
                            ModContent.ProjectileType<EnergyOfEroica>(), 75, 2f);
                    }
                }
                
                SoundEngine.PlaySound(SoundID.Item12 with { Pitch = 0.2f, Volume = 0.5f }, NPC.Center);
            }
            
            // Vortex visual
            if (Timer % 2 == 0)
            {
                int spiralParticles = 16;
                for (int i = 0; i < spiralParticles; i++)
                {
                    float angle = Timer * 0.1f + MathHelper.TwoPi * i / spiralParticles;
                    float radius = 80f + (float)Math.Sin(Timer * 0.05f + i) * 20f;
                    Vector2 pos = NPC.Center + angle.ToRotationVector2() * radius;
                    
                    Color spiralColor = Color.Lerp(UnifiedVFX.Eroica.Gold, UnifiedVFX.Eroica.Scarlet, (float)i / spiralParticles);
                    CustomParticles.GenericFlare(pos, spiralColor, 0.3f, 6);
                }
            }
            
            // Pulsing center
            if (Timer % 15 == 0)
            {
                CustomParticles.HaloRing(NPC.Center, UnifiedVFX.Eroica.Crimson, 0.5f, 18);
            }
            
            if (Timer >= vortexDuration)
            {
                Timer = 0;
                State = ActionState.Phase2Hover;
                NPC.netUpdate = true;
            }
        }

        // ========================================
        // ATTACK 9: COMBO FINISHER
        // Chains multiple attack types rapidly
        // Only available in Desperate Valor
        // ========================================
        
        private void ComboFinisherWindup(Player target)
        {
            const int WindupTime = 30;
            
            NPC.velocity *= 0.9f;
            
            if (Timer == 1)
            {
                SoundEngine.PlaySound(SoundID.Item105 with { Pitch = 0.3f }, NPC.Center);
                comboAttacksRemaining = 3;
            }
            
            // Dramatic buildup
            float progress = Timer / (float)WindupTime;
            
            if (Timer % 4 == 0)
            {
                // Rainbow-ish heroic energy
                for (int i = 0; i < 10; i++)
                {
                    float angle = Timer * 0.2f + MathHelper.TwoPi * i / 10f;
                    Vector2 pos = NPC.Center + angle.ToRotationVector2() * (60f - progress * 30f);
                    Color comboColor = Color.Lerp(UnifiedVFX.Eroica.Gold, UnifiedVFX.Eroica.Scarlet, (float)i / 10f);
                    CustomParticles.GenericFlare(pos, comboColor, 0.4f * (0.5f + progress), 10);
                }
            }
            
            if (Timer >= WindupTime)
            {
                Timer = 0;
                comboAttackIndex = 0;
                State = ActionState.ComboFinisherExecute;
                NPC.netUpdate = true;
            }
        }
        
        private void ComboFinisherExecute(Player target)
        {
            // Rapidly chain different attack patterns
            int attackPhaseLength = 40;
            
            int currentPhase = (int)(Timer / attackPhaseLength);
            int phaseTimer = (int)(Timer % attackPhaseLength);
            
            if (currentPhase >= comboAttacksRemaining)
            {
                Timer = 0;
                State = ActionState.Phase2Hover;
                NPC.netUpdate = true;
                return;
            }
            
            // Execute combo attack based on phase
            switch (currentPhase % 3)
            {
                case 0: // Quick dash
                    if (phaseTimer == 0)
                    {
                        chainDashDirections[0] = (target.Center - NPC.Center).SafeNormalize(Vector2.UnitY);
                        NPC.velocity = chainDashDirections[0] * 30f;
                        SoundEngine.PlaySound(SoundID.Item71, NPC.Center);
                        UnifiedVFX.Eroica.Impact(NPC.Center, 1f);
                    }
                    NPC.velocity *= 0.95f;
                    
                    if (phaseTimer % 3 == 0)
                        CustomParticles.GenericFlare(NPC.Center, UnifiedVFX.Eroica.Scarlet, 0.35f, 6);
                    break;
                    
                case 1: // Spiral burst
                    if (phaseTimer == 10 && Main.netMode != NetmodeID.MultiplayerClient)
                    {
                        for (int i = 0; i < 10; i++)
                        {
                            float angle = MathHelper.TwoPi * i / 10f;
                            Vector2 vel = angle.ToRotationVector2() * 10f;
                            Projectile.NewProjectile(NPC.GetSource_FromAI(), NPC.Center, vel,
                                ModContent.ProjectileType<EnergyOfEroica>(), 80, 2f);
                        }
                        SoundEngine.PlaySound(SoundID.Item12, NPC.Center);
                        UnifiedVFX.Eroica.Explosion(NPC.Center, 1f);
                    }
                    NPC.velocity *= 0.9f;
                    break;
                    
                case 2: // Teleport strike
                    if (phaseTimer == 5)
                    {
                        Vector2 teleportPos = target.Center + Main.rand.NextVector2CircularEdge(200f, 200f);
                        NPC.Center = teleportPos;
                        UnifiedVFX.Eroica.Impact(teleportPos, 1.2f);
                        SoundEngine.PlaySound(SoundID.Item8, teleportPos);
                    }
                    if (phaseTimer == 15)
                    {
                        NPC.velocity = (target.Center - NPC.Center).SafeNormalize(Vector2.UnitY) * 25f;
                    }
                    NPC.velocity *= 0.94f;
                    break;
            }
        }
        
        #endregion
        
        #region Coward Punishment Attacks
        
        // ========================================
        // GROUND STRIKE - Dives at players below the boss
        // ========================================
        
        private void GroundStrikeWindup(Player target)
        {
            NPC.velocity *= 0.9f;
            
            if (Timer < 50)
            {
                float chargeProgress = Timer / 50f;
                
                // Rise up dramatically
                NPC.velocity.Y = MathHelper.Lerp(NPC.velocity.Y, -5f, 0.08f);
                
                // Charging aura
                if (Timer % 4 == 0)
                {
                    CustomParticles.GenericFlare(NPC.Center, Color.Lerp(UnifiedVFX.Eroica.Gold, UnifiedVFX.Eroica.Scarlet, chargeProgress),
                        0.5f + chargeProgress * 0.6f, 20);
                    
                    // Sakura swirl gathering
                    float angle = Timer * 0.2f;
                    for (int i = 0; i < 3; i++)
                    {
                        float orbitAngle = angle + MathHelper.TwoPi * i / 3f;
                        Vector2 orbitPos = NPC.Center + orbitAngle.ToRotationVector2() * (60f - chargeProgress * 30f);
                        ThemedParticles.SakuraPetals(orbitPos, 1, 15f);
                    }
                }
                
                // Target marker on player
                if (Timer % 10 == 0)
                {
                    CustomParticles.HaloRing(target.Center, UnifiedVFX.Eroica.Crimson * 0.6f, 0.5f, 18);
                }
            }
            else
            {
                State = ActionState.GroundStrikeDive;
                Timer = 0;
                
                // Calculate dive direction
                chargeDirection = (target.Center - NPC.Center).SafeNormalize(Vector2.UnitY);
                
                // Launch sound
                SoundEngine.PlaySound(SoundID.Item74 with { Pitch = 0.3f, Volume = 1.4f }, NPC.Center);
                EroicaScreenShake.MediumShake(NPC.Center);
                UnifiedVFX.Eroica.Explosion(NPC.Center, 1.3f);
            }
        }
        
        private void GroundStrikeDive(Player target)
        {
            float diveSpeed = currentMood == Phase2Mood.DesperateValor ? 35f : 28f;
            
            if (Timer < 60)
            {
                // Track toward player during dive
                Vector2 toTarget = (target.Center - NPC.Center).SafeNormalize(Vector2.UnitY);
                chargeDirection = Vector2.Lerp(chargeDirection, toTarget, 0.08f).SafeNormalize(Vector2.UnitY);
                
                NPC.velocity = chargeDirection * diveSpeed;
                
                // Dive trail
                if (Timer % 2 == 0)
                {
                    UnifiedVFX.Eroica.Trail(NPC.Center, NPC.velocity);
                    CustomParticles.GenericFlare(NPC.Center, UnifiedVFX.Eroica.Scarlet, 0.5f, 12);
                }
                
                // Check if we've reached ground level or close to player
                if (target.Center.Y - NPC.Center.Y < 50f || Collision.SolidCollision(NPC.position, NPC.width, NPC.height + 20))
                {
                    State = ActionState.GroundStrikeExplosion;
                    Timer = 0;
                }
            }
            else
            {
                // Timeout - explode anyway
                State = ActionState.GroundStrikeExplosion;
                Timer = 0;
            }
        }
        
        private void GroundStrikeExplosion(Player target)
        {
            if (Timer == 1)
            {
                // MASSIVE impact explosion
                EroicaScreenShake.LargeShake(NPC.Center);
                SoundEngine.PlaySound(SoundID.Item14 with { Volume = 1.5f }, NPC.Center);
                
                // Central explosion
                UnifiedVFX.Eroica.DeathExplosion(NPC.Center, 1.5f);
                
                // Ground shockwave projectiles
                if (Main.netMode != NetmodeID.MultiplayerClient)
                {
                    int waveCount = currentMood == Phase2Mood.DesperateValor ? 12 : 8;
                    for (int i = 0; i < waveCount; i++)
                    {
                        float angle = MathHelper.TwoPi * i / waveCount;
                        Vector2 vel = new Vector2((float)Math.Cos(angle), 0.2f) * 10f; // Ground-hugging
                        Projectile.NewProjectile(NPC.GetSource_FromAI(), NPC.Center, vel,
                            ModContent.ProjectileType<EnergyOfEroica>(), 80, 3f, Main.myPlayer);
                    }
                }
                
                // Sakura explosion
                ThemedParticles.SakuraPetals(NPC.Center, 20, 150f);
                
                // Fractal burst
                for (int i = 0; i < 12; i++)
                {
                    float angle = MathHelper.TwoPi * i / 12f;
                    Vector2 flarePos = NPC.Center + angle.ToRotationVector2() * 80f;
                    CustomParticles.GenericFlare(flarePos, Color.Lerp(UnifiedVFX.Eroica.Gold, UnifiedVFX.Eroica.Crimson, i / 12f), 0.6f, 25);
                }
            }
            
            NPC.velocity *= 0.85f;
            
            if (Timer > 40)
            {
                State = ActionState.Phase2Hover;
                Timer = 0;
            }
        }
        
        // ========================================
        // VALOROUS CAGE - Traps camping players in a ring of projectiles
        // ========================================
        
        private void ValorousCageWindup(Player target)
        {
            NPC.velocity *= 0.92f;
            
            if (Timer < 60)
            {
                float chargeProgress = Timer / 60f;
                
                // Hover toward player
                Vector2 toTarget = target.Center - NPC.Center;
                if (toTarget.Length() > 200f)
                {
                    NPC.velocity = Vector2.Lerp(NPC.velocity, toTarget.SafeNormalize(Vector2.Zero) * 8f, 0.05f);
                }
                
                // Cage preview - golden rings forming around player
                if (Timer % 8 == 0)
                {
                    float cageRadius = 180f + (1f - chargeProgress) * 100f;
                    for (int i = 0; i < 8; i++)
                    {
                        float angle = MathHelper.TwoPi * i / 8f + Timer * 0.03f;
                        Vector2 cagePos = target.Center + angle.ToRotationVector2() * cageRadius;
                        CustomParticles.GenericFlare(cagePos, UnifiedVFX.Eroica.Gold * chargeProgress, 0.3f + chargeProgress * 0.3f, 15);
                    }
                }
                
                // Warning sound
                if (Timer == 30)
                {
                    SoundEngine.PlaySound(SoundID.Item15 with { Pitch = 0.2f, Volume = 0.8f }, target.Center);
                }
            }
            else
            {
                State = ActionState.ValorousCageActive;
                Timer = 0;
                
                SoundEngine.PlaySound(SoundID.Item45 with { Pitch = 0.4f, Volume = 1.2f }, target.Center);
                CustomParticles.HaloRing(target.Center, UnifiedVFX.Eroica.Gold, 0.8f, 25);
            }
        }
        
        private void ValorousCageActive(Player target)
        {
            int cageDuration = currentMood == Phase2Mood.DesperateValor ? 150 : 120;
            float cageRadius = 180f;
            
            if (Timer < cageDuration)
            {
                // Maintain distance from player
                Vector2 toTarget = target.Center - NPC.Center;
                float desiredDist = 280f;
                if (Math.Abs(toTarget.Length() - desiredDist) > 30f)
                {
                    Vector2 targetPos = target.Center - toTarget.SafeNormalize(Vector2.UnitY) * desiredDist;
                    NPC.velocity = Vector2.Lerp(NPC.velocity, (targetPos - NPC.Center) * 0.05f, 0.1f);
                }
                
                // Spawn cage projectiles in a ring
                int spawnInterval = currentMood == Phase2Mood.DesperateValor ? 8 : 12;
                if (Timer % spawnInterval == 0)
                {
                    int projectilesPerSpawn = 8;
                    float angleOffset = Timer * 0.02f;
                    
                    for (int i = 0; i < projectilesPerSpawn; i++)
                    {
                        float angle = MathHelper.TwoPi * i / projectilesPerSpawn + angleOffset;
                        Vector2 spawnPos = target.Center + angle.ToRotationVector2() * cageRadius;
                        
                        // Projectiles move inward slowly
                        Vector2 vel = (target.Center - spawnPos).SafeNormalize(Vector2.Zero) * 2.5f;
                        
                        if (Main.netMode != NetmodeID.MultiplayerClient)
                        {
                            Projectile.NewProjectile(NPC.GetSource_FromAI(), spawnPos, vel,
                                ModContent.ProjectileType<EnergyOfEroica>(), 70, 1f, Main.myPlayer);
                        }
                        
                        // Spawn VFX
                        CustomParticles.GenericFlare(spawnPos, UnifiedVFX.Eroica.Gold, 0.4f, 12);
                    }
                    
                    SoundEngine.PlaySound(SoundID.Item12 with { Pitch = 0.5f, Volume = 0.6f }, target.Center);
                }
                
                // Boss fires at player during cage
                if (Timer % 25 == 0 && Timer > 30)
                {
                    Vector2 toPlayer = (target.Center - NPC.Center).SafeNormalize(Vector2.UnitY);
                    if (Main.netMode != NetmodeID.MultiplayerClient)
                    {
                        Projectile.NewProjectile(NPC.GetSource_FromAI(), NPC.Center, toPlayer * 12f,
                            ModContent.ProjectileType<EnergyOfEroica>(), 75, 2f, Main.myPlayer);
                    }
                    UnifiedVFX.Eroica.Impact(NPC.Center, 0.8f);
                }
                
                // Ambient cage VFX
                if (Timer % 15 == 0)
                {
                    CustomParticles.HaloRing(target.Center, UnifiedVFX.Eroica.Crimson * 0.4f, 0.6f, 20);
                }
            }
            else
            {
                State = ActionState.Phase2Hover;
                Timer = 0;
            }
        }
        
        // ========================================
        // WRATH OF VALOR - Ultimate punishment for prolonged cowardice
        // ========================================
        
        private void WrathOfValorWindup(Player target)
        {
            NPC.velocity *= 0.9f;
            
            if (Timer < 80)
            {
                float chargeProgress = Timer / 80f;
                
                // Intense charging aura - the god's fury builds
                if (Timer % 3 == 0)
                {
                    // Massive swirling aura
                    float swirl = Timer * 0.1f;
                    for (int i = 0; i < 5; i++)
                    {
                        float angle = swirl + MathHelper.TwoPi * i / 5f;
                        float radius = 50f + chargeProgress * 50f;
                        Vector2 auraPos = NPC.Center + angle.ToRotationVector2() * radius;
                        
                        Color auraColor = Color.Lerp(UnifiedVFX.Eroica.Gold, UnifiedVFX.Eroica.Scarlet, chargeProgress);
                        CustomParticles.GenericFlare(auraPos, auraColor, 0.4f + chargeProgress * 0.4f, 18);
                    }
                    
                    // Central glow intensifies
                    CustomParticles.GenericFlare(NPC.Center, Color.Lerp(UnifiedVFX.Eroica.Gold, Color.White, chargeProgress * 0.5f),
                        0.6f + chargeProgress * 0.8f, 20);
                }
                
                // Sakura petals swirl faster and faster
                if (Timer % 6 == 0)
                {
                    ThemedParticles.SakuraPetals(NPC.Center, 3, 100f * (1f + chargeProgress));
                }
                
                // Dramatic screen shake builds
                if (Timer > 50)
                {
                    EroicaScreenShake.SmallShake(NPC.Center);
                }
                
                // Bell toll warnings
                if (Timer == 25 || Timer == 50 || Timer == 70)
                {
                    SoundEngine.PlaySound(SoundID.Item15 with { Pitch = -0.2f - chargeProgress * 0.3f, Volume = 1f + chargeProgress * 0.4f }, NPC.Center);
                }
            }
            else
            {
                State = ActionState.WrathOfValorExecute;
                Timer = 0;
                
                // MASSIVE announcement
                SoundEngine.PlaySound(SoundID.Item14 with { Pitch = -0.3f, Volume = 1.6f }, NPC.Center);
                SoundEngine.PlaySound(SoundID.Item45 with { Pitch = 0.5f, Volume = 1.4f }, NPC.Center);
                EroicaScreenShake.LargeShake(NPC.Center);
                
                UnifiedVFX.Eroica.DeathExplosion(NPC.Center, 1.2f);
            }
        }
        
        private void WrathOfValorExecute(Player target)
        {
            int wrathDuration = 180; // 3 seconds of righteous fury
            
            if (Timer < wrathDuration)
            {
                // Phase 1: Rapid teleport strikes (0-60)
                if (Timer < 60)
                {
                    if (Timer % 15 == 0)
                    {
                        // Teleport to random position around player and fire
                        Vector2 teleportPos = target.Center + Main.rand.NextVector2CircularEdge(200f, 200f);
                        
                        // Departure VFX
                        UnifiedVFX.Eroica.Impact(NPC.Center, 0.8f);
                        ThemedParticles.SakuraPetals(NPC.Center, 5, 40f);
                        
                        NPC.Center = teleportPos;
                        
                        // Arrival VFX
                        UnifiedVFX.Eroica.Impact(teleportPos, 1f);
                        SoundEngine.PlaySound(SoundID.Item8 with { Pitch = 0.3f }, teleportPos);
                        
                        // Fire burst at player
                        if (Main.netMode != NetmodeID.MultiplayerClient)
                        {
                            Vector2 toPlayer = (target.Center - NPC.Center).SafeNormalize(Vector2.UnitY);
                            for (int i = -1; i <= 1; i++)
                            {
                                Vector2 vel = toPlayer.RotatedBy(i * 0.15f) * 14f;
                                Projectile.NewProjectile(NPC.GetSource_FromAI(), NPC.Center, vel,
                                    ModContent.ProjectileType<EnergyOfEroica>(), 75, 2f, Main.myPlayer);
                            }
                        }
                    }
                }
                // Phase 2: Spiral barrage (60-120)
                else if (Timer < 120)
                {
                    // Hover aggressively
                    Vector2 toTarget = (target.Center - NPC.Center).SafeNormalize(Vector2.Zero);
                    NPC.velocity = Vector2.Lerp(NPC.velocity, toTarget * 15f, 0.08f);
                    
                    if ((Timer - 60) % 6 == 0)
                    {
                        float spiralAngle = (Timer - 60) * 0.15f;
                        for (int i = 0; i < 3; i++)
                        {
                            float angle = spiralAngle + MathHelper.TwoPi * i / 3f;
                            Vector2 vel = angle.ToRotationVector2() * 11f;
                            
                            if (Main.netMode != NetmodeID.MultiplayerClient)
                            {
                                Projectile.NewProjectile(NPC.GetSource_FromAI(), NPC.Center, vel,
                                    ModContent.ProjectileType<EnergyOfEroica>(), 70, 2f, Main.myPlayer);
                            }
                        }
                        
                        CustomParticles.GenericFlare(NPC.Center, UnifiedVFX.Eroica.Crimson, 0.5f, 12);
                    }
                }
                // Phase 3: Meteor bombardment (120-180)
                else
                {
                    // Stop and rain fury
                    NPC.velocity *= 0.9f;
                    
                    if ((Timer - 120) % 8 == 0)
                    {
                        int meteorCount = 3;
                        for (int i = 0; i < meteorCount; i++)
                        {
                            Vector2 spawnPos = target.Center + new Vector2(Main.rand.NextFloat(-250, 250), -400);
                            Vector2 vel = (target.Center - spawnPos).SafeNormalize(Vector2.UnitY) * 12f;
                            vel.X += Main.rand.NextFloat(-2, 2);
                            
                            if (Main.netMode != NetmodeID.MultiplayerClient)
                            {
                                Projectile.NewProjectile(NPC.GetSource_FromAI(), spawnPos, vel,
                                    ModContent.ProjectileType<EnergyOfEroica>(), 75, 2f, Main.myPlayer);
                            }
                            
                            CustomParticles.GenericFlare(spawnPos, UnifiedVFX.Eroica.Gold, 0.5f, 15);
                        }
                        
                        SoundEngine.PlaySound(SoundID.Item12 with { Volume = 0.6f, Pitch = 0.3f }, target.Center);
                    }
                }
                
                // Constant ambient wrath VFX
                if (Timer % 10 == 0)
                {
                    ThemedParticles.SakuraPetals(NPC.Center, 2, 60f);
                    CustomParticles.GenericFlare(NPC.Center, UnifiedVFX.Eroica.Scarlet, 0.4f, 15);
                }
            }
            else
            {
                State = ActionState.Phase2Hover;
                Timer = 0;
                
                // Final exhaustion VFX
                SoundEngine.PlaySound(SoundID.Item15 with { Pitch = -0.2f, Volume = 0.8f }, NPC.Center);
            }
        }

        #endregion

        #region Loot

        public override void ModifyNPCLoot(NPCLoot npcLoot)
        {
            // Expert/Master mode: Drop treasure bag
            npcLoot.Add(ItemDropRule.BossBag(ModContent.ItemType<EroicaTreasureBag>()));
            
            // Normal mode drops (half of expert amounts, NO BELL)
            LeadingConditionRule notExpert = new LeadingConditionRule(new Conditions.NotExpert());
            
            // 10-12 Energy (half of 20-25)
            notExpert.OnSuccess(ItemDropRule.Common(ModContent.ItemType<EroicasResonantEnergy>(), 1, 10, 12));
            
            // 15-17 Remnant (half of 30-35)
            notExpert.OnSuccess(ItemDropRule.Common(ModContent.ItemType<RemnantOfEroicasTriumph>(), 1, 15, 17));
            
            // 5-10 Shard of Tempo (half of 10-20)
            notExpert.OnSuccess(ItemDropRule.Common(ModContent.ItemType<ShardOfTriumphsTempo>(), 1, 5, 10));
            
            // 1-2 random weapons (NO bell in normal mode)
            notExpert.OnSuccess(new EroicaNormalModeWeaponRule());
            
            npcLoot.Add(notExpert);
        }

        #endregion

        #region Death Animation

        public override bool CheckDead()
        {
            if (isDying && deathTimer >= DeathAnimationDuration)
            {
                return true;
            }
            
            if (!isDying)
            {
                isDying = true;
                deathTimer = 0;
                NPC.life = 1;
                NPC.dontTakeDamage = true;
                NPC.velocity = Vector2.Zero;
                
                SoundEngine.PlaySound(SoundID.Item105, NPC.Center);
            }
            
            return false;
        }

        private void UpdateDeathAnimation()
        {
            if (!isDying) return;
            
            deathTimer++;
            
            // Phase 1: Building intensity with gradient Scarlet â†’ Gold effects
            if (deathTimer < 120)
            {
                float intensity = (float)deathTimer / 120f;
                
                // Fractal flare pattern with gradient colors - ENHANCED BLOOM
                if (deathTimer % 5 == 0)
                {
                    int points = 6 + (int)(intensity * 4);
                    for (int i = 0; i < points; i++)
                    {
                        float angle = MathHelper.TwoPi * i / points + deathTimer * 0.05f;
                        Vector2 offset = angle.ToRotationVector2() * (30f + intensity * 40f);
                        float progress = (float)i / points;
                        Color flareColor = Color.Lerp(UnifiedVFX.Eroica.Scarlet, UnifiedVFX.Eroica.Gold, progress);
                        EnhancedParticles.BloomFlare(NPC.Center + offset, flareColor, 0.4f + intensity * 0.4f, 15, 3, 0.9f);
                    }
                    
                    // Central pulsing flare - enhanced bloom
                    EnhancedParticles.BloomFlare(NPC.Center, Color.Lerp(UnifiedVFX.Eroica.Crimson, UnifiedVFX.Eroica.Gold, intensity), 
                        0.6f + intensity * 0.6f, 20, 4, 1.1f);
                }
                
                // Sakura petals intensifying
                if (deathTimer % 10 == 0)
                    ThemedParticles.SakuraPetals(NPC.Center, (int)(2 + intensity * 4), 60f + intensity * 40f);
                
                // Pulsing halo rings
                if (deathTimer % 15 == 0)
                {
                    CustomParticles.HaloRing(NPC.Center, Color.Lerp(UnifiedVFX.Eroica.Scarlet, UnifiedVFX.Eroica.Gold, intensity), 
                        0.4f + intensity * 0.4f, 25);
                }
                
                // Light screen shake only on key moments (every 30 frames)
                if (deathTimer % 30 == 0 && Main.LocalPlayer.Distance(NPC.Center) < 1500f)
                    MagnumScreenEffects.AddScreenShake(2f + intensity * 2f);
                
                if (deathTimer % 20 == 0)
                    SoundEngine.PlaySound(SoundID.Item74, NPC.Center);
            }
            // Phase 2: Flash buildup with intense effects
            else if (deathTimer < 150)
            {
                float flashProgress = (deathTimer - 120f) / 30f;
                screenFlashIntensity = flashProgress;
                
                // Expanding gradient rings
                if (deathTimer % 4 == 0)
                {
                    UnifiedVFX.Eroica.Impact(NPC.Center, 0.8f + flashProgress * 0.5f);
                }
                
                // Music notes ascending
                ThemedParticles.EroicaMusicNotes(NPC.Center, 4, 50f + flashProgress * 30f);
                
                // Single shake at start of flash phase
                if (deathTimer == 121 && Main.LocalPlayer.Distance(NPC.Center) < 2000f)
                    MagnumScreenEffects.AddScreenShake(6f);
            }
            // Phase 3: CLIMAX - Full UnifiedVFX death explosion WITH ENHANCED BLOOM
            else if (deathTimer == 150)
            {
                screenFlashIntensity = 1f;
                SoundEngine.PlaySound(SoundID.Item122, NPC.Center);
                
                // Massive themed death explosion - ENHANCED
                UnifiedVFXBloom.Eroica.ExplosionEnhanced(NPC.Center, 2f);
                
                // Extra spiral galaxy effect for heroic finale - with enhanced bloom
                for (int arm = 0; arm < 6; arm++)
                {
                    float armAngle = MathHelper.TwoPi * arm / 6f;
                    for (int point = 0; point < 8; point++)
                    {
                        float spiralAngle = armAngle + point * 0.4f;
                        float spiralRadius = 25f + point * 18f;
                        Vector2 spiralPos = NPC.Center + spiralAngle.ToRotationVector2() * spiralRadius;
                        float progress = (arm * 8 + point) / 48f;
                        Color galaxyColor = Color.Lerp(UnifiedVFX.Eroica.Scarlet, UnifiedVFX.Eroica.Gold, progress);
                        EnhancedParticles.BloomFlare(spiralPos, galaxyColor, 0.5f + point * 0.05f, 25 + point * 2, 3, 0.85f);
                    }
                }
                
                // Heroic music staff finale
                EnhancedThemedParticles.EroicaMusicNotesEnhanced(NPC.Center, 16, 80f);
                ThemedParticles.EroicaMusicStaff(NPC.Center, 2f);
            }
            // Phase 4: Fade out - no shake, just visual fade
            else if (deathTimer <= DeathAnimationDuration)
            {
                float fadeProgress = (deathTimer - 150f) / 30f;
                screenFlashIntensity = 1f - fadeProgress;
                
                // Lingering sakura petals
                if (deathTimer % 8 == 0)
                    ThemedParticles.SakuraPetals(NPC.Center, 3, 100f * (1f - fadeProgress));
            }
            
            // Pulsing light with gradient color
            if (screenFlashIntensity > 0 && Main.LocalPlayer.Distance(NPC.Center) < 2000f)
            {
                Color lightColor = Color.Lerp(UnifiedVFX.Eroica.Crimson, UnifiedVFX.Eroica.Gold, screenFlashIntensity);
                Lighting.AddLight(NPC.Center, lightColor.ToVector3() * screenFlashIntensity * 3f);
            }
        }

        public override void OnKill()
        {
            // Final burst with gradient colors
            UnifiedVFX.Generic.FractalBurst(NPC.Center, UnifiedVFX.Eroica.Scarlet, UnifiedVFX.Eroica.Gold, 12, 80f, 1.5f);
            
            // Layered halo cascade
            for (int ring = 0; ring < 6; ring++)
            {
                float progress = (float)ring / 6f;
                Color ringColor = Color.Lerp(UnifiedVFX.Eroica.Scarlet, UnifiedVFX.Eroica.Gold, progress);
                CustomParticles.HaloRing(NPC.Center, ringColor * (1f - progress * 0.3f), 0.5f + ring * 0.2f, 20 + ring * 5);
            }
            
            // Final sakura shower
            ThemedParticles.SakuraPetals(NPC.Center, 25, 120f);
            
            // Triumphant music burst
            ThemedParticles.EroicaMusicNotes(NPC.Center, 16, 100f);
            ThemedParticles.EroicaClef(NPC.Center, true, 2.5f);

            if (Main.netMode != NetmodeID.MultiplayerClient)
            {
                Main.NewText("Eroica's valor echoes through eternity...", 255, 200, 100);
            }
        }

        #endregion

        #region Targeting Prevention (Phase 1)

        public override bool? CanBeHitByProjectile(Projectile projectile)
        {
            if (!phase2Started && flamesSpawned && CountAliveFlames() > 0)
            {
                return false;
            }
            return null;
        }

        public override bool CanBeHitByNPC(NPC attacker)
        {
            if (!phase2Started && flamesSpawned && CountAliveFlames() > 0)
            {
                return false;
            }
            return true;
        }

        public override bool? CanBeHitByItem(Player player, Item item)
        {
            if (!phase2Started && flamesSpawned && CountAliveFlames() > 0)
            {
                return false;
            }
            return null;
        }

        #endregion

        #region Drawing

        public override bool PreDraw(SpriteBatch spriteBatch, Vector2 screenPos, Color drawColor)
        {
            Texture2D texture = Terraria.GameContent.TextureAssets.Npc[Type].Value;
            
            int frameWidth = texture.Width / FrameColumns;
            int frameHeight = texture.Height / FrameRows;
            int column = currentFrame % FrameColumns;
            int row = currentFrame / FrameColumns;
            
            Rectangle sourceRect = new Rectangle(column * frameWidth, row * frameHeight, frameWidth, frameHeight);
            Vector2 drawOrigin = new Vector2(frameWidth / 2, frameHeight / 2);
            
            // Flip sprite when facing left (sprite faces RIGHT by default)
            SpriteEffects effects = NPC.spriteDirection == -1 ? SpriteEffects.FlipHorizontally : SpriteEffects.None;

            // Draw trail
            for (int k = 0; k < NPC.oldPos.Length; k++)
            {
                Vector2 drawPos = NPC.oldPos[k] - screenPos + new Vector2(NPC.width / 2, NPC.height / 2);
                Color trailColor;
                
                if (phase2Started)
                {
                    trailColor = new Color(255, 100, 50, 80) * ((float)(NPC.oldPos.Length - k) / NPC.oldPos.Length);
                }
                else
                {
                    trailColor = new Color(255, 200, 100, 80) * ((float)(NPC.oldPos.Length - k) / NPC.oldPos.Length);
                }
                
                float scale = NPC.scale * (1f - k * 0.08f);
                spriteBatch.Draw(texture, drawPos, sourceRect, trailColor, NPC.rotation, drawOrigin, scale, effects, 0f);
            }
            
            // Phase 2 pulsing aura glow
            if (phase2Started)
            {
                float pulse = (float)Math.Sin(auraPulse * 2f) * 0.3f + 0.7f;
                Color glowColor = new Color(255, 100, 50, 0) * pulse * 0.4f;
                
                for (int i = 0; i < 6; i++)
                {
                    Vector2 offset = new Vector2(6f, 0).RotatedBy(MathHelper.TwoPi * i / 6f);
                    spriteBatch.Draw(texture, NPC.Center - screenPos + offset, sourceRect, glowColor, NPC.rotation, drawOrigin, NPC.scale * 1.1f, effects, 0f);
                }
            }
            
            // Draw main sprite
            Vector2 mainDrawPos = NPC.Center - screenPos;
            Color mainColor = NPC.GetAlpha(drawColor);
            spriteBatch.Draw(texture, mainDrawPos, sourceRect, mainColor, NPC.rotation, drawOrigin, NPC.scale, effects, 0f);

            return false;
        }

        public override Color? GetAlpha(Color drawColor)
        {
            if (phase2Started)
            {
                // Red tint in phase 2
                return new Color(255, 200, 180, 230);
            }
            return new Color(255, 240, 220, 240); // Golden tint in phase 1
        }
        
        public override void PostDraw(SpriteBatch spriteBatch, Vector2 screenPos, Color drawColor)
        {
            // The phase 2 overlay is now handled by EroicaSkyEffect for proper layering
            // Drawing fullscreen rectangles in NPC PostDraw can cause visual glitches
        }

        public override bool? DrawHealthBar(byte hbPosition, ref float scale, ref Vector2 position)
        {
            scale = 1.5f;
            return null;
        }

        public override bool CanHitPlayer(Player target, ref int cooldownSlot)
        {
            cooldownSlot = ImmunityCooldownID.Bosses;
            return true;
        }

        [System.Obsolete]
        public override void BossLoot(ref string name, ref int potionType)
        {
            potionType = ItemID.GreaterHealingPotion;
        }

        #endregion
    }
    
    /// <summary>
    /// Custom drop rule for normal mode that drops 1-2 random weapons (NO bell).
    /// </summary>
    public class EroicaNormalModeWeaponRule : IItemDropRule
    {
        public List<IItemDropRuleChainAttempt> ChainedRules => new List<IItemDropRuleChainAttempt>();

        public bool CanDrop(DropAttemptInfo info) => true;

        public void ReportDroprates(List<DropRateInfo> drops, DropRateInfoChainFeed ratesInfo)
        {
            int[] possibleDrops = GetPossibleDrops();
            float individualChance = 1.5f / possibleDrops.Length;
            
            foreach (int itemType in possibleDrops)
            {
                drops.Add(new DropRateInfo(itemType, 1, 1, individualChance, ratesInfo.conditions));
            }
        }

        public ItemDropAttemptResult TryDroppingItem(DropAttemptInfo info)
        {
            int[] possibleDrops = GetPossibleDrops();
            
            // Shuffle the array
            List<int> shuffled = new List<int>(possibleDrops);
            for (int i = shuffled.Count - 1; i > 0; i--)
            {
                int j = Main.rand.Next(i + 1);
                int temp = shuffled[i];
                shuffled[i] = shuffled[j];
                shuffled[j] = temp;
            }
            
            // Drop 1-2 items
            int dropCount = Main.rand.NextBool() ? 2 : 1;
            
            for (int i = 0; i < dropCount && i < shuffled.Count; i++)
            {
                CommonCode.DropItem(info, shuffled[i], 1);
            }
            
            return new ItemDropAttemptResult
            {
                State = ItemDropAttemptResultState.Success
            };
        }
        
        private int[] GetPossibleDrops()
        {
            // NO BELL in normal mode!
            return new int[]
            {
                ModContent.ItemType<FuneralPrayer>(),
                ModContent.ItemType<TriumphantFractal>(),
                ModContent.ItemType<SakurasBlossom>(),
                ModContent.ItemType<BlossomOfTheSakura>(),
                ModContent.ItemType<FinalityOfTheSakura>(),
                ModContent.ItemType<PiercingLightOfTheSakura>(),
                ModContent.ItemType<CelestialValor>()
            };
        }
    }
}
