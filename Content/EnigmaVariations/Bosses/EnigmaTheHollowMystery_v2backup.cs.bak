using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;
using System;
using System.Collections.Generic;
using Terraria;
using Terraria.GameContent.Bestiary;
using Terraria.GameContent.ItemDropRules;
using Terraria.ID;
using Terraria.ModLoader;
using Terraria.Audio;
using MagnumOpus.Content.EnigmaVariations.ResonanceEnergies;
using MagnumOpus.Content.EnigmaVariations.ResonantWeapons;
using MagnumOpus.Content.EnigmaVariations.HarmonicCores;
using MagnumOpus.Common.Systems;
using MagnumOpus.Common.Systems.Particles;
using MagnumOpus.Common.Systems.VFX;

namespace MagnumOpus.Content.EnigmaVariations.Bosses
{
    /// <summary>
    /// ENIGMA, THE HOLLOW MYSTERY - COMPLETE AGGRESSIVE REBUILD
    /// 
    /// A NIGHTMARISH spider-like entity that is RELENTLESS and UNPREDICTABLE.
    /// Inspired by Calamitas and The Devourer.
    /// 
    /// CORE DESIGN:
    /// - Ground-based spider boss with AGGRESSIVE pursuit
    /// - Teleports through shadows to ambush player
    /// - Eyes spawn constantly, creating chaos
    /// - Void tendrils and arcane attacks
    /// 
    /// COMBAT PHILOSOPHY:
    /// - Player should feel HUNTED
    /// - The unknown is terrifying - unpredictable attacks
    /// - Arena fills with watching eyes and void energy
    /// - Nowhere is safe
    /// </summary>
    public class EnigmaTheHollowMystery : ModNPC
    {
        public override string Texture => "MagnumOpus/Content/EnigmaVariations/Bosses/EnigmaTheHollowMystery";
        
        #region Theme Colors
        private static readonly Color EnigmaBlack = new Color(15, 10, 20);
        private static readonly Color EnigmaPurple = new Color(140, 60, 200);
        private static readonly Color EnigmaDeepPurple = new Color(80, 20, 120);
        private static readonly Color EnigmaGreen = new Color(50, 220, 100);
        private static readonly Color EnigmaVoid = new Color(30, 15, 40);
        #endregion
        
        #region AI State
        private enum BossState
        {
            Spawning,
            Pursuit,        // Aggressive ground chase
            Attack,         // Executing an attack
            ShadowStep,     // Teleport attack
            Frenzy          // Low HP rage mode
        }
        
        private enum AttackType
        {
            // Core Attacks
            VoidLunge,          // Rapid lunges at player
            EyeStorm,           // Spawn tracking eye projectiles
            ParadoxBurst,       // Spread of void projectiles
            
            // Phase 2 (60% HP)
            ShadowAmbush,       // Teleport behind + attack
            TendrilWave,        // Void tendrils from ground
            GlyphTrap,          // Create damaging glyph zones
            
            // Phase 3 (30% HP - Madness)
            RealityTear,        // Screen distortion + projectile storm
            EyeFormation,       // Eyes form attack pattern
            UltimateEnigma      // Chaos attack
        }
        
        private BossState State
        {
            get => (BossState)NPC.ai[0];
            set => NPC.ai[0] = (float)value;
        }
        
        private int Timer
        {
            get => (int)NPC.ai[1];
            set => NPC.ai[1] = value;
        }
        
        private AttackType CurrentAttack
        {
            get => (AttackType)NPC.ai[2];
            set => NPC.ai[2] = (float)value;
        }
        
        private int AttackSubPhase
        {
            get => (int)NPC.ai[3];
            set => NPC.ai[3] = value;
        }
        #endregion
        
        #region Combat Variables
        private int phase = 0; // 0=Curiosity, 1=Obsession, 2=Void Revelation
        
        // Lunge tracking
        private int lungeCount = 0;
        private Vector2 lungeDirection;
        
        // Shadow step
        private Vector2 shadowTarget;
        private bool isInShadow = false;
        
        // Distance punishment
        private int farAwayTimer = 0;
        
        // Attack tracking
        private int attackCooldown = 0;
        private AttackType lastAttack = AttackType.VoidLunge;
        
        // Animation
        private int frameCounter = 0;
        private int currentFrame = 0;
        private const int TotalFrames = 36;
        
        // Health bar
        private bool hasRegisteredHealthBar = false;
        
        // Death
        private int deathTimer = 0;
        
        // Ground tracking
        private bool onGround = false;
        #endregion

        public override void SetStaticDefaults()
        {
            Main.npcFrameCount[Type] = TotalFrames;
            NPCID.Sets.MPAllowedEnemies[Type] = true;
            NPCID.Sets.BossBestiaryPriority.Add(Type);
            NPCID.Sets.TrailCacheLength[Type] = 10;
            NPCID.Sets.TrailingMode[Type] = 1;
            NPCID.Sets.MustAlwaysDraw[Type] = true;
            
            NPCID.Sets.SpecificDebuffImmunity[Type][BuffID.Poisoned] = true;
            NPCID.Sets.SpecificDebuffImmunity[Type][BuffID.Confused] = true;
            NPCID.Sets.SpecificDebuffImmunity[Type][BuffID.Darkness] = true;
            NPCID.Sets.SpecificDebuffImmunity[Type][BuffID.Blackout] = true;
        }

        public override void SetDefaults()
        {
            NPC.width = 180;
            NPC.height = 120;
            NPC.damage = 110;
            NPC.defense = 65;
            NPC.lifeMax = 340000;
            NPC.HitSound = SoundID.NPCHit54;
            NPC.DeathSound = SoundID.NPCDeath52;
            NPC.knockBackResist = 0f;
            NPC.noGravity = true;
            NPC.noTileCollide = true;
            NPC.value = Item.buyPrice(gold: 16);
            NPC.boss = true;
            NPC.npcSlots = 15f;
            NPC.aiStyle = -1;
            NPC.scale = 1f;
            
            if (!Main.dedServ)
                Music = MusicLoader.GetMusicSlot(Mod, "Assets/Music/EnigmaVariations");
        }

        public override void SetBestiary(BestiaryDatabase database, BestiaryEntry bestiaryEntry)
        {
            bestiaryEntry.Info.AddRange(new IBestiaryInfoElement[]
            {
                BestiaryDatabaseNPCsPopulator.CommonTags.SpawnConditions.Times.NightTime,
                new FlavorTextBestiaryInfoElement("Enigma, the Hollow Mystery - an unknowable horror from beyond.")
            });
        }

        public override void AI()
        {
            // Health bar registration
            if (!hasRegisteredHealthBar)
            {
                BossHealthBarUI.RegisterBoss(NPC, BossColorTheme.Enigma);
                hasRegisteredHealthBar = true;
            }
            
            NPC.TargetClosest(true);
            Player target = Main.player[NPC.target];
            
            // Despawn check
            if (!target.active || target.dead)
            {
                NPC.velocity.Y -= 0.3f;
                NPC.alpha = Math.Min(255, NPC.alpha + 5);
                if (NPC.alpha >= 255)
                    NPC.EncourageDespawn(10);
                return;
            }
            
            // Update phase based on HP
            UpdatePhase();
            
            // Cooldowns
            if (attackCooldown > 0) attackCooldown--;
            
            // Ground detection
            UpdateGroundCheck();
            
            // State machine
            switch (State)
            {
                case BossState.Spawning:
                    AI_Spawning(target);
                    break;
                case BossState.Pursuit:
                    AI_Pursuit(target);
                    break;
                case BossState.Attack:
                    AI_Attack(target);
                    break;
                case BossState.ShadowStep:
                    AI_ShadowStep(target);
                    break;
                case BossState.Frenzy:
                    AI_Frenzy(target);
                    break;
            }
            
            Timer++;
            UpdateAnimation();
            SpawnAmbientParticles();
            
            // Lighting
            float pulse = (float)Math.Sin(Timer * 0.1f) * 0.2f + 0.8f;
            Lighting.AddLight(NPC.Center, EnigmaPurple.ToVector3() * pulse);
        }
        
        #region Phase Management
        
        private void UpdatePhase()
        {
            float hp = (float)NPC.life / NPC.lifeMax;
            int newPhase = hp > 0.6f ? 0 : (hp > 0.3f ? 1 : 2);
            
            if (newPhase != phase)
            {
                phase = newPhase;
                AnnouncePhaseChange();
            }
        }
        
        private void AnnouncePhaseChange()
        {
            MagnumScreenEffects.AddScreenShake(phase == 2 ? 20f : 12f);
            SoundEngine.PlaySound(SoundID.NPCDeath52 with { Pitch = -0.3f - phase * 0.1f, Volume = 1.3f }, NPC.Center);
            
            // Void burst
            CustomParticles.GenericFlare(NPC.Center, EnigmaGreen, 1.2f, 25);
            for (int i = 0; i < 12; i++)
            {
                float angle = MathHelper.TwoPi * i / 12f;
                Color color = Color.Lerp(EnigmaPurple, EnigmaGreen, (float)i / 12f);
                CustomParticles.GenericFlare(NPC.Center + angle.ToRotationVector2() * 70f, color, 0.5f, 18);
            }
            
            for (int r = 0; r < 6; r++)
                CustomParticles.HaloRing(NPC.Center, Color.Lerp(EnigmaPurple, EnigmaGreen, r / 6f), 0.3f + r * 0.15f, 15 + r * 3);
            
            // Glyph burst
            CustomParticles.GlyphBurst(NPC.Center, EnigmaPurple, 8 + phase * 3, 6f);
            
            // Spawn eyes
            if (Main.netMode != NetmodeID.MultiplayerClient)
            {
                for (int i = 0; i < 5 + phase * 2; i++)
                {
                    Vector2 eyePos = NPC.Center + Main.rand.NextVector2Circular(100f, 100f);
                    CustomParticles.EnigmaEyeGaze(eyePos, EnigmaPurple, 0.5f, Main.player[NPC.target].Center);
                }
            }
            
            string text = phase == 2 ? "V̴O̵I̷D̶ ̸R̶E̴V̵E̷L̴A̵T̵I̷O̵N̷" : "O̷B̶S̵E̶S̴S̶I̴O̶N̷";
            CombatText.NewText(NPC.Hitbox, phase == 2 ? EnigmaGreen : EnigmaPurple, text, true);
        }
        
        #endregion
        
        #region Ground Check
        
        private void UpdateGroundCheck()
        {
            Vector2 bottomCenter = NPC.Bottom;
            int tileX = (int)(bottomCenter.X / 16);
            int tileY = (int)(bottomCenter.Y / 16);
            
            onGround = false;
            for (int y = tileY; y < tileY + 5; y++)
            {
                Tile tile = Framing.GetTileSafely(tileX, y);
                if (tile.HasTile && Main.tileSolid[tile.TileType])
                {
                    onGround = NPC.Bottom.Y >= y * 16f - 20f;
                    break;
                }
            }
        }
        
        #endregion
        
        #region AI States
        
        private void AI_Spawning(Player target)
        {
            if (Timer == 1)
            {
                SoundEngine.PlaySound(SoundID.NPCDeath52 with { Pitch = -0.5f }, NPC.Center);
                CustomParticles.GenericFlare(NPC.Center, EnigmaPurple, 1.0f, 25);
                
                // Spawn with eyes watching
                for (int i = 0; i < 8; i++)
                {
                    float angle = MathHelper.TwoPi * i / 8f;
                    Vector2 eyePos = NPC.Center + angle.ToRotationVector2() * 150f;
                    CustomParticles.EnigmaEyeGaze(eyePos, EnigmaPurple, 0.6f, target.Center);
                }
            }
            
            // Fade in
            NPC.alpha = (int)MathHelper.Lerp(255, 0, Timer / 60f);
            
            if (Timer >= 60)
            {
                Main.NewText("The Mystery stirs...", EnigmaPurple);
                Timer = 0;
                State = BossState.Pursuit;
                attackCooldown = 45;
            }
        }
        
        private void AI_Pursuit(Player target)
        {
            // === DISTANCE CHECK - SHADOW STEP IF TOO FAR ===
            float distance = Vector2.Distance(NPC.Center, target.Center);
            if (distance > 750f)
            {
                farAwayTimer++;
                if (farAwayTimer > 45)
                {
                    State = BossState.ShadowStep;
                    Timer = 0;
                    farAwayTimer = 0;
                    shadowTarget = target.Center;
                    return;
                }
            }
            else
            {
                farAwayTimer = Math.Max(0, farAwayTimer - 2);
            }
            
            // === AGGRESSIVE GROUND PURSUIT ===
            float moveSpeed = 10f + phase * 3f;
            float accel = 0.12f + phase * 0.04f;
            
            Vector2 toTarget = target.Center - NPC.Center;
            float targetX = Math.Sign(toTarget.X);
            
            // Horizontal movement
            NPC.velocity.X = MathHelper.Lerp(NPC.velocity.X, targetX * moveSpeed, accel);
            
            // Gravity / Ground
            if (!onGround)
            {
                NPC.velocity.Y += 0.5f;
                if (NPC.velocity.Y > 15f) NPC.velocity.Y = 15f;
            }
            else
            {
                // Small hop toward player if they're above
                if (toTarget.Y < -150f && Timer % 60 == 0)
                {
                    NPC.velocity.Y = -12f - phase * 2f;
                    SoundEngine.PlaySound(SoundID.Item24 with { Pitch = 0.3f }, NPC.Center);
                }
                else
                {
                    NPC.velocity.Y = 0;
                }
            }
            
            // Face target
            NPC.spriteDirection = NPC.direction = targetX > 0 ? 1 : -1;
            
            // === ATTACK SELECTION ===
            int attackDelay = 90 - phase * 20;
            
            if (attackCooldown <= 0 && Timer > attackDelay)
            {
                SelectAttack(target);
            }
            
            // === PROXIMITY VOID PROJECTILES ===
            if (distance < 350f && Timer % (18 - phase * 4) == 0 && Main.netMode != NetmodeID.MultiplayerClient)
            {
                Vector2 toPlayer = (target.Center - NPC.Center).SafeNormalize(Vector2.Zero);
                for (int i = -1; i <= 1; i++)
                {
                    Vector2 vel = toPlayer.RotatedBy(i * 0.3f) * 9f;
                    BossProjectileHelper.SpawnHostileOrb(NPC.Center, vel, 75, EnigmaPurple, 0.02f);
                }
                CustomParticles.GenericFlare(NPC.Center, EnigmaGreen, 0.4f, 10);
                CustomParticles.Glyph(NPC.Center, EnigmaPurple, 0.4f, -1);
            }
        }
        
        private void SelectAttack(Player target)
        {
            Timer = 0;
            AttackSubPhase = 0;
            State = BossState.Attack;
            
            List<AttackType> pool = new List<AttackType>
            {
                AttackType.VoidLunge,
                AttackType.EyeStorm,
                AttackType.ParadoxBurst
            };
            
            if (phase >= 1)
            {
                pool.Add(AttackType.ShadowAmbush);
                pool.Add(AttackType.TendrilWave);
                pool.Add(AttackType.GlyphTrap);
            }
            
            if (phase >= 2)
            {
                pool.Add(AttackType.RealityTear);
                pool.Add(AttackType.EyeFormation);
            }
            
            pool.Remove(lastAttack);
            CurrentAttack = pool[Main.rand.Next(pool.Count)];
            lastAttack = CurrentAttack;
            
            if (CurrentAttack == AttackType.VoidLunge)
                lungeCount = 0;
        }
        
        private void AI_Attack(Player target)
        {
            switch (CurrentAttack)
            {
                case AttackType.VoidLunge:
                    Attack_VoidLunge(target);
                    break;
                case AttackType.EyeStorm:
                    Attack_EyeStorm(target);
                    break;
                case AttackType.ParadoxBurst:
                    Attack_ParadoxBurst(target);
                    break;
                case AttackType.ShadowAmbush:
                    Attack_ShadowAmbush(target);
                    break;
                case AttackType.TendrilWave:
                    Attack_TendrilWave(target);
                    break;
                case AttackType.GlyphTrap:
                    Attack_GlyphTrap(target);
                    break;
                case AttackType.RealityTear:
                    Attack_RealityTear(target);
                    break;
                case AttackType.EyeFormation:
                    Attack_EyeFormation(target);
                    break;
            }
        }
        
        private void AI_ShadowStep(Player target)
        {
            if (!isInShadow)
            {
                // Fade into shadow
                NPC.alpha = Math.Min(255, NPC.alpha + 15);
                NPC.velocity *= 0.9f;
                
                if (Timer == 1)
                {
                    SoundEngine.PlaySound(SoundID.Item8 with { Pitch = -0.6f }, NPC.Center);
                    CustomParticles.GlyphBurst(NPC.Center, EnigmaPurple, 6, 4f);
                }
                
                // Shadow particles
                if (Timer % 3 == 0)
                {
                    Vector2 pos = NPC.Center + Main.rand.NextVector2Circular(50f, 50f);
                    CustomParticles.GenericFlare(pos, EnigmaVoid, 0.4f, 15);
                }
                
                if (NPC.alpha >= 255)
                {
                    isInShadow = true;
                    
                    // Teleport to aggressive position
                    float angle = Main.rand.NextFloat(MathHelper.TwoPi);
                    Vector2 newPos = target.Center + angle.ToRotationVector2() * (180f + Main.rand.NextFloat(50f));
                    NPC.Center = newPos;
                    Timer = 0;
                }
            }
            else
            {
                // Emerge from shadow
                if (Timer == 1)
                {
                    SoundEngine.PlaySound(SoundID.Item8 with { Pitch = 0.2f, Volume = 1.2f }, NPC.Center);
                    CustomParticles.GenericFlare(NPC.Center, EnigmaGreen, 0.9f, 20);
                    CustomParticles.GlyphBurst(NPC.Center, EnigmaPurple, 8, 5f);
                    
                    for (int i = 0; i < 6; i++)
                    {
                        float eyeAngle = MathHelper.TwoPi * i / 6f;
                        Vector2 eyePos = NPC.Center + eyeAngle.ToRotationVector2() * 60f;
                        CustomParticles.EnigmaEyeGaze(eyePos, EnigmaPurple, 0.5f, target.Center);
                    }
                    
                    // Fire burst at player
                    if (Main.netMode != NetmodeID.MultiplayerClient)
                    {
                        for (int i = 0; i < 10; i++)
                        {
                            float projAngle = MathHelper.TwoPi * i / 10f;
                            Vector2 vel = projAngle.ToRotationVector2() * 8f;
                            BossProjectileHelper.SpawnHostileOrb(NPC.Center, vel, 80, EnigmaPurple, 0.015f);
                        }
                    }
                }
                
                NPC.alpha = Math.Max(0, NPC.alpha - 15);
                
                if (NPC.alpha <= 0)
                {
                    isInShadow = false;
                    Timer = 0;
                    State = BossState.Pursuit;
                    attackCooldown = 30;
                }
            }
        }
        
        private void AI_Frenzy(Player target)
        {
            // Ultra-aggressive low HP behavior
            // For now, treated same as Pursuit but faster
            AI_Pursuit(target);
        }
        
        #endregion
        
        #region Attack Implementations
        
        // =====================================
        // VOID LUNGE - Rapid lunges
        // =====================================
        private void Attack_VoidLunge(Player target)
        {
            int maxLunges = 4 + phase;
            int windupTime = 20 - phase * 4;
            int lungeTime = 12;
            int recoveryTime = 8 - phase;
            
            if (AttackSubPhase == 0) // Windup
            {
                NPC.velocity *= 0.85f;
                
                if (Timer == 1)
                {
                    lungeDirection = (target.Center - NPC.Center).SafeNormalize(Vector2.Zero);
                    SoundEngine.PlaySound(SoundID.NPCHit54 with { Pitch = 0.3f }, NPC.Center);
                }
                
                // Telegraph
                if (Timer > 8)
                {
                    Vector2 endPoint = NPC.Center + lungeDirection * 350f;
                    for (int i = 0; i < 12; i++)
                    {
                        Vector2 linePos = Vector2.Lerp(NPC.Center, endPoint, i / 12f);
                        CustomParticles.GenericFlare(linePos, EnigmaPurple * 0.4f, 0.12f, 2);
                    }
                }
                
                if (Timer >= windupTime)
                {
                    Timer = 0;
                    AttackSubPhase = 1;
                }
            }
            else if (AttackSubPhase == 1) // Lunge
            {
                if (Timer == 1)
                {
                    float lungeSpeed = 28f + phase * 5f;
                    NPC.velocity = lungeDirection * lungeSpeed;
                    SoundEngine.PlaySound(SoundID.DD2_DarkMageHealImpact with { Pitch = 0.4f + lungeCount * 0.1f }, NPC.Center);
                    CustomParticles.GenericFlare(NPC.Center, EnigmaGreen, 0.7f, 12);
                }
                
                // Trail
                if (Timer % 2 == 0)
                {
                    for (int i = 0; i < 3; i++)
                    {
                        Vector2 offset = Main.rand.NextVector2Circular(15f, 15f);
                        Color trailColor = Color.Lerp(EnigmaPurple, EnigmaGreen, Main.rand.NextFloat());
                        CustomParticles.GenericFlare(NPC.Center + offset - NPC.velocity * 0.2f, trailColor, 0.35f, 8);
                    }
                    CustomParticles.Glyph(NPC.Center - NPC.velocity * 0.3f, EnigmaPurple * 0.6f, 0.25f, -1);
                }
                
                // Spawn projectiles during lunge
                if (Timer % 4 == 0 && phase > 0 && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    Vector2 perpendicular = lungeDirection.RotatedBy(MathHelper.PiOver2);
                    BossProjectileHelper.SpawnHostileOrb(NPC.Center + perpendicular * 25f, perpendicular * 2.5f, 70, EnigmaPurple, 0.01f);
                    BossProjectileHelper.SpawnHostileOrb(NPC.Center - perpendicular * 25f, -perpendicular * 2.5f, 70, EnigmaPurple, 0.01f);
                }
                
                if (Timer >= lungeTime)
                {
                    Timer = 0;
                    lungeCount++;
                    AttackSubPhase = lungeCount >= maxLunges ? 3 : 2;
                }
            }
            else if (AttackSubPhase == 2) // Recovery between lunges
            {
                NPC.velocity *= 0.8f;
                
                if (Timer == 2)
                {
                    Vector2 toTarget = (target.Center - NPC.Center).SafeNormalize(Vector2.Zero);
                    float variation = MathHelper.ToRadians(Main.rand.NextFloat(-25f, 25f));
                    lungeDirection = toTarget.RotatedBy(variation);
                }
                
                if (Timer >= recoveryTime)
                {
                    Timer = 0;
                    AttackSubPhase = 0;
                }
            }
            else
            {
                NPC.velocity *= 0.85f;
                if (Timer >= 15)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // EYE STORM - Tracking eyes
        // =====================================
        private void Attack_EyeStorm(Player target)
        {
            int duration = 100 + phase * 30;
            int spawnInterval = 15 - phase * 3;
            
            if (AttackSubPhase == 0)
            {
                NPC.velocity *= 0.92f;
                
                if (Timer % 4 == 0)
                {
                    for (int i = 0; i < 5; i++)
                    {
                        Vector2 pos = NPC.Center + Main.rand.NextVector2CircularEdge(70f, 70f);
                        CustomParticles.EnigmaEyeGaze(pos, EnigmaPurple * 0.6f, 0.4f, target.Center);
                    }
                }
                
                if (Timer >= 30)
                {
                    Timer = 0;
                    AttackSubPhase = 1;
                    SoundEngine.PlaySound(SoundID.NPCDeath52 with { Pitch = 0.2f }, NPC.Center);
                }
            }
            else if (AttackSubPhase == 1)
            {
                // Move toward player while spawning eyes
                Vector2 toTarget = (target.Center - NPC.Center).SafeNormalize(Vector2.Zero);
                NPC.velocity = Vector2.Lerp(NPC.velocity, toTarget * 6f, 0.05f);
                
                if (Timer % spawnInterval == 0 && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    int count = 3 + phase;
                    for (int i = 0; i < count; i++)
                    {
                        float angle = Main.rand.NextFloat(MathHelper.TwoPi);
                        Vector2 spawnPos = NPC.Center + angle.ToRotationVector2() * 80f;
                        Vector2 vel = (target.Center - spawnPos).SafeNormalize(Vector2.Zero) * 5f;
                        BossProjectileHelper.SpawnHostileOrb(spawnPos, vel, 70, EnigmaPurple, 0.035f + phase * 0.01f);
                        
                        CustomParticles.EnigmaEyeGaze(spawnPos, EnigmaPurple, 0.4f, target.Center);
                    }
                    SoundEngine.PlaySound(SoundID.Item8 with { Pitch = Main.rand.NextFloat(0.1f, 0.4f), Volume = 0.6f }, NPC.Center);
                }
                
                if (Timer >= duration)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // PARADOX BURST - Spread of void
        // =====================================
        private void Attack_ParadoxBurst(Player target)
        {
            int burstCount = 3 + phase;
            int burstDelay = 30 - phase * 5;
            
            if (AttackSubPhase < burstCount)
            {
                NPC.velocity *= 0.9f;
                
                if (Timer == 0)
                {
                    SoundEngine.PlaySound(SoundID.Item122 with { Pitch = -0.2f + AttackSubPhase * 0.1f }, NPC.Center);
                }
                
                // Gather energy
                if (Timer < 15)
                {
                    for (int i = 0; i < 4; i++)
                    {
                        Vector2 offset = Main.rand.NextVector2CircularEdge(60f, 60f);
                        Vector2 vel = (NPC.Center - (NPC.Center + offset)).SafeNormalize(Vector2.Zero) * 2f;
                        CustomParticles.GenericFlare(NPC.Center + offset, EnigmaPurple, 0.3f, 10);
                    }
                }
                
                if (Timer == 15 && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    int projCount = 10 + phase * 4;
                    for (int i = 0; i < projCount; i++)
                    {
                        float angle = MathHelper.TwoPi * i / projCount;
                        Vector2 vel = angle.ToRotationVector2() * (9f + phase * 2f + AttackSubPhase);
                        Color color = i % 2 == 0 ? EnigmaPurple : EnigmaGreen;
                        BossProjectileHelper.SpawnWaveProjectile(NPC.Center, vel, 75, color, 3f + phase);
                    }
                    
                    CustomParticles.GenericFlare(NPC.Center, EnigmaGreen, 0.8f, 18);
                    CustomParticles.GlyphBurst(NPC.Center, EnigmaPurple, 6, 5f);
                    for (int r = 0; r < 4; r++)
                        CustomParticles.HaloRing(NPC.Center, EnigmaPurple * (1f - r * 0.2f), 0.3f + r * 0.1f, 12 + r * 2);
                }
                
                if (Timer >= burstDelay)
                {
                    Timer = 0;
                    AttackSubPhase++;
                }
            }
            else
            {
                if (Timer >= 25)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // SHADOW AMBUSH - Teleport behind
        // =====================================
        private void Attack_ShadowAmbush(Player target)
        {
            int ambushCount = 2 + phase;
            
            if (AttackSubPhase / 2 < ambushCount)
            {
                bool isTeleporting = AttackSubPhase % 2 == 0;
                
                if (isTeleporting)
                {
                    // Fade out
                    NPC.alpha = Math.Min(255, NPC.alpha + 12);
                    NPC.velocity *= 0.9f;
                    
                    if (Timer == 1)
                    {
                        SoundEngine.PlaySound(SoundID.Item8 with { Pitch = -0.4f }, NPC.Center);
                        CustomParticles.GlyphBurst(NPC.Center, EnigmaPurple, 5, 4f);
                    }
                    
                    if (NPC.alpha >= 255 || Timer > 20)
                    {
                        // Teleport behind player
                        Vector2 playerDir = target.velocity.Length() > 2f ? target.velocity.SafeNormalize(Vector2.Zero) : Main.rand.NextVector2Unit();
                        Vector2 behindPos = target.Center + playerDir * -150f + Main.rand.NextVector2Circular(30f, 30f);
                        NPC.Center = behindPos;
                        
                        Timer = 0;
                        AttackSubPhase++;
                    }
                }
                else
                {
                    // Emerge and attack
                    if (Timer == 1)
                    {
                        NPC.alpha = 0;
                        SoundEngine.PlaySound(SoundID.DD2_DarkMageHealImpact with { Pitch = 0.3f, Volume = 1.2f }, NPC.Center);
                        CustomParticles.GenericFlare(NPC.Center, EnigmaGreen, 0.9f, 18);
                        
                        for (int i = 0; i < 5; i++)
                        {
                            float angle = MathHelper.TwoPi * i / 5f;
                            Vector2 eyePos = NPC.Center + angle.ToRotationVector2() * 50f;
                            CustomParticles.EnigmaEyeGaze(eyePos, EnigmaPurple, 0.5f, target.Center);
                        }
                        
                        // Lunge toward player
                        lungeDirection = (target.Center - NPC.Center).SafeNormalize(Vector2.Zero);
                        NPC.velocity = lungeDirection * (22f + phase * 4f);
                        
                        // Fire projectiles
                        if (Main.netMode != NetmodeID.MultiplayerClient)
                        {
                            for (int i = 0; i < 6; i++)
                            {
                                float projAngle = lungeDirection.ToRotation() + MathHelper.ToRadians(-30 + i * 12);
                                Vector2 vel = projAngle.ToRotationVector2() * 10f;
                                BossProjectileHelper.SpawnHostileOrb(NPC.Center, vel, 80, EnigmaPurple, 0.02f);
                            }
                        }
                    }
                    
                    // Trail
                    if (Timer % 2 == 0)
                    {
                        CustomParticles.GenericFlare(NPC.Center - NPC.velocity * 0.2f, EnigmaPurple, 0.35f, 8);
                    }
                    
                    NPC.velocity *= 0.92f;
                    
                    if (Timer >= 25)
                    {
                        Timer = 0;
                        AttackSubPhase++;
                    }
                }
            }
            else
            {
                NPC.velocity *= 0.9f;
                if (Timer >= 20)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // TENDRIL WAVE - Ground tendrils
        // =====================================
        private void Attack_TendrilWave(Player target)
        {
            int waveCount = 3 + phase;
            int waveDelay = 35 - phase * 5;
            
            if (AttackSubPhase < waveCount)
            {
                NPC.velocity.X *= 0.9f;
                
                if (Timer == 0)
                {
                    SoundEngine.PlaySound(SoundID.Item122 with { Pitch = -0.3f }, NPC.Center);
                }
                
                // Warning markers on ground
                if (Timer >= 10 && Timer < 25)
                {
                    int markerCount = 6 + phase * 2;
                    float spread = 500f + phase * 100f;
                    for (int i = 0; i < markerCount; i++)
                    {
                        float xOffset = -spread / 2f + spread * i / (markerCount - 1);
                        Vector2 groundPos = new Vector2(target.Center.X + xOffset, target.Center.Y + 200f);
                        CustomParticles.GenericFlare(groundPos, EnigmaGreen * 0.4f, 0.2f, 3);
                    }
                }
                
                if (Timer == 25 && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    // Spawn upward projectiles from ground
                    int tendrilCount = 8 + phase * 3;
                    float spread = 600f + phase * 100f;
                    for (int i = 0; i < tendrilCount; i++)
                    {
                        float xOffset = -spread / 2f + spread * i / (tendrilCount - 1) + Main.rand.NextFloat(-20f, 20f);
                        Vector2 spawnPos = new Vector2(target.Center.X + xOffset, target.Center.Y + 250f);
                        Vector2 vel = new Vector2(Main.rand.NextFloat(-1f, 1f), -12f - phase * 2f);
                        BossProjectileHelper.SpawnAcceleratingBolt(spawnPos, vel, 80, EnigmaPurple, -5f);
                    }
                    
                    MagnumScreenEffects.AddScreenShake(6f);
                }
                
                if (Timer >= waveDelay)
                {
                    Timer = 0;
                    AttackSubPhase++;
                }
            }
            else
            {
                if (Timer >= 25)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // GLYPH TRAP - Area denial
        // =====================================
        private void Attack_GlyphTrap(Player target)
        {
            int trapCount = 4 + phase * 2;
            int trapDelay = 20 - phase * 3;
            
            if (AttackSubPhase < trapCount)
            {
                NPC.velocity *= 0.92f;
                
                if (Timer == 5)
                {
                    Vector2 trapPos = target.Center + Main.rand.NextVector2Circular(150f, 150f);
                    
                    // Warning glyph
                    CustomParticles.GlyphCircle(trapPos, EnigmaPurple * 0.5f, 6, 40f, 0.05f);
                    
                    if (Main.netMode != NetmodeID.MultiplayerClient)
                    {
                        // Delayed detonation trap
                        BossProjectileHelper.SpawnDelayedDetonation(trapPos, 90, EnigmaGreen, 45);
                    }
                    
                    SoundEngine.PlaySound(SoundID.Item8 with { Pitch = 0.4f, Volume = 0.7f }, trapPos);
                }
                
                if (Timer >= trapDelay)
                {
                    Timer = 0;
                    AttackSubPhase++;
                }
            }
            else
            {
                if (Timer >= 80)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // REALITY TEAR - Chaos attack
        // =====================================
        private void Attack_RealityTear(Player target)
        {
            int duration = 150;
            
            if (AttackSubPhase == 0)
            {
                // Windup
                NPC.velocity *= 0.9f;
                
                if (Timer % 3 == 0)
                {
                    for (int i = 0; i < 6; i++)
                    {
                        float angle = MathHelper.TwoPi * i / 6f + Timer * 0.12f;
                        Vector2 pos = NPC.Center + angle.ToRotationVector2() * (60f - Timer * 0.5f);
                        CustomParticles.GenericFlare(pos, Color.Lerp(EnigmaPurple, EnigmaGreen, (float)i / 6f), 0.35f, 10);
                    }
                    CustomParticles.Glyph(NPC.Center + Main.rand.NextVector2Circular(30f, 30f), EnigmaPurple, 0.4f, -1);
                }
                
                if (Timer >= 40)
                {
                    Timer = 0;
                    AttackSubPhase = 1;
                    SoundEngine.PlaySound(SoundID.NPCDeath52 with { Pitch = -0.4f, Volume = 1.4f }, NPC.Center);
                    MagnumScreenEffects.AddScreenShake(12f);
                    
                    CustomParticles.GenericFlare(NPC.Center, EnigmaGreen, 1.2f, 25);
                    CustomParticles.GlyphBurst(NPC.Center, EnigmaPurple, 12, 8f);
                }
            }
            else if (AttackSubPhase == 1)
            {
                // Chaos projectiles from all directions
                int interval = 8 - phase;
                
                if (Timer % interval == 0 && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    // Projectiles from random directions toward player
                    int count = 4 + phase * 2;
                    for (int i = 0; i < count; i++)
                    {
                        float angle = Main.rand.NextFloat(MathHelper.TwoPi);
                        float dist = Main.rand.NextFloat(300f, 500f);
                        Vector2 spawnPos = target.Center + angle.ToRotationVector2() * dist;
                        Vector2 vel = (target.Center - spawnPos).SafeNormalize(Vector2.Zero) * (10f + phase * 2f);
                        
                        Color color = Main.rand.NextBool() ? EnigmaPurple : EnigmaGreen;
                        BossProjectileHelper.SpawnAcceleratingBolt(spawnPos, vel * 0.3f, 75, color, 18f);
                        
                        CustomParticles.EnigmaEyeGaze(spawnPos, EnigmaPurple * 0.6f, 0.4f, target.Center);
                    }
                }
                
                // Also fire from boss
                if (Timer % 15 == 0 && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    int bossCount = 6 + phase * 2;
                    for (int i = 0; i < bossCount; i++)
                    {
                        float angle = MathHelper.TwoPi * i / bossCount + Timer * 0.02f;
                        Vector2 vel = angle.ToRotationVector2() * 7f;
                        BossProjectileHelper.SpawnWaveProjectile(NPC.Center, vel, 70, EnigmaPurple, 4f);
                    }
                }
                
                if (Timer >= duration)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // EYE FORMATION - Patterned eye attack
        // =====================================
        private void Attack_EyeFormation(Player target)
        {
            if (AttackSubPhase == 0)
            {
                // Spawn eye ring
                NPC.velocity *= 0.9f;
                
                if (Timer == 1)
                {
                    SoundEngine.PlaySound(SoundID.NPCDeath52 with { Pitch = 0.3f }, NPC.Center);
                }
                
                if (Timer % 5 == 0 && Timer <= 40)
                {
                    int eyeCount = 8 + phase * 4;
                    for (int i = 0; i < eyeCount; i++)
                    {
                        float angle = MathHelper.TwoPi * i / eyeCount;
                        Vector2 eyePos = target.Center + angle.ToRotationVector2() * 350f;
                        CustomParticles.EnigmaEyeGaze(eyePos, EnigmaPurple, 0.6f, target.Center);
                    }
                }
                
                if (Timer >= 50)
                {
                    Timer = 0;
                    AttackSubPhase = 1;
                    
                    // All eyes fire inward
                    if (Main.netMode != NetmodeID.MultiplayerClient)
                    {
                        int projCount = 12 + phase * 6;
                        for (int i = 0; i < projCount; i++)
                        {
                            float angle = MathHelper.TwoPi * i / projCount;
                            Vector2 spawnPos = target.Center + angle.ToRotationVector2() * 350f;
                            Vector2 vel = (target.Center - spawnPos).SafeNormalize(Vector2.Zero) * (11f + phase * 2f);
                            BossProjectileHelper.SpawnHostileOrb(spawnPos, vel, 80, EnigmaGreen, 0.02f);
                        }
                    }
                    
                    MagnumScreenEffects.AddScreenShake(10f);
                    SoundEngine.PlaySound(SoundID.Item122 with { Pitch = 0.4f, Volume = 1.2f }, target.Center);
                }
            }
            else
            {
                if (Timer >= 60)
                {
                    EndAttack();
                }
            }
        }
        
        private void EndAttack()
        {
            Timer = 0;
            State = BossState.Pursuit;
            attackCooldown = 45 - phase * 10;
        }
        
        #endregion
        
        #region Visual Effects
        
        private void UpdateAnimation()
        {
            frameCounter++;
            int frameSpeed = phase == 2 ? 2 : 3;
            if (frameCounter >= frameSpeed)
            {
                frameCounter = 0;
                currentFrame++;
                if (currentFrame >= TotalFrames)
                    currentFrame = 0;
            }
        }
        
        private void SpawnAmbientParticles()
        {
            // Void particles
            if (Main.rand.NextBool(4 - phase))
            {
                Vector2 pos = NPC.Center + Main.rand.NextVector2Circular(NPC.width * 0.5f, NPC.height * 0.4f);
                Vector2 vel = Main.rand.NextVector2Circular(1f, 1f);
                Color color = Main.rand.NextBool() ? EnigmaPurple : EnigmaGreen;
                CustomParticles.GenericFlare(pos, color * 0.7f, 0.25f, Main.rand.Next(15, 25));
            }
            
            // Occasional glyph
            if (Main.rand.NextBool(12 - phase * 3))
            {
                Vector2 pos = NPC.Center + Main.rand.NextVector2Circular(60f, 60f);
                CustomParticles.Glyph(pos, EnigmaPurple * 0.6f, 0.3f, -1);
            }
            
            // Watching eyes (phase 2+)
            if (phase >= 1 && Main.rand.NextBool(20 - phase * 5))
            {
                Vector2 eyePos = NPC.Center + Main.rand.NextVector2Circular(100f, 100f);
                CustomParticles.EnigmaEyeGaze(eyePos, EnigmaPurple * 0.5f, 0.35f, Main.player[NPC.target].Center);
            }
        }
        
        #endregion
        
        #region Drawing
        
        public override void FindFrame(int frameHeight)
        {
            NPC.frame.Y = currentFrame * frameHeight;
        }
        
        public override bool PreDraw(SpriteBatch spriteBatch, Vector2 screenPos, Color drawColor)
        {
            Texture2D tex = ModContent.Request<Texture2D>(Texture).Value;
            int frameWidth = tex.Width / 6;
            int frameHeight = tex.Height / 6;
            int row = currentFrame / 6;
            int col = currentFrame % 6;
            Rectangle sourceRect = new Rectangle(col * frameWidth, row * frameHeight, frameWidth, frameHeight);
            Vector2 origin = new Vector2(frameWidth / 2f, frameHeight / 2f);
            Vector2 drawPos = NPC.Center - screenPos;
            SpriteEffects effects = NPC.spriteDirection == -1 ? SpriteEffects.FlipHorizontally : SpriteEffects.None;
            
            // Trail effect when moving fast
            if (NPC.velocity.Length() > 8f)
            {
                for (int i = 0; i < NPC.oldPos.Length; i++)
                {
                    float progress = (float)i / NPC.oldPos.Length;
                    Color trailColor = Color.Lerp(EnigmaPurple, EnigmaGreen, progress) * (1f - progress) * 0.4f;
                    Vector2 trailPos = NPC.oldPos[i] + NPC.Size / 2f - screenPos;
                    spriteBatch.Draw(tex, trailPos, sourceRect, trailColor, NPC.rotation, origin, NPC.scale * (1f - progress * 0.15f), effects, 0f);
                }
            }
            
            // Glow underlay
            float pulse = (float)Math.Sin(Timer * 0.08f) * 0.3f + 0.7f;
            Color glowColor = Color.Lerp(EnigmaPurple, EnigmaGreen, pulse);
            glowColor.A = 0;
            spriteBatch.Draw(tex, drawPos, sourceRect, glowColor * 0.3f, NPC.rotation, origin, NPC.scale * 1.1f, effects, 0f);
            
            // Main sprite
            Color mainColor = NPC.IsABestiaryIconDummy ? Color.White : Lighting.GetColor((int)(NPC.Center.X / 16), (int)(NPC.Center.Y / 16));
            mainColor = Color.Lerp(mainColor, Color.White, 0.3f);
            spriteBatch.Draw(tex, drawPos, sourceRect, mainColor * ((255 - NPC.alpha) / 255f), NPC.rotation, origin, NPC.scale, effects, 0f);
            
            return false;
        }
        
        #endregion
        
        #region Loot & Death
        
        public override void ModifyNPCLoot(NPCLoot npcLoot)
        {
            // Treasure bag in expert mode
            npcLoot.Add(ItemDropRule.BossBag(ModContent.ItemType<EnigmaTreasureBag>()));
            
            // Normal mode drops
            LeadingConditionRule notExpert = new LeadingConditionRule(new Conditions.NotExpert());
            
            // Resonance Energy (always drops)
            notExpert.OnSuccess(ItemDropRule.Common(ModContent.ItemType<EnigmaResonantEnergy>(), 1, 15, 25));
            
            // Harmonic Core (always drops)
            notExpert.OnSuccess(ItemDropRule.Common(ModContent.ItemType<HarmonicCoreOfEnigma>(), 1, 1, 1));
            
            // Weapons - first drop guaranteed
            notExpert.OnSuccess(ItemDropRule.OneFromOptions(1,
                ModContent.ItemType<VariationsOfTheVoid>(),
                ModContent.ItemType<TheUnresolvedCadence>(),
                ModContent.ItemType<DissonanceOfSecrets>(),
                ModContent.ItemType<CipherNocturne>(),
                ModContent.ItemType<FugueOfTheUnknown>()));
            
            // Second weapon 50% chance
            notExpert.OnSuccess(ItemDropRule.OneFromOptions(2,
                ModContent.ItemType<TheWatchingRefrain>(),
                ModContent.ItemType<TheSilentMeasure>(),
                ModContent.ItemType<TacetsEnigma>()));
            
            npcLoot.Add(notExpert);
        }
        
        public override bool CheckDead()
        {
            if (deathTimer == 0)
            {
                deathTimer = 1;
                NPC.life = 1;
                NPC.dontTakeDamage = true;
                return false;
            }
            return true;
        }
        
        public override void HitEffect(NPC.HitInfo hit)
        {
            if (NPC.life <= 0 && deathTimer > 0)
            {
                // Death explosion
                MagnumScreenEffects.AddScreenShake(25f);
                SoundEngine.PlaySound(SoundID.NPCDeath52 with { Pitch = -0.5f, Volume = 1.5f }, NPC.Center);
                
                for (int r = 0; r < 10; r++)
                    CustomParticles.HaloRing(NPC.Center, Color.Lerp(EnigmaPurple, EnigmaGreen, r / 10f), 0.3f + r * 0.2f, 22 + r * 4);
                
                for (int i = 0; i < 20; i++)
                {
                    float angle = MathHelper.TwoPi * i / 20f;
                    CustomParticles.GenericFlare(NPC.Center + angle.ToRotationVector2() * 100f, EnigmaPurple, 0.7f, 28);
                }
                
                CustomParticles.GlyphBurst(NPC.Center, EnigmaGreen, 16, 10f);
                
                // Final eyes scatter
                for (int i = 0; i < 12; i++)
                {
                    Vector2 eyePos = NPC.Center + Main.rand.NextVector2Circular(80f, 80f);
                    CustomParticles.EnigmaEyeGaze(eyePos, EnigmaPurple, 0.6f, eyePos + Main.rand.NextVector2Unit() * 100f);
                }
            }
        }
        
        #endregion
    }
}
