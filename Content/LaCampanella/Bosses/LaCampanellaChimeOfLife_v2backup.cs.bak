using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;
using System;
using System.Collections.Generic;
using Terraria;
using Terraria.GameContent.Bestiary;
using Terraria.GameContent.ItemDropRules;
using Terraria.ID;
using Terraria.ModLoader;
using Terraria.Audio;
using MagnumOpus.Content.LaCampanella.ResonanceEnergies;
using MagnumOpus.Content.LaCampanella.ResonantWeapons;
using MagnumOpus.Content.LaCampanella.HarmonicCores;
using MagnumOpus.Common.Systems;
using MagnumOpus.Common.Systems.Particles;
using MagnumOpus.Common.Systems.VFX;

namespace MagnumOpus.Content.LaCampanella.Bosses
{
    /// <summary>
    /// LA CAMPANELLA, CHIME OF LIFE - COMPLETE AGGRESSIVE REBUILD
    /// 
    /// A MASSIVE INFERNAL BELL that POUNDS the arena with devastating attacks.
    /// Inspired by Providence and Calamitas.
    /// 
    /// CORE DESIGN:
    /// - Ground-based boss with MASSIVE area denial
    /// - Shockwaves, fire walls, meteor strikes
    /// - Aggressive pursuit if player tries to run
    /// - Bell chimes create damaging sound waves
    /// 
    /// COMBAT PHILOSOPHY:
    /// - Arena should feel like a FURNACE
    /// - Constant fire raining from above
    /// - Ground is constantly dangerous
    /// - Player must jump and dodge constantly
    /// </summary>
    public class LaCampanellaChimeOfLife : ModNPC
    {
        public override string Texture => "MagnumOpus/Content/LaCampanella/Bosses/LaCampanellaChimeOfLife";
        
        #region Theme Colors
        private static readonly Color CampanellaOrange = new Color(255, 140, 40);
        private static readonly Color CampanellaGold = new Color(255, 200, 80);
        private static readonly Color CampanellaBlack = new Color(30, 20, 25);
        private static readonly Color CampanellaCrimson = new Color(200, 50, 30);
        private static readonly Color CampanellaWhite = new Color(255, 240, 220);
        #endregion
        
        #region AI State
        private enum BossState
        {
            Spawning,
            Pursuit,        // Aggressive movement toward player
            Attack,         // Executing an attack
            Slam,           // Jumping/slamming attack
            Rage            // Enraged special state
        }
        
        private enum AttackType
        {
            // Core Attacks
            BellSlam,           // Jump and slam, shockwave
            InfernoSpiral,      // Fire spiral from bell
            MeteorRain,         // Fire rains from above
            
            // Phase 2 (60% HP)
            FireWall,           // Wall of fire sweeps arena
            ChimeBarrage,       // Multiple ring projectiles
            LavaPool,           // Create damaging floor zones
            
            // Phase 3 (30% HP - Inferno)
            SweepingLaser,      // Rotating fire beam
            TripleSlam,         // Three consecutive slams
            UltimateToll        // Massive arena-wide attack
        }
        
        private BossState State
        {
            get => (BossState)NPC.ai[0];
            set => NPC.ai[0] = (float)value;
        }
        
        private int Timer
        {
            get => (int)NPC.ai[1];
            set => NPC.ai[1] = value;
        }
        
        private AttackType CurrentAttack
        {
            get => (AttackType)NPC.ai[2];
            set => NPC.ai[2] = (float)value;
        }
        
        private int AttackSubPhase
        {
            get => (int)NPC.ai[3];
            set => NPC.ai[3] = value;
        }
        #endregion
        
        #region Combat Variables
        private int phase = 0; // 0=Normal, 1=Fury, 2=Inferno
        private int slamCount = 0;
        private Vector2 slamTarget;
        private float slamVelocity;
        
        // Distance punishment
        private int farAwayTimer = 0;
        
        // Attack tracking
        private int attackCooldown = 0;
        private AttackType lastAttack = AttackType.BellSlam;
        
        // Animation
        private int frameCounter = 0;
        private int currentFrame = 0;
        private const int TotalFrames = 36;
        
        // Health bar
        private bool hasRegisteredHealthBar = false;
        
        // Death
        private int deathTimer = 0;
        
        // Ground tracking
        private bool onGround = false;
        private float groundY = 0f;
        #endregion

        public override void SetStaticDefaults()
        {
            Main.npcFrameCount[Type] = TotalFrames;
            NPCID.Sets.MPAllowedEnemies[Type] = true;
            NPCID.Sets.BossBestiaryPriority.Add(Type);
            NPCID.Sets.TrailCacheLength[Type] = 8;
            NPCID.Sets.TrailingMode[Type] = 1;
            NPCID.Sets.MustAlwaysDraw[Type] = true;
            
            NPCID.Sets.SpecificDebuffImmunity[Type][BuffID.Poisoned] = true;
            NPCID.Sets.SpecificDebuffImmunity[Type][BuffID.Confused] = true;
            NPCID.Sets.SpecificDebuffImmunity[Type][BuffID.OnFire] = true;
            NPCID.Sets.SpecificDebuffImmunity[Type][BuffID.OnFire3] = true;
        }

        public override void SetDefaults()
        {
            NPC.width = 200;
            NPC.height = 300;
            NPC.damage = 120;
            NPC.defense = 70;
            NPC.lifeMax = 380000;
            NPC.HitSound = SoundID.NPCHit4;
            NPC.DeathSound = SoundID.NPCDeath14;
            NPC.knockBackResist = 0f;
            NPC.noGravity = true;
            NPC.noTileCollide = true;
            NPC.value = Item.buyPrice(gold: 18);
            NPC.boss = true;
            NPC.npcSlots = 15f;
            NPC.aiStyle = -1;
            NPC.scale = 1f;
            
            if (!Main.dedServ)
                Music = MusicLoader.GetMusicSlot(Mod, "Assets/Music/TheChimeOfLife");
        }

        public override void SetBestiary(BestiaryDatabase database, BestiaryEntry bestiaryEntry)
        {
            bestiaryEntry.Info.AddRange(new IBestiaryInfoElement[]
            {
                BestiaryDatabaseNPCsPopulator.CommonTags.SpawnConditions.Biomes.TheUnderworld,
                new FlavorTextBestiaryInfoElement("La Campanella, the Chime of Life - an ancient bell of infernal might.")
            });
        }

        public override void AI()
        {
            // Health bar registration
            if (!hasRegisteredHealthBar)
            {
                BossHealthBarUI.RegisterBoss(NPC, BossColorTheme.LaCampanella);
                hasRegisteredHealthBar = true;
            }
            
            NPC.TargetClosest(true);
            Player target = Main.player[NPC.target];
            
            // Despawn check
            if (!target.active || target.dead)
            {
                NPC.velocity.Y -= 0.5f;
                NPC.EncourageDespawn(60);
                return;
            }
            
            // Update phase based on HP
            UpdatePhase();
            
            // Cooldowns
            if (attackCooldown > 0) attackCooldown--;
            
            // Ground detection
            UpdateGroundCheck();
            
            // State machine
            switch (State)
            {
                case BossState.Spawning:
                    AI_Spawning(target);
                    break;
                case BossState.Pursuit:
                    AI_Pursuit(target);
                    break;
                case BossState.Attack:
                    AI_Attack(target);
                    break;
                case BossState.Slam:
                    AI_Slam(target);
                    break;
            }
            
            Timer++;
            UpdateAnimation();
            SpawnAmbientParticles();
            
            // Lighting
            Lighting.AddLight(NPC.Center, CampanellaOrange.ToVector3() * 1.2f);
        }
        
        #region Phase Management
        
        private void UpdatePhase()
        {
            float hp = (float)NPC.life / NPC.lifeMax;
            int newPhase = hp > 0.6f ? 0 : (hp > 0.3f ? 1 : 2);
            
            if (newPhase != phase)
            {
                phase = newPhase;
                AnnouncePhaseChange();
            }
        }
        
        private void AnnouncePhaseChange()
        {
            MagnumScreenEffects.AddScreenShake(phase == 2 ? 25f : 15f);
            SoundEngine.PlaySound(SoundID.DD2_BetsyFireballShot with { Pitch = -0.5f, Volume = 1.5f }, NPC.Center);
            
            // Massive fire burst
            CustomParticles.GenericFlare(NPC.Center, Color.White, 1.5f, 30);
            for (int i = 0; i < 16; i++)
            {
                float angle = MathHelper.TwoPi * i / 16f;
                CustomParticles.GenericFlare(NPC.Center + angle.ToRotationVector2() * 80f, CampanellaOrange, 0.6f, 20);
            }
            
            for (int r = 0; r < 8; r++)
                CustomParticles.HaloRing(NPC.Center, Color.Lerp(CampanellaOrange, CampanellaCrimson, r / 8f), 0.3f + r * 0.2f, 20 + r * 3);
            
            // Spawn heavy smoke
            for (int i = 0; i < 20; i++)
            {
                Vector2 vel = Main.rand.NextVector2Circular(8f, 8f);
                var smoke = new HeavySmokeParticle(NPC.Center + Main.rand.NextVector2Circular(50f, 50f), vel, CampanellaBlack, Main.rand.Next(40, 70), 0.5f, 1.2f, 0.02f, false);
                MagnumParticleHandler.SpawnParticle(smoke);
            }
            
            string text = phase == 2 ? "PRESTO INFERNALE!" : "VIVACE!";
            CombatText.NewText(NPC.Hitbox, phase == 2 ? CampanellaCrimson : CampanellaOrange, text, true);
        }
        
        #endregion
        
        #region Ground Check
        
        private void UpdateGroundCheck()
        {
            // Check for ground below
            Vector2 bottomCenter = NPC.Bottom;
            int tileX = (int)(bottomCenter.X / 16);
            int tileY = (int)(bottomCenter.Y / 16);
            
            onGround = false;
            for (int y = tileY; y < tileY + 5; y++)
            {
                Tile tile = Framing.GetTileSafely(tileX, y);
                if (tile.HasTile && Main.tileSolid[tile.TileType])
                {
                    groundY = y * 16f;
                    onGround = NPC.Bottom.Y >= groundY - 20f;
                    break;
                }
            }
        }
        
        #endregion
        
        #region AI States
        
        private void AI_Spawning(Player target)
        {
            if (Timer == 1)
            {
                SoundEngine.PlaySound(SoundID.DD2_BetsyFireballShot with { Pitch = -0.7f }, NPC.Center);
                CustomParticles.GenericFlare(NPC.Center, CampanellaOrange, 1.0f, 25);
            }
            
            // Fall to ground
            NPC.velocity.Y = MathHelper.Lerp(NPC.velocity.Y, 8f, 0.1f);
            
            if (onGround || Timer > 120)
            {
                NPC.velocity.Y = 0;
                
                // Ground pound effect
                MagnumScreenEffects.AddScreenShake(15f);
                SoundEngine.PlaySound(SoundID.DD2_ExplosiveTrapExplode with { Pitch = -0.5f }, NPC.Center);
                
                for (int i = 0; i < 10; i++)
                    CustomParticles.HaloRing(NPC.Bottom, Color.Lerp(CampanellaOrange, CampanellaGold, i / 10f), 0.2f + i * 0.1f, 15 + i * 2);
                
                Main.NewText("La Campanella tolls...", CampanellaOrange);
                
                Timer = 0;
                State = BossState.Pursuit;
                attackCooldown = 60;
            }
        }
        
        private void AI_Pursuit(Player target)
        {
            // === DISTANCE CHECK ===
            float distance = Vector2.Distance(NPC.Center, target.Center);
            if (distance > 900f)
            {
                farAwayTimer++;
                if (farAwayTimer > 60)
                {
                    // Teleport via slam
                    slamTarget = target.Center;
                    slamCount = 1;
                    State = BossState.Slam;
                    AttackSubPhase = 0;
                    Timer = 0;
                    farAwayTimer = 0;
                    return;
                }
            }
            else
            {
                farAwayTimer = Math.Max(0, farAwayTimer - 2);
            }
            
            // === GROUND MOVEMENT ===
            float moveSpeed = 6f + phase * 2f;
            float targetX = target.Center.X;
            
            if (Math.Abs(NPC.Center.X - targetX) > 100f)
            {
                float dir = Math.Sign(targetX - NPC.Center.X);
                NPC.velocity.X = MathHelper.Lerp(NPC.velocity.X, dir * moveSpeed, 0.08f);
            }
            else
            {
                NPC.velocity.X *= 0.9f;
            }
            
            // Gravity
            if (!onGround)
            {
                NPC.velocity.Y += 0.4f;
                if (NPC.velocity.Y > 15f) NPC.velocity.Y = 15f;
            }
            else
            {
                NPC.velocity.Y = 0;
            }
            
            // === ATTACK SELECTION ===
            int attackDelay = 100 - phase * 25;
            
            if (attackCooldown <= 0 && Timer > attackDelay)
            {
                SelectAttack(target);
            }
            
            // === PROXIMITY FIRE ===
            // Constant fire projectiles when close
            if (distance < 400f && Timer % (20 - phase * 4) == 0 && Main.netMode != NetmodeID.MultiplayerClient)
            {
                int count = 3 + phase * 2;
                for (int i = 0; i < count; i++)
                {
                    float angle = MathHelper.ToRadians(-90 - 45 + i * 90f / (count - 1));
                    Vector2 vel = angle.ToRotationVector2() * 8f;
                    BossProjectileHelper.SpawnHostileOrb(NPC.Top, vel, 70, CampanellaOrange, 0.01f);
                }
                CustomParticles.GenericFlare(NPC.Top, CampanellaGold, 0.5f, 12);
            }
        }
        
        private void SelectAttack(Player target)
        {
            Timer = 0;
            AttackSubPhase = 0;
            
            List<AttackType> pool = new List<AttackType>
            {
                AttackType.BellSlam,
                AttackType.InfernoSpiral,
                AttackType.MeteorRain
            };
            
            if (phase >= 1)
            {
                pool.Add(AttackType.FireWall);
                pool.Add(AttackType.ChimeBarrage);
                pool.Add(AttackType.LavaPool);
            }
            
            if (phase >= 2)
            {
                pool.Add(AttackType.SweepingLaser);
                pool.Add(AttackType.TripleSlam);
            }
            
            pool.Remove(lastAttack);
            CurrentAttack = pool[Main.rand.Next(pool.Count)];
            lastAttack = CurrentAttack;
            
            // Determine state based on attack
            if (CurrentAttack == AttackType.BellSlam || CurrentAttack == AttackType.TripleSlam)
            {
                State = BossState.Slam;
                slamCount = CurrentAttack == AttackType.TripleSlam ? 3 : 1;
            }
            else
            {
                State = BossState.Attack;
            }
        }
        
        private void AI_Attack(Player target)
        {
            switch (CurrentAttack)
            {
                case AttackType.InfernoSpiral:
                    Attack_InfernoSpiral(target);
                    break;
                case AttackType.MeteorRain:
                    Attack_MeteorRain(target);
                    break;
                case AttackType.FireWall:
                    Attack_FireWall(target);
                    break;
                case AttackType.ChimeBarrage:
                    Attack_ChimeBarrage(target);
                    break;
                case AttackType.LavaPool:
                    Attack_LavaPool(target);
                    break;
                case AttackType.SweepingLaser:
                    Attack_SweepingLaser(target);
                    break;
            }
        }
        
        private void AI_Slam(Player target)
        {
            // Slam attack has sub-phases: 0=WindUp, 1=Jump, 2=Descend, 3=Impact, 4=Recovery
            
            if (AttackSubPhase == 0) // Windup
            {
                NPC.velocity.X *= 0.9f;
                
                if (Timer == 1)
                {
                    slamTarget = target.Center;
                    SoundEngine.PlaySound(SoundID.DD2_BetsyFlameBreath with { Pitch = -0.3f }, NPC.Center);
                }
                
                // Gather fire particles
                if (Timer % 3 == 0)
                {
                    for (int i = 0; i < 6; i++)
                    {
                        Vector2 offset = Main.rand.NextVector2CircularEdge(80f, 80f);
                        CustomParticles.GenericFlare(NPC.Center + offset, CampanellaOrange, 0.35f, 10);
                    }
                }
                
                // Shake
                if (Timer > 15)
                    MagnumScreenEffects.AddScreenShake(2f + Timer * 0.1f);
                
                int windupTime = 35 - phase * 8;
                if (Timer >= windupTime)
                {
                    Timer = 0;
                    AttackSubPhase = 1;
                }
            }
            else if (AttackSubPhase == 1) // Jump
            {
                if (Timer == 1)
                {
                    // Calculate jump trajectory to land at target
                    float jumpHeight = 300f + phase * 100f;
                    float horizontalDist = slamTarget.X - NPC.Center.X;
                    float jumpTime = 30f;
                    
                    NPC.velocity.Y = -jumpHeight / jumpTime * 2f;
                    NPC.velocity.X = horizontalDist / jumpTime;
                    
                    SoundEngine.PlaySound(SoundID.Item14 with { Pitch = 0.2f, Volume = 1.2f }, NPC.Center);
                    CustomParticles.GenericFlare(NPC.Bottom, CampanellaGold, 0.8f, 15);
                    CustomParticles.HaloRing(NPC.Bottom, CampanellaOrange, 0.5f, 12);
                }
                
                // Ascent trail
                if (Timer % 2 == 0)
                {
                    Vector2 pos = NPC.Center + Main.rand.NextVector2Circular(30f, 30f);
                    CustomParticles.GenericFlare(pos, CampanellaOrange, 0.4f, 10);
                }
                
                // Transition to descent
                if (NPC.velocity.Y >= 0)
                {
                    Timer = 0;
                    AttackSubPhase = 2;
                }
            }
            else if (AttackSubPhase == 2) // Descend
            {
                NPC.velocity.Y += 0.8f;
                if (NPC.velocity.Y > 25f + phase * 5f)
                    NPC.velocity.Y = 25f + phase * 5f;
                
                // Descent trail
                if (Timer % 2 == 0)
                {
                    Vector2 pos = NPC.Center + Main.rand.NextVector2Circular(40f, 40f);
                    Color trailColor = Color.Lerp(CampanellaOrange, CampanellaCrimson, Main.rand.NextFloat());
                    CustomParticles.GenericFlare(pos, trailColor, 0.5f, 8);
                }
                
                // Impact check
                if (onGround || Timer > 120)
                {
                    Timer = 0;
                    AttackSubPhase = 3;
                }
            }
            else if (AttackSubPhase == 3) // Impact
            {
                NPC.velocity = Vector2.Zero;
                
                if (Timer == 1)
                {
                    MagnumScreenEffects.AddScreenShake(18f + phase * 5f);
                    SoundEngine.PlaySound(SoundID.DD2_ExplosiveTrapExplode with { Pitch = -0.4f, Volume = 1.5f }, NPC.Center);
                    
                    // MASSIVE impact VFX
                    CustomParticles.GenericFlare(NPC.Bottom, Color.White, 1.2f, 25);
                    for (int r = 0; r < 10; r++)
                        CustomParticles.HaloRing(NPC.Bottom, Color.Lerp(CampanellaGold, CampanellaCrimson, r / 10f), 0.3f + r * 0.15f, 18 + r * 3);
                    
                    // Fire burst
                    for (int i = 0; i < 16; i++)
                    {
                        float angle = MathHelper.TwoPi * i / 16f;
                        CustomParticles.GenericFlare(NPC.Bottom + angle.ToRotationVector2() * 100f, CampanellaOrange, 0.6f, 15);
                    }
                    
                    // Heavy smoke
                    for (int i = 0; i < 15; i++)
                    {
                        Vector2 vel = Main.rand.NextVector2Circular(10f, 5f) + new Vector2(0, -2f);
                        var smoke = new HeavySmokeParticle(NPC.Bottom + Main.rand.NextVector2Circular(60f, 20f), vel, CampanellaBlack, Main.rand.Next(35, 55), 0.6f, 1.0f, 0.015f, false);
                        MagnumParticleHandler.SpawnParticle(smoke);
                    }
                    
                    // SHOCKWAVE PROJECTILES
                    if (Main.netMode != NetmodeID.MultiplayerClient)
                    {
                        int projCount = 12 + phase * 4;
                        for (int i = 0; i < projCount; i++)
                        {
                            float angle = MathHelper.Pi + MathHelper.Pi * i / (projCount - 1); // Ground-level spread
                            Vector2 vel = angle.ToRotationVector2() * (10f + phase * 2f);
                            BossProjectileHelper.SpawnHostileOrb(NPC.Bottom, vel, 85, CampanellaCrimson, 0f);
                        }
                        
                        // Upward fire
                        for (int i = 0; i < 8; i++)
                        {
                            float angle = MathHelper.ToRadians(-135 + i * 90f / 7f);
                            Vector2 vel = angle.ToRotationVector2() * 7f;
                            BossProjectileHelper.SpawnAcceleratingBolt(NPC.Top, vel, 75, CampanellaOrange, 15f);
                        }
                    }
                }
                
                // Small recovery
                if (Timer >= 30)
                {
                    slamCount--;
                    if (slamCount > 0)
                    {
                        // More slams to do
                        Timer = 0;
                        AttackSubPhase = 0;
                        slamTarget = Main.player[NPC.target].Center;
                    }
                    else
                    {
                        EndAttack();
                    }
                }
            }
        }
        
        #endregion
        
        #region Attack Implementations
        
        // =====================================
        // INFERNO SPIRAL - Fire spiral from bell
        // =====================================
        private void Attack_InfernoSpiral(Player target)
        {
            int duration = 90 + phase * 30;
            
            if (AttackSubPhase == 0)
            {
                // Windup
                NPC.velocity.X *= 0.9f;
                
                if (Timer % 4 == 0)
                {
                    for (int i = 0; i < 4; i++)
                    {
                        float angle = MathHelper.TwoPi * i / 4f + Timer * 0.1f;
                        Vector2 pos = NPC.Center + angle.ToRotationVector2() * 60f;
                        CustomParticles.GenericFlare(pos, CampanellaOrange, 0.35f, 10);
                    }
                }
                
                if (Timer >= 30)
                {
                    Timer = 0;
                    AttackSubPhase = 1;
                    SoundEngine.PlaySound(SoundID.Item122 with { Pitch = 0.1f }, NPC.Center);
                }
            }
            else if (AttackSubPhase == 1)
            {
                // Fire spiral
                int interval = 5 - phase;
                int arms = 3 + phase;
                
                if (Timer % interval == 0 && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    float spiralAngle = Timer * 0.1f;
                    
                    for (int arm = 0; arm < arms; arm++)
                    {
                        float angle = spiralAngle + MathHelper.TwoPi * arm / arms;
                        Vector2 vel = angle.ToRotationVector2() * (8f + phase * 2f);
                        BossProjectileHelper.SpawnHostileOrb(NPC.Center, vel, 70, CampanellaOrange, 0f);
                    }
                    
                    CustomParticles.GenericFlare(NPC.Center, CampanellaGold, 0.4f, 8);
                }
                
                if (Timer >= duration)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // METEOR RAIN - Fire from above
        // =====================================
        private void Attack_MeteorRain(Player target)
        {
            int duration = 150 + phase * 50;
            
            if (AttackSubPhase == 0)
            {
                // Warning
                if (Timer % 10 == 0)
                {
                    Vector2 warningPos = target.Center + new Vector2(Main.rand.NextFloat(-300f, 300f), -500f);
                    CustomParticles.GenericFlare(warningPos, CampanellaOrange * 0.5f, 0.4f, 20);
                }
                
                if (Timer >= 30)
                {
                    Timer = 0;
                    AttackSubPhase = 1;
                }
            }
            else if (AttackSubPhase == 1)
            {
                // Move toward player
                Vector2 toTarget = (target.Center - NPC.Center);
                if (Math.Abs(toTarget.X) > 200f)
                {
                    NPC.velocity.X = MathHelper.Lerp(NPC.velocity.X, Math.Sign(toTarget.X) * 5f, 0.05f);
                }
                
                // Spawn meteors
                int interval = 12 - phase * 3;
                if (Timer % interval == 0 && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    int count = 2 + phase;
                    for (int i = 0; i < count; i++)
                    {
                        float xOffset = Main.rand.NextFloat(-400f, 400f);
                        Vector2 spawnPos = target.Center + new Vector2(xOffset, -600f);
                        Vector2 vel = new Vector2(Main.rand.NextFloat(-3f, 3f), 12f + phase * 3f);
                        BossProjectileHelper.SpawnAcceleratingBolt(spawnPos, vel * 0.5f, 80, CampanellaCrimson, 25f);
                        
                        CustomParticles.GenericFlare(spawnPos, CampanellaOrange, 0.5f, 10);
                    }
                }
                
                if (Timer >= duration)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // FIRE WALL - Wall sweep
        // =====================================
        private void Attack_FireWall(Player target)
        {
            int wallCount = 2 + phase;
            int wallDelay = 60 - phase * 10;
            
            if (AttackSubPhase < wallCount)
            {
                if (Timer == 0)
                {
                    SoundEngine.PlaySound(SoundID.Item73 with { Pitch = -0.2f + AttackSubPhase * 0.1f }, NPC.Center);
                }
                
                NPC.velocity.X *= 0.9f;
                
                // Warning line
                if (Timer >= 15 && Timer < 35)
                {
                    int side = (AttackSubPhase % 2 == 0) ? -1 : 1;
                    Vector2 wallStart = target.Center + new Vector2(side * 700f, -400f);
                    
                    for (int i = 0; i < 25; i++)
                    {
                        Vector2 warningPos = wallStart + new Vector2(0, i * 35f);
                        CustomParticles.GenericFlare(warningPos, CampanellaOrange * 0.4f, 0.25f, 3);
                    }
                }
                
                if (Timer == 35 && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    int side = (AttackSubPhase % 2 == 0) ? -1 : 1;
                    Vector2 wallStart = target.Center + new Vector2(side * 700f, -400f);
                    Vector2 wallDir = new Vector2(-side, 0);
                    
                    int projCount = 20 + phase * 5;
                    for (int i = 0; i < projCount; i++)
                    {
                        Vector2 spawnPos = wallStart + new Vector2(0, i * 45f);
                        Vector2 vel = wallDir * (14f + phase * 3f);
                        BossProjectileHelper.SpawnHostileOrb(spawnPos, vel, 80, CampanellaCrimson, 0f);
                    }
                    
                    MagnumScreenEffects.AddScreenShake(8f);
                }
                
                if (Timer >= wallDelay)
                {
                    Timer = 0;
                    AttackSubPhase++;
                }
            }
            else
            {
                if (Timer >= 30)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // CHIME BARRAGE - Ring projectiles
        // =====================================
        private void Attack_ChimeBarrage(Player target)
        {
            int chimeCount = 4 + phase * 2;
            int chimeDelay = 25 - phase * 3;
            
            if (AttackSubPhase < chimeCount)
            {
                NPC.velocity.X *= 0.9f;
                
                if (Timer == 10)
                {
                    SoundEngine.PlaySound(SoundID.Item28 with { Pitch = 0.2f + AttackSubPhase * 0.05f }, NPC.Center);
                    
                    // Fire ring
                    if (Main.netMode != NetmodeID.MultiplayerClient)
                    {
                        int ringCount = 8 + phase * 4;
                        for (int i = 0; i < ringCount; i++)
                        {
                            float angle = MathHelper.TwoPi * i / ringCount;
                            Vector2 vel = angle.ToRotationVector2() * (7f + phase * 2f);
                            BossProjectileHelper.SpawnWaveProjectile(NPC.Center, vel, 75, CampanellaGold, 4f);
                        }
                    }
                    
                    // VFX
                    CustomParticles.GenericFlare(NPC.Center, Color.White, 0.7f, 15);
                    for (int r = 0; r < 4; r++)
                        CustomParticles.HaloRing(NPC.Center, CampanellaOrange * (1f - r * 0.2f), 0.3f + r * 0.1f, 12 + r * 2);
                }
                
                if (Timer >= chimeDelay)
                {
                    Timer = 0;
                    AttackSubPhase++;
                }
            }
            else
            {
                if (Timer >= 30)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // LAVA POOL - Area denial
        // =====================================
        private void Attack_LavaPool(Player target)
        {
            int poolCount = 3 + phase;
            int poolDelay = 40 - phase * 8;
            
            if (AttackSubPhase < poolCount)
            {
                NPC.velocity.X *= 0.92f;
                
                if (Timer == 1)
                {
                    // Warning marker
                    CustomParticles.GenericFlare(target.Center, CampanellaOrange * 0.5f, 0.6f, poolDelay);
                }
                
                if (Timer == poolDelay - 5)
                {
                    SoundEngine.PlaySound(SoundID.Item45 with { Pitch = -0.2f }, target.Center);
                }
                
                if (Timer == poolDelay && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    // Create delayed detonation at player position
                    BossProjectileHelper.SpawnDelayedDetonation(target.Center, 100, CampanellaCrimson, 60);
                    
                    MagnumScreenEffects.AddScreenShake(5f);
                    CustomParticles.GenericFlare(target.Center, CampanellaOrange, 0.8f, 20);
                }
                
                if (Timer >= poolDelay + 10)
                {
                    Timer = 0;
                    AttackSubPhase++;
                }
            }
            else
            {
                if (Timer >= 60)
                {
                    EndAttack();
                }
            }
        }
        
        // =====================================
        // SWEEPING LASER - Rotating beam
        // =====================================
        private void Attack_SweepingLaser(Player target)
        {
            int duration = 180;
            
            if (AttackSubPhase == 0)
            {
                // Windup
                NPC.velocity *= 0.9f;
                
                if (Timer % 3 == 0)
                {
                    float angle = Timer * 0.1f;
                    Vector2 pos = NPC.Center + angle.ToRotationVector2() * 50f;
                    CustomParticles.GenericFlare(pos, CampanellaCrimson, 0.4f, 10);
                }
                
                if (Timer >= 45)
                {
                    Timer = 0;
                    AttackSubPhase = 1;
                    SoundEngine.PlaySound(SoundID.Item122 with { Pitch = -0.3f, Volume = 1.3f }, NPC.Center);
                }
            }
            else if (AttackSubPhase == 1)
            {
                // Sweeping fire (simulate laser with rapid projectiles)
                float sweepAngle = MathHelper.ToRadians(-150 + Timer * 2f);
                
                if (Timer % 3 == 0 && Main.netMode != NetmodeID.MultiplayerClient)
                {
                    Vector2 vel = sweepAngle.ToRotationVector2() * 18f;
                    BossProjectileHelper.SpawnHostileOrb(NPC.Center, vel, 85, CampanellaCrimson, 0f);
                    BossProjectileHelper.SpawnHostileOrb(NPC.Center, vel * 0.8f, 75, CampanellaOrange, 0f);
                    
                    // Trail effect
                    CustomParticles.GenericFlare(NPC.Center + vel.SafeNormalize(Vector2.Zero) * 50f, CampanellaGold, 0.3f, 8);
                }
                
                if (Timer >= duration)
                {
                    EndAttack();
                }
            }
        }
        
        private void EndAttack()
        {
            Timer = 0;
            State = BossState.Pursuit;
            attackCooldown = 60 - phase * 15;
        }
        
        #endregion
        
        #region Visual Effects
        
        private void UpdateAnimation()
        {
            frameCounter++;
            if (frameCounter >= 4)
            {
                frameCounter = 0;
                currentFrame++;
                if (currentFrame >= TotalFrames)
                    currentFrame = 0;
            }
        }
        
        private void SpawnAmbientParticles()
        {
            // Fire particles rising
            if (Main.rand.NextBool(3 - phase))
            {
                Vector2 pos = NPC.Center + Main.rand.NextVector2Circular(NPC.width * 0.4f, NPC.height * 0.4f);
                Vector2 vel = new Vector2(Main.rand.NextFloat(-1f, 1f), Main.rand.NextFloat(-3f, -1f));
                Color color = Color.Lerp(CampanellaOrange, CampanellaGold, Main.rand.NextFloat());
                CustomParticles.GenericFlare(pos, color, 0.3f, Main.rand.Next(15, 25));
            }
            
            // Smoke
            if (Main.rand.NextBool(8 - phase * 2))
            {
                Vector2 pos = NPC.Bottom + Main.rand.NextVector2Circular(40f, 10f);
                Vector2 vel = new Vector2(Main.rand.NextFloat(-2f, 2f), Main.rand.NextFloat(-1f, 0f));
                var smoke = new HeavySmokeParticle(pos, vel, CampanellaBlack, Main.rand.Next(30, 50), 0.3f, 0.6f, 0.01f, false);
                MagnumParticleHandler.SpawnParticle(smoke);
            }
        }
        
        #endregion
        
        #region Drawing
        
        public override void FindFrame(int frameHeight)
        {
            NPC.frame.Y = currentFrame * frameHeight;
        }
        
        public override bool PreDraw(SpriteBatch spriteBatch, Vector2 screenPos, Color drawColor)
        {
            Texture2D tex = ModContent.Request<Texture2D>(Texture).Value;
            int frameWidth = tex.Width / 6;
            int frameHeight = tex.Height / 6;
            int row = currentFrame / 6;
            int col = currentFrame % 6;
            Rectangle sourceRect = new Rectangle(col * frameWidth, row * frameHeight, frameWidth, frameHeight);
            Vector2 origin = new Vector2(frameWidth / 2f, frameHeight / 2f);
            Vector2 drawPos = NPC.Center - screenPos;
            
            // Glow underlay
            float pulse = (float)Math.Sin(Timer * 0.08f) * 0.3f + 0.7f;
            Color glowColor = Color.Lerp(CampanellaOrange, CampanellaCrimson, pulse);
            glowColor.A = 0;
            spriteBatch.Draw(tex, drawPos, sourceRect, glowColor * 0.4f, NPC.rotation, origin, NPC.scale * 1.1f, SpriteEffects.None, 0f);
            
            // Main sprite
            Color mainColor = NPC.IsABestiaryIconDummy ? Color.White : Lighting.GetColor((int)(NPC.Center.X / 16), (int)(NPC.Center.Y / 16));
            mainColor = Color.Lerp(mainColor, Color.White, 0.4f);
            spriteBatch.Draw(tex, drawPos, sourceRect, mainColor, NPC.rotation, origin, NPC.scale, SpriteEffects.None, 0f);
            
            return false;
        }
        
        #endregion
        
        #region Loot & Death
        
        public override void ModifyNPCLoot(NPCLoot npcLoot)
        {
            // Treasure bag in expert mode
            npcLoot.Add(ItemDropRule.BossBag(ModContent.ItemType<LaCampanellaTreasureBag>()));
            
            // Normal mode drops
            LeadingConditionRule notExpert = new LeadingConditionRule(new Conditions.NotExpert());
            
            // Energy drops
            notExpert.OnSuccess(ItemDropRule.Common(ModContent.ItemType<LaCampanellaResonantEnergy>(), 1, 25, 35));
            
            // Weapons - guaranteed drops
            notExpert.OnSuccess(ItemDropRule.Common(ModContent.ItemType<IgnitionOfTheBell>(), 3));
            notExpert.OnSuccess(ItemDropRule.Common(ModContent.ItemType<InfernalChimesCalling>(), 3));
            notExpert.OnSuccess(ItemDropRule.Common(ModContent.ItemType<FangOfTheInfiniteBell>(), 3));
            notExpert.OnSuccess(ItemDropRule.Common(ModContent.ItemType<DualFatedChime>(), 3));
            
            // Harmonic Core
            notExpert.OnSuccess(ItemDropRule.Common(ModContent.ItemType<HarmonicCoreOfLaCampanella>(), 1));
            
            npcLoot.Add(notExpert);
        }
        
        public override bool CheckDead()
        {
            if (deathTimer == 0)
            {
                deathTimer = 1;
                NPC.life = 1;
                NPC.dontTakeDamage = true;
                return false;
            }
            return true;
        }
        
        public override void HitEffect(NPC.HitInfo hit)
        {
            if (NPC.life <= 0 && deathTimer > 0)
            {
                // Death explosion
                MagnumScreenEffects.AddScreenShake(30f);
                SoundEngine.PlaySound(SoundID.DD2_ExplosiveTrapExplode with { Pitch = -0.6f, Volume = 2f }, NPC.Center);
                
                for (int r = 0; r < 12; r++)
                    CustomParticles.HaloRing(NPC.Center, Color.Lerp(CampanellaGold, CampanellaCrimson, r / 12f), 0.4f + r * 0.2f, 25 + r * 4);
                
                for (int i = 0; i < 24; i++)
                {
                    float angle = MathHelper.TwoPi * i / 24f;
                    CustomParticles.GenericFlare(NPC.Center + angle.ToRotationVector2() * 120f, CampanellaOrange, 0.8f, 30);
                }
                
                for (int i = 0; i < 30; i++)
                {
                    Vector2 vel = Main.rand.NextVector2Circular(15f, 10f);
                    var smoke = new HeavySmokeParticle(NPC.Center + Main.rand.NextVector2Circular(80f, 80f), vel, CampanellaBlack, Main.rand.Next(50, 80), 0.8f, 1.5f, 0.015f, false);
                    MagnumParticleHandler.SpawnParticle(smoke);
                }
            }
        }
        
        #endregion
    }
}
