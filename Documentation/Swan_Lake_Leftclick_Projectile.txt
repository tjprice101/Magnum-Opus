# Swan Lake Left-Click Projectile (FeathersCallFlare)

## Overview
This documents the signature projectile from Feather's Call's left-click attack.
The FeathersCallFlare is a fractal-style projectile with homing, rainbow effects, and geometric explosion patterns.

## Source Location
File: Content/SwanLake/Items/FeathersCall.cs
Class: FeathersCallFlare (lines ~573-774)

---

## Projectile Configuration

```csharp
public override void SetDefaults()
{
    Projectile.width = 20;
    Projectile.height = 20;
    Projectile.aiStyle = -1;
    Projectile.friendly = true;
    Projectile.DamageType = DamageClass.Magic;
    Projectile.penetrate = 1;
    Projectile.timeLeft = 180;
    Projectile.ignoreWater = true;
    Projectile.tileCollide = true;
    Projectile.light = 0.5f;
}
```

---

## AI Behavior (Homing + Trail)

```csharp
public override void AI()
{
    // Rotate to face velocity
    Projectile.rotation = Projectile.velocity.ToRotation() + MathHelper.PiOver4;

    // Trail particles - white, black, or rainbow based on FlareType
    Color trailColor = FlareType switch
    {
        0 => Color.White,
        1 => Color.Black,
        _ => Main.hslToRgb((Main.GameUpdateCount * 0.02f) % 1f, 1f, 0.7f) // Rainbow cycling
    };

    if (Main.rand.NextBool(2))
    {
        int dustType = FlareType == 1 ? DustID.Smoke : DustID.WhiteTorch;
        Dust d = Dust.NewDustPerfect(Projectile.Center, dustType,
            -Projectile.velocity * 0.2f + Main.rand.NextVector2Circular(1f, 1f),
            FlareType == 1 ? 150 : 0, trailColor, 1.5f);
        d.noGravity = true;
    }

    // HOMING toward target NPC
    if (TargetIndex >= 0 && TargetIndex < Main.maxNPCs)
    {
        NPC target = Main.npc[TargetIndex];
        if (target.active && !target.friendly)
        {
            Vector2 toTarget = (target.Center - Projectile.Center).SafeNormalize(Vector2.Zero);
            Projectile.velocity = Vector2.Lerp(Projectile.velocity, toTarget * 18f, 0.08f);
        }
    }

    // Dynamic lighting - rainbow for type 2
    float lightIntensity = 0.6f;
    if (FlareType == 2)
    {
        Vector3 rainbowLight = Main.hslToRgb((Main.GameUpdateCount * 0.02f) % 1f, 1f, 0.6f).ToVector3();
        Lighting.AddLight(Projectile.Center, rainbowLight * lightIntensity);
    }
    else
    {
        Lighting.AddLight(Projectile.Center, lightIntensity, lightIntensity, lightIntensity);
    }
}
```

---

## SIGNATURE FRACTAL EXPLOSION (OnKill)

This is the key visual effect to copy to other weapons:

```csharp
public override void OnKill(int timeLeft)
{
    Color explosionColor = FlareType switch
    {
        0 => Color.White,
        1 => Color.Black,
        _ => Main.hslToRgb(Main.rand.NextFloat(), 1f, 0.7f)
    };

    // === CORE EXPLOSION ===
    CustomParticles.ExplosionBurst(Projectile.Center, explosionColor, 12, 10f);
    CustomParticles.SwanFeatherBurst(Projectile.Center, 6, 0.4f);
    
    // === SIGNATURE FRACTAL FLARE BURST ===
    // This creates the geometric star pattern that defines the style
    for (int i = 0; i < 6; i++)
    {
        float angle = MathHelper.TwoPi * i / 6f;
        Vector2 flareOffset = new Vector2((float)Math.Cos(angle), (float)Math.Sin(angle)) * 25f;
        float hue = (Main.GameUpdateCount * 0.02f + i * 0.16f) % 1f;
        Color fractalColor = FlareType == 2 ? Main.hslToRgb(hue, 1f, 0.85f) : explosionColor;
        CustomParticles.GenericFlare(Projectile.Center + flareOffset, fractalColor, 0.4f, 18);
    }

    // === RAINBOW SPARKLE RING ===
    for (int i = 0; i < 10; i++)
    {
        float hue = i / 10f;
        Color rainbowColor = Main.hslToRgb(hue, 1f, 0.8f);
        CustomParticles.PrismaticSparkleBurst(Projectile.Center + Main.rand.NextVector2Circular(25f, 25f), rainbowColor, 4);
    }
    
    // === MINI LIGHTNING FRACTALS (Rainbow type only) ===
    if (FlareType == 2 && Main.rand.NextBool(2))
    {
        for (int i = 0; i < 3; i++)
        {
            Vector2 lightningEnd = Projectile.Center + Main.rand.NextVector2Circular(60f, 60f);
            MagnumVFX.DrawSwanLakeLightning(Projectile.Center, lightningEnd, 4, 12f, 1, 0.2f);
        }
    }

    // Sound effect
    SoundEngine.PlaySound(SoundID.Item10 with { Pitch = 0.5f, Volume = 0.5f }, Projectile.Center);
}
```

---

## Custom Rendering (PreDraw)

```csharp
public override bool PreDraw(ref Color lightColor)
{
    SpriteBatch spriteBatch = Main.spriteBatch;
    Vector2 drawPos = Projectile.Center - Main.screenPosition;

    // Colors based on flare type
    Color coreColor = FlareType switch
    {
        0 => Color.White,
        1 => new Color(30, 30, 30),
        _ => Main.hslToRgb((Main.GameUpdateCount * 0.02f) % 1f, 1f, 0.7f)
    };
    Color glowColor = FlareType switch
    {
        0 => new Color(255, 255, 255, 100),
        1 => new Color(80, 80, 80, 100),
        _ => Main.hslToRgb((Main.GameUpdateCount * 0.02f + 0.1f) % 1f, 0.8f, 0.8f) * 0.7f
    };

    // Draw trail afterimages
    for (int i = 0; i < Projectile.oldPos.Length; i++)
    {
        if (Projectile.oldPos[i] == Vector2.Zero) continue;

        Vector2 trailPos = Projectile.oldPos[i] + Projectile.Size / 2f - Main.screenPosition;
        float fade = 1f - (i / (float)Projectile.oldPos.Length);
        float trailScale = (1f - i * 0.06f) * 0.5f;
        Color trailCol = glowColor * fade * 0.5f;

        Texture2D glowTex = TextureAssets.Extra[98].Value; // Glow texture
        spriteBatch.Draw(glowTex, trailPos, null, trailCol, 0f, glowTex.Size() / 2f, trailScale, SpriteEffects.None, 0f);
    }

    // Outer glow
    Texture2D glowTexture = TextureAssets.Extra[98].Value;
    spriteBatch.Draw(glowTexture, drawPos, null, glowColor * 0.6f, 0f, glowTexture.Size() / 2f, 0.8f, SpriteEffects.None, 0f);

    // Inner core
    spriteBatch.Draw(glowTexture, drawPos, null, coreColor, 0f, glowTexture.Size() / 2f, 0.4f, SpriteEffects.None, 0f);

    // Sparkle overlay for rainbow type
    if (FlareType == 2)
    {
        float sparkleRot = Main.GameUpdateCount * 0.1f;
        Color sparkleCol = Main.hslToRgb((Main.GameUpdateCount * 0.03f + 0.5f) % 1f, 1f, 0.9f) * 0.8f;
        spriteBatch.Draw(glowTexture, drawPos, null, sparkleCol, sparkleRot, glowTexture.Size() / 2f, 0.3f, SpriteEffects.None, 0f);
    }

    return false; // Don't draw default sprite
}
```

---

## How to Add This Effect to Other Weapons

### Step 1: Add the fractal burst to weapon impacts

```csharp
// In your weapon's OnHitNPC or projectile's OnKill:
void AddFractalBurstEffect(Vector2 position, Color primaryColor, Color secondaryColor)
{
    // Core explosion
    CustomParticles.ExplosionBurst(position, primaryColor, 12, 10f);
    
    // FRACTAL FLARE BURST - 6-point star pattern
    for (int i = 0; i < 6; i++)
    {
        float angle = MathHelper.TwoPi * i / 6f;
        Vector2 flareOffset = angle.ToRotationVector2() * 25f;
        float gradientProgress = (float)i / 6f;
        Color fractalColor = Color.Lerp(primaryColor, secondaryColor, gradientProgress);
        CustomParticles.GenericFlare(position + flareOffset, fractalColor, 0.4f, 18);
    }
    
    // Rainbow sparkle ring
    for (int i = 0; i < 10; i++)
    {
        float hue = i / 10f;
        Color rainbowColor = Main.hslToRgb(hue, 1f, 0.8f);
        CustomParticles.PrismaticSparkleBurst(position + Main.rand.NextVector2Circular(25f, 25f), rainbowColor, 4);
    }
}
```

### Step 2: Theme-specific variations

For La Campanella (Orange/Gold/Black):
```csharp
AddFractalBurstEffect(position, ThemedParticles.CampanellaOrange, ThemedParticles.CampanellaGold);
```

For Eroica (Scarlet/Gold):
```csharp
AddFractalBurstEffect(position, UnifiedVFX.Eroica.Scarlet, UnifiedVFX.Eroica.Gold);
```

For Moonlight Sonata (Purple/Blue):
```csharp
AddFractalBurstEffect(position, UnifiedVFX.MoonlightSonata.DarkPurple, UnifiedVFX.MoonlightSonata.LightBlue);
```

---

## Key Visual Characteristics

1. **6-point radial star pattern** - The signature geometric look
2. **Gradient colors across the points** - Creates visual depth
3. **Rainbow sparkle overlay** - Prismatic effect for special versions
4. **Homing behavior** - Tracks toward nearest enemy
5. **Mini lightning fractals** - On rainbow variants for extra flash
6. **Trail afterimages** - Creates motion blur effect
7. **Layered glow rendering** - Outer glow + inner core

This effect should be added as a bonus to ALL weapons in MagnumOpus for consistency.
